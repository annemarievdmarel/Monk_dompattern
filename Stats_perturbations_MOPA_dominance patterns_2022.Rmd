---
title: "2020_dominance patterns"
author: "Annemarie van der Marel"
date: '2022-10-18'
output: html_document
 dev: cairo_pdf # could remove if not using ggraph
editor_options: 
  markdown: 
    wrap: 72
---

R code to obtain the dominance hierarchy of 3-day period 
  - social dominance pattern

Basics 
  - Number of total aggressive events observed 
  - Total hours observed

Figure 
  - Daily amount of aggression received/given corrected for hours observed 
  - Time series social dominance patterns 
  - transition diagram observed and random expectation for both perturbations combined and separate for removals and reintroductions

Decisions to make for datasets: - use crowds and displacements combined? low (crowd) vs high (displace) aggresssion - use aggression away from feeder or all aggression? --\> can use all aggression (see framework) - remove duplicates by behavior or combined?

#Session info

```{r}
sessionInfo()

#citation('diagram')

```

#Load packages

```{r, include=FALSE, echo=FALSE}
library(tidyverse)
library(reshape2)
library(stringr)
library(purrr)
library(ggraph)
library(diagram)
library(ggpubr)
library(ggridges)
library(igraph)
library(ggraph)
library(vegan)
library(lubridate)
library(DescTools)
library(samplesizeCMH)
library(domstruc) #install_github("danm0nster/domstruc")
```

# Import raw data

```{r}
 # behave_22 <- read.csv('./data/2022_interactions_all.csv') %>%
 #   dplyr::select(-X)
  
obs.hours <- read.csv('./data/2022_observation_hours.csv')

bin.dates <- read.csv("./data/2022_timeline.csv")

```

# import output data

```{r}
# aggression X dyad X bin X group
dyad.totalaggXbin <- read.csv("./output/dyad.aggXbin2022.csv") %>%
  dplyr::select(-X)

# power score
powerXbin <- read.csv("./output/powerXbin2022.csv")

# aggression summary
agg_summ <- read.csv("./output/summ_agg2022.csv") 

# dominance patterns
dompattern22 <- read.csv("./output/dompatterns2022.csv")
```

# ready data

## Timeline

```{r}

bin_dates <- bin.dates %>%
  dplyr::select(date, perturbation, experiment,focal_bird, bin ) %>%
  filter(bin!="NA")
 # filter(bin<27) only social experiment; bin 27 first 3-days after introduction of stranger

bins <- bin_dates %>%
  group_by(bin) %>%
  slice_head()

bin11birds <- c(1,2,5,6,9,10,13,14,17, 18,21, 22, 25,26)


```

## Bird list

change for each perturbation as different birds are removed

```{r}
# bird list
birdIDs_capture<- read.csv("./data/2022_experimental birds.csv") 

# birdIDs_capture %>%
#   group_by(date) %>%
#   tally() # 21 birds

birdIDs <- birdIDs_capture %>% 
  dplyr::select(experimental_group_2022, band_id_2022, mark_id_2022) %>%
  filter(!mark_id_2022 %in% c("NA", "")) %>%
  rename(group=experimental_group_2022,
         bandID=band_id_2022, 
         markID=mark_id_2022)


# birds used in 2021 
birds21 <-  read.csv("./data/2021_birdIDs.csv") 
birds21 <- birds21 %>%
  filter(mark_id1!="") %>%
  select(band_id) %>%
  rename(bandID=band_id)
# how many non-experimental birds from 2021 used in 2022
nonexp_birds <- birdIDs %>%
  anti_join(birds21v) # 8 birds that were caught in 2021 but not used in 2021 and are used in 2022
total_experimental_birds <- 21 + 22 + 8


##list of all valid color combinations

# change each time
bird.list <- sort(unique(birdIDs$bandID)) # change for social period
length(bird.list)
bird.list

# list of all possible dyads
dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")

```

## Remove duplicates

BY bin

more conservative: removing duplicates using crowds and displacements combined from the beginning, results in less agonistic events but mistakes per behavior (entered crowd while it had to be displacement) are excluded.

```{r remove duplicates conservative method X bin}
#### Remove duplicates for displacements and crowds ####
##more conservative: removing duplicates by crowds and displacements combined
#behave_totalagg<-behave_totalagg_removal
unique(behave_bin$behavior)

# filter displacement & crowd data from all data
aggDC <- behave_bin %>% 
  subset(behavior=="displace" | behavior=="crowd", 
         bin!=4) %>%
  dplyr::select(orderkey,  sessionKEY, period, bin, date, time, actor, subject, behavior)

str(aggDC)
length(aggDC$sessionKEY)

# keep only observations where the actor is in the list of bird IDs
aggDC.goodID <- subset(aggDC, actor %in% bird.list)

# keep only observations where the actor (found above) and the subject are both in the list of bird IDs
aggDC.goodID <- subset(aggDC.goodID, subject %in% bird.list)


## for total agonistic events (crowds and displacements combined)
#finds n CD and crowds by sessionKEY, date, time, actor, subject, behavior
dyad.totalagg.key <- aggDC.goodID %>% 
  dplyr::group_by(sessionKEY, bin, date, time,actor, subject) %>%  # removed , behavior
  tally() # counts behaviors that were observed within the same minute

#finds max agg per actor by date, time, and behavior type. Return just that summary
dyad.totalagg.maxkey <- dyad.totalagg.key %>% 
  group_by(actor, subject,bin,  date, time) %>% # removed behavior, behavior
  slice(which.max(n)) %>% # n.aggXaggXkey if summarise, n if tally
  ungroup()
#head(dyad.totalagg.maxkey)

#finds n disps per actor by date for summarized/trimmed data
dyad.totalaggXbin <- dyad.totalagg.maxkey %>% 
  group_by(actor, subject, bin) %>% # removed behavior to get total aggression
  summarise(n.aggXbin=sum(n)) %>% 
  ungroup()
#head(dyad.totalaggXbin)
sum(dyad.totalaggXbin$n.aggXbin)


#Here we are interested in total number of interactions instead of chronological #order of interactions. If you require order of interactions, then next steps will #be different from the following setup as you will have to add the behaviors with #n>1 as separate rows. 

# save summarized aggression X bin df
write.csv(dyad.totalaggXbin, "./output/dyad.aggXbin2020.csv")

```

## Helper functions & data

```{r echo=FALSE}
# include calibri as text font
windowsFonts(Calibri = windowsFont("Calibri"))
#windowsFonts()


#make matrix function (from dataframe, 1st col with row names)
matrix.please<-function(x) {
  m<-as.matrix(x[,-1])
  rownames(m)<-x[,1]
  m
}



```

# Analyses

## Individual dominance rank X bin



This is the code to identify the top-ranked bird in the bins prior the removal. Have to be done for each group separate

```{r indivdidual rank}
dyad.totalaggXbin <-read.csv("./output/dyad.aggXbin2022.csv")

# check data
sort(unique(dyad.totalaggXbin$actor))
sort(unique(dyad.totalaggXbin$subject))
length(unique(dyad.totalaggXbin$actor))
length(unique(dyad.totalaggXbin$subject))


#### DOMINANCE RANK BY bin####

#head(dyad.totalaggXbin)

# make empty data frame to put data in
ec_rank <- data.frame(run.code=character(),
                      bird.list=character(), 
                      dom_ec=numeric(),
                      rank=numeric())

# run = 1

start.time <- Sys.time()

# select only bins prior removal
rank_assessment_bins <- c(1,2,3)


#i=1

for(i in seq_along(rank_assessment_bins)){
  run.code <- rank_assessment_bins[i]
  print(run.code)
  run.data <- subset(dyad.totalaggXbin, bin==run.code)
  
# number of dyads correct?
  #length(run.data$actor)
  #check <- sum.aggXday %>% filter(date==run.code)
  #head(check)
  
  data_alldyads <- merge(dyad.list, run.data, all.x=TRUE,
                       by=c("actor", "subject")) 
  
  #head(data_alldyads)
  #length(unique(data_alldyads$dyadID)) # with 20 birds: 380 dyads, with 21 birds should be 420 and with 22 462 dyads
  
  data_alldyads$date<-run.code
  
 #fill newly-merged data with 0's where no interactions
 data_alldyads[is.na(data_alldyads)] <- 0
  
   #print a check
  check <- length(data_alldyads$actor)
  print(check)

# matrix  
  mx <- reshape2::dcast(data_alldyads, actor~subject, value.var="n.aggXbin") #head(ref.behavior1.mx)
  mx[is.na(mx)] <- 0 #for linearity measure, matrix needs to be fully filled, no NAs
  mx <- matrix.please(mx)
  
  ## dominance
  dom_ec <- dom_ec(mx)

  rank <- dom_ranks(dom_ec)


  # combine in dataframe
  pool <- cbind.data.frame(run.code, 
                         bird.list,
                         dom_ec,
                         rank)

  ec_rank<-rbind(ec_rank, pool )

}

end.time <- Sys.time()

#Time to run:
end.time - start.time

# check
glimpse(ec_rank)
length(unique(ec_rank$run.code))
check <- ec_rank %>% 
  group_by(run.code) %>% 
  summarize(length(bird.list))

ec_rankXbin <- ec_rank %>%
  rename(bin=run.code, id=bird.list) %>%
  mutate(power=1-dom_ec, 
         rank=22-rank) %>%
  group_by(bin) %>%
  arrange(dom_ec)

focalbirds <- ec_rankXbin %>%
  filter(bin %in% c(3), rank==1)
#focalbirds; BBG and GBB had very similar power scores, so we decided by coin toss which bird to remove (GBB)

```

##Total aggression

```{r sum total aggression}
## Summarize displacements & crowds combined --> total aggression

#head(dyad.totalaggXbin) # crowds and displacement combined from the start, which is more conservative
str(dyad.totalaggXbin)

# check 
unique(dyad.totalaggXbin$actor)
length(unique(dyad.totalaggXbin$actor))
unique(dyad.totalaggXbin$subject)
length(unique(dyad.totalaggXbin$subject))
sort(unique(dyad.totalaggXbin$bin))

sum(dyad.totalaggXbin$n.aggXbin)

# summarize total aggression events per bin
sum.aggDCXbin_2022 <-dyad.totalaggXbin %>%
  group_by(group, bin) %>%
  summarize(n.agg = sum(n.aggXbin), 
            n.dyads=length(actor), 
            n.actors=n_distinct(actor),
            n.subjects=n_distinct(subject))
#head(sum.aggDCXbin_conservative)
sum.aggDCXbin_2022

totalaggXgroup <- sum.aggDCXbin_2022 %>%
  filter(bin<27) %>% # only removal/reintroduction trials
  group_by(group) %>% 
  summarize(totalagg=sum(n.agg))
totalaggXgroup

# check 
sum(dyad.totalaggXbin$n.aggXbin)==sum(sum.aggDCXbin_2022$n.agg)


```

## Fig 3ai) group 1: aggression rate controlled for person hours observed and group size

#### observation hours

```{r}
# change date format to yyyy-mm-dd
obs22 <- obs.hours %>% 
  separate(date, c(  "month","day" ,"year"), sep="/")
obs22$day <- as.numeric(obs22$day)
obs22$day <- str_pad(obs22$day, 2, pad="0")

obs22$month <- as.numeric(obs22$month)
obs22$month <- str_pad(obs22$month, 2, pad="0")

obs22$year <- as.numeric(obs22$year)

obs_hours <- obs22 %>% 
  unite(date, year, month, day, sep = "-") %>%
  arrange(date)

# check time
obs_hours[133,8] <- "16:52" # end time was missing; got it from last interaction from animal observer file
# incorrect entries of time
obs_hours[445,8] <- "15:55" 
obs_hours[99,8] <- "12:16" 
obs_hours[472,8] <- "16:37" 
obs_hours[636,8] <- "16:47" 

```



Total hours is calculated without breaks as observations continued. Calculate for total hours per bin

```{r observation hours X bin X group}

# group 1

obs_hours1 <- obs_hours %>%
  filter(group %in% c("na", 1)| 
         blind %in% c("west_in", "west_out"), 
         date!="2022-01-23")

## lubridate: hm(..., quiet = FALSE, roll = FALSE)
obs_hours1$start <-  lubridate::hm(obs_hours1$start)
obs_hours1$end <-  lubridate::hm(obs_hours1$end)

## total observation hours
hoursobs1 <- obs_hours1 %>%
  left_join(bin_dates %>%
              filter(bin<27), by="date") %>%
  filter(!end %in% c("na", "")) %>%
  mutate(totaltime=lubridate::as.duration(end-start), # calculate total time
         totaltime_min=as.numeric(end - start, units="mins"),
         totaltime_hour=as.numeric(end - start, units="hours")) %>%
  filter(type=="observations", bin!="NA") %>%
  group_by(bin) %>%
  summarize(hours_obs=sum(totaltime_hour)) 

sum(hoursobs1$hours_obs)


sumhoursobs1 <- hoursobs1 %>% 
  summarize(meanhoursobs=mean(hours_obs),
            sdhoursobs=sd(hours_obs),
            n=n(),
            se=sdhoursobs/sqrt(n))




```

Person hours (remove breaks and multiply observation hours by the number of observers)

```{r}
# total hours observed by day
totalobs1 <- obs_hours1 %>%
  left_join(bin_dates %>%
              filter(bin<27), by="date") %>%
  mutate(totaltime=lubridate::as.duration(end-start), # calculate total time
         totaltime_min=as.numeric(end - start, units="mins"),
         totaltime_hour=as.numeric(end - start, units="hours")) %>%
  filter(type=="observations", bin!="NA") %>%
  group_by(bin, date) %>%
  summarize(totaltime=sum(totaltime_hour))


# number of observers each day
observers <-  obs_hours1 %>%
  left_join(bin_dates %>%
              filter(bin<27), by="date") %>%
  mutate(totaltime=lubridate::as.duration(end-start), # calculate total time
         totaltime_min=as.numeric(end - start, units="mins"),
         totaltime_hour=as.numeric(end - start, units="hours")) %>%
  group_by(bin, date) %>% 
  filter(!observer %in% c("NA",""), bin!="NA") %>%
  summarize(observers=n_distinct(observer))

observers$observers[observers$observers==3] <- 2 # we trained field techs

# breaks by day

fieldtechs <- c("DM", "NL")
trainingdates <- c("2022-02-01","2022-02-02", "2022-02-04",
                  "2022-02-05", "2022-02-06", "2022-02-07", "2022-02-08", 
                  "2022-02-09", "2022-02-12",  "2022-02-13","2022-02-14",
                  "2022-02-15", "2022-02-16",  "2022-02-17","2022-02-18",
                  "2022-02-21", "2022-02-22", "2022-02-23")

breaks <- obs_hours1 %>%
   left_join(bin_dates %>%
              filter(bin<27), by="date") %>%
  mutate(totaltime=lubridate::as.duration(end-start), # calculate total time
         totaltime_min=as.numeric(end - start, units="mins"),
         totaltime_hour=as.numeric(end - start, units="hours")) %>%
  filter(type=="break", bin!="NA") %>%

# remove breaks from training days field techs from dataframe
  mutate(exclude = if_else(observer %in% fieldtechs & date %in% trainingdates, "yes", "no")) %>%
  filter(exclude=="no")



# some end times are missing ; fill with average break time
mean(breaks$totaltime_hour, na.rm = T)

breaks$totaltime_hour[is.na(breaks$end)] <- 0.3442029

breaksXday <- breaks %>%
  group_by(bin, date) %>%
  summarize(breaktime=sum(totaltime_hour))


# combine
personhours <- totalobs1 %>%
  left_join(observers, by=c("bin", "date")) 

personhours$observers[is.na(personhours$observers)] <- 2

personhours <- personhours  %>%
  mutate(totalobs=totaltime*observers) %>%
  left_join(breaksXday, by=c("bin", "date")) 


personhours[is.na(personhours)] <- 0

personhours1 <- personhours  %>%
   mutate(personhours=totalobs-breaktime) %>%
  group_by(bin) %>%
  summarize(personhours=sum(personhours)) 


sum(personhours1$personhours)
```

```{r}
## combine
obs.hours1 <- hoursobs1 %>% 
  left_join(personhours1) 
```

458.5 hours and 793.9 person hours across 77 days, with an average of 17.6 ± 3.2 (SD) hours of observation per three-day bin (n = 26 bins)

#### groups size and aggression rate X bin

```{r plot aggression controlled for group size and hours observed}


# total aggression
glimpse(sum.aggDCXbin_2022)

# mean and SD value
summ_ag_group1 <- sum.aggDCXbin_2022 %>% 
  filter(group==1) %>%
  left_join(obs.hours1, by="bin") %>%
  mutate(birds=if_else(bin %in% bin11birds, 11, 10),
         ag_bird= n.agg/birds, 
         ag_bird_obs= n.agg/birds/hours_obs, 
         ag_person_obs = n.agg/birds/personhours, 
         mean = mean(ag_bird_obs),
         sd = sd(ag_bird_obs),
         n=n(),
         se=sd/sqrt(n))

ave.ag.rate <- mean(summ_ag_group1$ag_bird_obs)
sd.ag.rate <- sd(summ_ag_group1$ag_bird_obs)
min(summ_ag_group1$ag_bird_obs)
max(summ_ag_group1$ag_bird_obs)

# ave.ag.rate <- mean(summ_ag_group1$ag_person_obs)
# sd.ag.rate <- sd(summ_ag_group1$ag_person_obs)
# min(summ_ag_group1$ag_person_obs)
# max(summ_ag_group1$ag_person_obs)

```

#### plot aggression rate

```{r}
plot_aggression_22group1 <-  summ_ag_group1 %>%

  ggplot( aes(x = bin)) +
  
 # add average rate of aggression
  geom_hline(yintercept = ave.ag.rate, color = alpha("grey", 0.6), size=2) +
  
  # aggression / bird / hours observed
  geom_line(aes(y=ag_bird_obs), size=1) + 
  geom_point(aes(y=ag_bird_obs), size=3) +
  
  scale_y_continuous(limits=c(0.0, 20.5)) +
  scale_x_continuous(limits = c(1, 26), # change to 4 with removal period included
                     breaks= c(1:26)) +
  
  theme_classic() +
  theme(legend.position="bottom",
         text = element_text(size=14),
         axis.text = element_text(size=12),
         axis.title.x = element_blank()) +
   #     axis.text.x = element_blank(),
    #    axis.ticks.x=element_line()) +
  labs(y="aggression rate") + #, title = "Amount of aggression controlled for group size and hours observed"
  
   # # add lines to highlight removals and reintroductions
  geom_vline(xintercept = 2.5, linetype="dashed", color =  alpha("black", 0.6)) + # removal
  geom_vline(xintercept = 4.5, linetype="solid", color =  alpha("black", 0.6)) + # reintroduction
  geom_vline(xintercept = 6.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 8.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 10.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 12.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 14.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 16.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 18.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 20.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 22.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 24.5, linetype="solid", color =  alpha("black", 0.6))
  
 
 
plot_aggression_22group1 
```

## Fig 3bi) group 2 aggression rate

#### observation hours

```{r}
# change date format to yyyy-mm-dd
obs22 <- obs.hours %>% 
  separate(date, c(  "month","day" ,"year"), sep="/")
obs22$day <- as.numeric(obs22$day)
obs22$day <- str_pad(obs22$day, 2, pad="0")

obs22$month <- as.numeric(obs22$month)
obs22$month <- str_pad(obs22$month, 2, pad="0")

obs22$year <- as.numeric(obs22$year)

obs_hours <- obs22 %>% 
  unite(date, year, month, day, sep = "-") %>%
  arrange(date)

obs_hours[133,8] <- "16:52" # end time was missing; got it from last interaction from animal observer file

# time incorrectly entered
obs_hours[79,8] <- "16:15" 
obs_hours[252,8] <- "13:23" 
obs_hours[305,8] <- "16:21" 
```

```{r observation hours X bin X group}

# group 2

obs_hours2 <- obs_hours %>%
  filter(group %in% c("na", 2)| 
         blind %in% c("east_in", "east_out"))

## lubridate: hm(..., quiet = FALSE, roll = FALSE)
obs_hours2$start <-  lubridate::hm(obs_hours2$start)
obs_hours2$end <-  lubridate::hm(obs_hours2$end)

## total observation hours
hoursobs2 <- obs_hours2 %>%
  left_join(bin_dates %>%
              filter(bin<27), by="date") %>%
  mutate(totaltime=lubridate::as.duration(end-start), # calculate total time
         totaltime_min=as.numeric(end - start, units="mins"),
         totaltime_hour=as.numeric(end - start, units="hours")) %>%
  filter(type=="observations", bin!="NA") %>%
  group_by(bin) %>%
  summarize(hours_obs=sum(totaltime_hour)) 

sum(hoursobs2$hours_obs)


sumhoursobs2 <- hoursobs2 %>% 
  summarize(meanhoursobs=mean(hours_obs),
            sdhoursobs=sd(hours_obs),
            n=n(),
            se=sdhoursobs/sqrt(n))

```

Person hours (remove breaks and multiply observation hours by the number of observers)

```{r}
# total hours observed by day
totalobs2 <- obs_hours2 %>%
  left_join(bin_dates %>%
              filter(bin<27), by="date") %>%
  mutate(totaltime=lubridate::as.duration(end-start), # calculate total time
         totaltime_min=as.numeric(end - start, units="mins"),
         totaltime_hour=as.numeric(end - start, units="hours")) %>%
  filter(type=="observations", bin!="NA") %>%
  group_by(bin, date) %>%
  summarize(totaltime=sum(totaltime_hour))


# number of observers each day
observers <-  obs_hours2 %>%
  left_join(bin_dates %>%
              filter(bin<27), by="date") %>%
  mutate(totaltime=lubridate::as.duration(end-start), # calculate total time
         totaltime_min=as.numeric(end - start, units="mins"),
         totaltime_hour=as.numeric(end - start, units="hours")) %>%
  group_by(bin, date) %>% 
  filter(!observer %in% c("NA",""), bin!="NA") %>%
  summarize(observers=n_distinct(observer)) 

observers$observers[observers$observers==3] <- 2 # we trained field techs
observers$observers[observers$observers==4] <- 2

# breaks by day
breaks <- obs_hours2 %>%
   left_join(bin_dates %>%
              filter(bin<27), by="date") %>%
  mutate(totaltime=lubridate::as.duration(end-start), # calculate total time
         totaltime_min=as.numeric(end - start, units="mins"),
         totaltime_hour=as.numeric(end - start, units="hours")) %>%
  filter(type=="break", bin!="NA") %>%

# remove breaks from training days field techs from dataframe
  mutate(exclude = if_else(observer %in% fieldtechs & date %in% trainingdates, "yes", "no")) %>%
  filter(exclude=="no")

fieldtechs <- c("DM", "NL")
trainingdates <- c("2022-02-01","2022-02-02", "2022-02-04",
                  "2022-02-05", "2022-02-06", "2022-02-07", "2022-02-08", 
                  "2022-02-09", "2022-02-12",  "2022-02-13","2022-02-14",
                  "2022-02-15", "2022-02-16",  "2022-02-17","2022-02-18",
                  "2022-02-21", "2022-02-22", "2022-02-23")

# some end times are missing ; fill with average break time
mean(breaks$totaltime_hour, na.rm = T)

breaks$totaltime_hour[is.na(breaks$end)] <- 0.3535618

breaksXday <- breaks %>%
  group_by(bin, date) %>%
  summarize(breaktime=sum(totaltime_hour))


# combine
personhours <- totalobs1 %>%
  left_join(observers, by=c("bin", "date")) 

personhours$observers[is.na(personhours$observers)] <- 2

personhours <- personhours  %>%
  mutate(totalobs=totaltime*observers) %>%
  left_join(breaksXday, by=c("bin", "date")) 


personhours[is.na(personhours)] <- 0

personhours2 <- personhours  %>%
   mutate(personhours=totalobs-breaktime) %>%
  group_by(bin) %>%
  summarize(personhours=sum(personhours)) 


sum(personhours2$personhours)
```

```{r}
## combine
obs.hours2 <- hoursobs2 %>% 
  left_join(personhours2) 
```

464.4 hours and 771 person hours across 78 days, with an average of 17.9 ± 3.7 (SD) hours of observation per three-day bin (n = 26 bins)

#### groups size and aggression rate X bin

```{r plot aggression controlled for group size and hours observed}


# total aggression
glimpse(sum.aggDCXbin_2022)


# mean total of agonistic events observed per bin
summ_agXbin <- sum.aggDCXbin_2022 %>%
  summarize(mean_ag =mean(n.agg),
            sd_ag = sd(n.agg))

# mean and SD value
summ_ag_group2 <- sum.aggDCXbin_2022 %>% 
  filter(group==2) %>%
  left_join(obs.hours1, by="bin") %>%
  mutate(birds=if_else(bin %in% bin11birds, 11, 10),
         ag_bird= n.agg/birds, 
         ag_bird_obs= n.agg/birds/hours_obs, 
         ag_person_obs = n.agg/birds/personhours, 
         mean = mean(ag_bird_obs),
         sd = sd(ag_bird_obs),
         n=n(),
         se=sd/sqrt(n))

ave.ag.rate <- mean(summ_ag_group2$ag_bird_obs)
sd.ag.rate <- sd(summ_ag_group2$ag_bird_obs)
min(summ_ag_group2$ag_bird_obs)
max(summ_ag_group2$ag_bird_obs)


# ave.ag.rate <- mean(summ_ag_group2$ag_person_obs)
# sd.ag.rate <- sd(summ_ag_group2$ag_person_obs)
# min(summ_ag_group2$ag_person_obs)
# max(summ_ag_group2$ag_person_obs)

```

#### plot aggression rate

```{r}
plot_aggression_22group2 <-  summ_ag_group2 %>%

  ggplot( aes(x = bin)) +
  
 # add average rate of aggression
  geom_hline(yintercept = ave.ag.rate, color = alpha("grey", 0.6), size=2) +
  
  # aggression / bird / hours observed
  geom_line(aes(y=ag_bird_obs), size=1) + 
  geom_point(aes(y=ag_bird_obs), size=3) +
  
  scale_y_continuous(limits=c(0, 20.5)) +
  scale_x_continuous(limits = c(1, 26), # change to 4 with removal period included
                     breaks= c(1:26)) +
  
  theme_classic() +
  theme(legend.position="bottom",
         text = element_text(size=14),
         axis.text = element_text(size=12)) +
         #axis.title.x = element_blank()) +
   #     axis.text.x = element_blank(),
    #    axis.ticks.x=element_line()) +
  labs(y="aggression rate", x="social dominance pattern assessment periods") + #, title = "Amount of aggression controlled for group size and hours observed"
  
   # # add lines to highlight removals and reintroductions
  geom_vline(xintercept = 2.5, linetype="dashed", color =  alpha("black", 0.6)) + # removal
  geom_vline(xintercept = 4.5, linetype="solid", color =  alpha("black", 0.6)) + # reintroduction
  geom_vline(xintercept = 6.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 8.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 10.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 12.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 14.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 16.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 18.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 20.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 22.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 24.5, linetype="solid", color =  alpha("black", 0.6))
  
 
 
plot_aggression_22group2 
```
### combine summ aggression
```{r}

sum_ag22 <- bind_rows(summ_ag_group1, summ_ag_group2) %>% 
  mutate(group= recode(group, '1'="2022-1", '2'="2022-2"))
write.csv(sum_ag22, "output/summ_agg2022.csv")
```



## Social dominance pattern

### Fig 3aii) group 1 dominance patterns

strategies take long to run, so import from file

```{r plot patterns over time}
strategies1 <- dompattern22 %>% 
  filter(group==1) %>%
  dplyr::select(bin, dompattern) %>%
  mutate(observed_pattern = factor(dompattern, 
            levels =c("bullying", "close competitor","downward heuristic"),
            labels =c("Bullying", "Close competitor","Downward heuristic")))


# dominance patterns long perturbation period
plot_strategies_group1<- ggplot(strategies1, 
                               aes(bin, observed_pattern)) +
  geom_point(size = 6, shape = 21, colour = "black", aes(fill = observed_pattern )) +
  labs(title = "", y="", x="social dominance pattern assessment periods") + #title = "social dominance pattern"
  scale_fill_manual(values = c( "#0000FF","#C00000" , "#7F7F7F")) +
  theme_classic() + #theme_minimal() 
  theme(#axis.title = element_text(size=12, angle = 45), #element_blank()
        #axis.text.y =element_text(size=12, angle = 25), 
        legend.position = "none",
        text = element_text(size =14),
        axis.text = element_text(size=12),
        plot.margin = unit(c(1, 1, 0.5, 1), "cm")) +
  
   scale_x_continuous(limits = c(1, 26), # change to 4 with removal period included
                     breaks= c(1:26)) +
  
  
  # # add lines to highlight removals and reintroductions
  geom_vline(xintercept = 2.5, linetype="dashed", color =  alpha("black", 0.6)) + # removal
  geom_vline(xintercept = 4.5, linetype="solid", color =  alpha("black", 0.6)) + # reintroduction
  geom_vline(xintercept = 6.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 8.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 10.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 12.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 14.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 16.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 18.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 20.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 22.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 24.5, linetype="solid", color =  alpha("black", 0.6))
  


plot_strategies_group1

```

### Fig 3bii) group 2 dominance patterns

strategies take long to run, so import from file

```{r plot patterns over time}
strategies2 <- dompattern22 %>% 
  filter(group==2) %>%
  dplyr::select(bin, dompattern) %>%
  mutate(observed_pattern = factor(dompattern, 
            levels =c("bullying", "close competitor","downward heuristic"),
            labels =c("Bullying", "Close competitor","Downward heuristic")))


# dominance patterns long perturbation period
plot_strategies_group2<- ggplot(strategies2, 
                               aes(bin, observed_pattern)) +
  geom_point(size = 6, shape = 21, colour = "black", aes(fill = observed_pattern )) +
  labs(title = "", y="", x="social dominance pattern assessment periods") + #title = "social dominance pattern"
  scale_fill_manual(values = c( "#0000FF","#C00000" , "#7F7F7F")) +
  theme_classic() + #theme_minimal() 
  theme(#axis.title = element_text(size=12, angle = 45), #element_blank()
        #axis.text.y =element_text(size=12, angle = 25), 
        legend.position = "none",
        text = element_text(size =14),
        axis.text = element_text(size=12),
        plot.margin = unit(c(1, 1, 0.5, 1), "cm")) +
  
   scale_x_continuous(limits = c(1, 26), # change to 4 with removal period included
                     breaks= c(1:26)) +
  
  
  # # add lines to highlight removals and reintroductions
  geom_vline(xintercept = 2.5, linetype="dashed", color =  alpha("black", 0.6)) + # removal
  geom_vline(xintercept = 4.5, linetype="solid", color =  alpha("black", 0.6)) + # reintroduction
  geom_vline(xintercept = 6.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 8.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 10.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 12.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 14.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 16.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 18.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 20.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 22.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 24.5, linetype="solid", color =  alpha("black", 0.6))
  


plot_strategies_group2

```

## Plot 2022 data

Figure: aggression rate and dominance patterns for group 1

```{r}

  ggarrange(plot_aggression_22group1 , plot_strategies_group1, 
            nrow=2, ncol=1, align = "hv",
            labels = c("(a)", "(b)")
            ) # legend = "bottom", label.x = 0.15, label.y=0.85

  ggsave("./figures/plot_Fig2022_group1_obshours.pdf", width= 250, height=125, units="mm")
         #width= 7, height=7, units="in") # full page  width= 7, height=11, units="in") # half page width= 125, height=250, units="mm"
```

Figure: aggression rate and dominance patterns for group 2

```{r}

  ggarrange(plot_aggression_22group2 , plot_strategies_group2, 
            nrow=2, ncol=1, align = "hv",
            labels = c("(a)", "(b)")
            ) # legend = "bottom", label.x = 0.15, label.y=0.85

  ggsave("./figures/plot_Fig2022_group2_obshours.pdf", width= 250, height=125, units="mm")
         #width= 7, height=7, units="in") # full page  width= 7, height=11, units="in") # half page width= 125, height=250, units="mm"
```

or both groups in 1 figure

```{r}
  ggarrange(plot_aggression_22group1 , plot_strategies_group1,
            plot_aggression_22group2 , plot_strategies_group2, 
            nrow=4, ncol=1, align = "hv",
            labels = c("(ai)","(aii)", "(bi)","(bii)")
            ) # legend = "bottom", label.x = 0.15, label.y=0.85

  ggsave("./figures/plot_Fig2022_obshours.pdf", width= 250, height=250, units="mm")
```

write aggression summary

```{r}
agg_summ20 <- strategies2020 %>%
  left_join(summ_ag_all) %>%
  rename(n.totalbirds=birds,
         hours.obs=sum, 
         mean_ag_rate=mean,
         sd_ag_rate=sd)
agg_summ20$focus <- round(agg_summ20$focus , digits = 2)
agg_summ20$position <- round(agg_summ20$position , digits = 2)
agg_summ20$hours.obs <- round(agg_summ20$hours.obs , digits = 2)
agg_summ20$ag_bird <- round(agg_summ20$ag_bird , digits = 2)
agg_summ20$ag_bird_obs <- round(agg_summ20$ag_bird_obs , digits = 2)

write.csv(agg_summ20, "output/summ_agg2020.csv")

```

## Pattern transitions

Trial 0 \<- bin==1 \| bin==2 : initial group formation -\> bin 2 = rank assessment point 1 Trial 1 \<- bin==3 \| bin==4 : removal 1 Trial 1 \<- bin==5 \| bin==6 : reintroduction 1 -\> bin 6 = rank assessment point 2 Trial 2 \<- bin==7 \| bin==8 : removal 2 Trial 2 \<- bin==9 \| bin==10: reintroduction 2 -\> bin 10 = rank assessment point 3 Trial 3 \<- bin==11\| bin==12: removal 3 Trial 3 \<- bin==13\| bin==14: reintroduction 3 -\> bin 14 = rank assessment point 4 Trial 4 \<- bin==15\| bin==16: removal 4 Trial 4 \<- bin==17\| bin==18: reintroduction 4 -\> bin 18 = rank assessment point 5 Trial 5 \<- bin==19\| bin==20: removal 5 Trial 5 \<- bin==21\| bin==22: reintroduction 5 -\> bin 22 = rank assessment point 6 Trial 6 \<- bin==23\| bin==24: removal 6 Trial 6 \<- bin==25\| bin==26: reintroduction 6 -\> bin 24 = rank assessment point 7

removal_bins \<- c(2,6,10,14, 18, 22) 
reintro_bins \<- c(4, 8, 12, 16, 20, 24)

-   summarized for both groups
-   top separate (total = 6 trials for both groups) from control (total = 6 trials for both groups)

### Observed pattern shifts

```{r}
dompatterns <- dompattern22 %>% 
  dplyr::select(-X) %>%  
  mutate(focalrank=if_else(dompattern_focal=="middle-ranked", "middle/low", 
                           if_else(dompattern_focal=="bottom-ranked", "middle/low", "top-ranked")),
         obspattern = factor(dompattern, 
            levels =c("bullying", "close competitor","downward heuristic"),
            labels =c("B", "CC","DH")))


# observed pattern change

obs_pattern_change <- dompattern22 %>%
  dplyr::select(group, bin, focalrank, obspattern) %>% #group, 
  group_by(focalrank) %>% #group_by(group) 
  #filter(!bin %in% c(25)) %>%
  mutate(obs_after=lead(obspattern),
         obs_pattern_change = paste(obspattern, obs_after, sep="-")) %>%   rename(before=obspattern,
         after=obs_after, 
         change=obs_pattern_change) 


## perturbations
binperturbations <- c(2,4,6,8,10,12,14,16, 18,20, 22,24)

obs_pattern_change_perturbations <- obs_pattern_change %>%
  filter(bin %in% binperturbations) %>%
  group_by(focalrank, before,after,change) %>% #group_by(group) 
  summarize(obs_n=length(change), obs_prop = obs_n/12) %>% 
  #dplyr::select(-obs_n) %>% 
  mutate(same=if_else(before==after, "yes", "no"))

sum(obs_pattern_change_perturbations$obs_n)
check <- obs_pattern_change_perturbations %>% 
  group_by(focalrank) %>%
  summarise(sum(obs_prop)) # should be 1

## removal
binchange_removal <- c(2,6,10,14, 18, 22)

obs_pattern_change_removal <- obs_pattern_change %>%
  filter(bin %in% binchange_removal) %>%
  group_by(focalrank, before,after,change) %>% #group_by(group) 
  summarize(obs_n=length(change), obs_prop = obs_n/6) %>% 
  #dplyr::select(-obs_n) %>% 
  mutate(perturbation="removal",
         same=if_else(before==after, "yes", "no"))

check <- obs_pattern_change_removal %>% 
  group_by(focalrank) %>%
  summarise(sum(obs_prop)) # should be 1
sum(obs_pattern_change_removal$obs_n)

## reintroduction
binchange_reintro <- c(4, 8, 12, 16, 20, 24)

obs_pattern_change_reintro <- obs_pattern_change %>%
  filter(bin %in% binchange_reintro) %>%
  group_by(focalrank, before,after,change) %>% #group_by(group) 
  summarize(obs_n=length(change), obs_prop = obs_n/6) %>% 
  #dplyr::select(-obs_n) %>% 
  mutate(perturbation="reintroduction",
         same=if_else(before==after, "yes", "no")) 

sum(obs_pattern_change_reintro$obs_n)

check <- obs_pattern_change_reintro %>%
  group_by(focalrank) %>%
  summarise(sum(obs_prop))



```

### Randomise pattern changes

Permute social dominance pattern points

-   Change order of the data points by group

```{r randomise strategies}

# randomise dom patterns -----
# Step 1: create new df
s.pattern <- dompatterns %>%
  dplyr::select(group, bin, obspattern, focalrank) %>%
  filter(!bin %in% c(1,26)) %>%
  rename(observed_pattern=obspattern)


# Step 2: create loop to get 1000 randomised patterns
random_patterns1 <- data.frame(runID =numeric(),
                              group = numeric(),
                              focalrank = character(),
                              bin=numeric(),
                              oberved_pattern=character(),
                              random_pattern=character())


# by group separately
## group1
run.data1 <- subset(s.pattern, group==1)

replicates <- 1000

for(run in 1:replicates){
 r.seed <- run
 set.seed(r.seed)

# create random distribution dominance patterns
   run.data1$runID <- rep(paste0("run",str_pad(r.seed, 4, side="left", pad = "0")))
	
  samplepat <- sample(1:length( run.data1$observed_pattern))
	samplepat
	 run.data1$random_pattern <-  run.data1$observed_pattern[samplepat]

  random_patterns1 <- rbind.data.frame(random_patterns1,  run.data1)
  
}

## group2
random_patterns2 <- data.frame(runID =numeric(),
                              group = numeric(),
                              focalrank = character(),
                              bin=numeric(),
                              oberved_pattern=character(),
                              random_pattern=character())

run.data2 <- subset(s.pattern, group==2)

replicates <- 1000

for(run in 1:replicates){
 r.seed <- run
 set.seed(r.seed)

# create random distribution dominance patterns
   run.data2$runID <- rep(paste0("run",str_pad(r.seed, 4, side="left", pad = "0")))
	
  samplepat <- sample(1:length( run.data2$observed_pattern))
	samplepat
	 run.data2$random_pattern <-  run.data2$observed_pattern[samplepat]

  random_patterns2 <- rbind.data.frame(random_patterns2,  run.data2)
  
}

## combine
random_patterns <- bind_rows(random_patterns1,
                             random_patterns2)


## check ref model output


# check whether per run and per group it adds up to the same number of patterns
check_random1 <- random_patterns1 %>%
  group_by(runID, random_pattern) %>%
  summarize(n=length(random_pattern)) %>% # somehow doubling the totals
  ungroup()

# check whether per run and per group it adds up to the same number of patterns
check_random2 <- random_patterns2 %>%
  group_by(runID, random_pattern) %>%
  summarize(n=length(random_pattern)) %>% # somehow doubling the totals
  ungroup()


# observed patterns per group
dompattern_summ <- dompatterns %>%
  group_by(group, dompattern) %>%
  filter(!bin %in% c(1,26)) %>%
  tally()


  

#check that the randomized interactions vary from the observed patterns
random_patterns$observed_pattern == random_patterns$random_pattern

#check that runs are different from each other
head(subset(random_patterns, runID=="run0001"))
head(subset(random_patterns, runID=="run0002"))
head(subset(random_patterns, runID=="run0003"))
head(subset(random_patterns, runID=="run0011"))
head(subset(random_patterns, runID=="run0100"))

#check that all runs ran as expected
unique(random_patterns$runID)
length(unique(random_patterns$runID))


# Step 3: Calculate how often do we see the same strategies or a change to bullying 

before_after <- random_patterns %>% 
  dplyr::select(runID, group, bin, focalrank, observed_pattern, random_pattern) %>%

  # observed pattern change 
  rename(obs_before = observed_pattern) %>%
  group_by(runID, group) %>%
  mutate(obs_after = lead(obs_before)) %>%
  #drop_na() %>%
  mutate(obs_pattern_change = paste(obs_before, obs_after, sep="-")) %>%

# randomized pattern change
  rename(random_before = random_pattern) %>%
  group_by(runID, group) %>%
  mutate(random_after = lead(random_before)) %>%
  mutate(random_pattern_change = paste(random_before, random_after, sep="-")) %>%
  drop_na() %>%
  
  
  dplyr:: select(group, runID,bin, focalrank,  obs_pattern_change,  random_pattern_change)

#write.csv(before_after, "output/dompattern_random.csv")

glimpse(before_after)

```







## Fig. 4) Transition proportion X focal rank

separate by focal vs control

### top-ranked observed

```{r}
## observed   

binperturbations <- c(2,4,6,8,10,12,14,16, 18,20, 22,24)

obs_top <- obs_pattern_change %>%
  filter(bin %in% binperturbations, focalrank=="top-ranked") %>%
  group_by(focalrank,before, after, change) %>%
  summarize(obs_n=length(change), obs_prop = obs_n/12)  %>%
  mutate(prop=round(obs_prop, 2))

obs_top$before<- factor(obs_top$before, 
                                levels=c( "B" , "CC","DH"))
obs_top$after<- factor(obs_top$after, 
                                levels=c( "B" , "CC","DH"))

# in plotmat rows=to, cols=from
mx <- reshape2::dcast(obs_top, after~before, value.var="prop") 
obs.top.mx <- matrix.please(mx)
obs.top.mx[is.na(obs.top.mx)] <- 0

# set line width
linewidth <- matrix(nrow=3,
                    ncol=3,0)
linewidth[1,1]<- (obs.top.mx[1,1]*10)+1      
linewidth[1,2]<- (obs.top.mx[1,2]*10) 
linewidth[1,3]<- (obs.top.mx[1,3]*10)+1 
linewidth[2,2]<- (obs.top.mx[2,2]*10)+1  
linewidth[2,1]<- (obs.top.mx[2,1]*10)+1
linewidth[2,3]<- (obs.top.mx[2,3]*10)+1  
linewidth[3,1]<- (obs.top.mx[3,1]*10)+1       
linewidth[3,2]<- (obs.top.mx[3,2]*10) 
linewidth[3,3]<- (obs.top.mx[3,3]*10)+1 



# plot transition matrix
pdf("./figures/plot_obs_top.pdf")  # open and save the pdf file
plotmat(obs.top.mx, 
        #pty="s",
        #pos=c(1,1),
        
        # lines
        box.lwd=1, lwd=linewidth, lcol = "#ec0000bf",  #lcol=c( "#0000FF", "#7F7F7F"), 
        
        # boxes
        box.cex=0.8, box.size=0.065 ,box.type="rect", # "circle", "ellipse", "diamond", "rect", "round", "hexa", "multi", "none"
        box.prop=1, box.col = c( "#0000FF","#C00000" , "#7F7F7F"),
        shadow.size = 0.0, 
        my=0, mx=0.0, # vertical and horizontal shift of boxes, respecitvely 
        
        # self 
        relsize=0.7, self.lwd=c(4.3,4.3), #self.lwd = linewidth, 
        self.shiftx=c(.1, -0.1), self.shifty=c(-0.1, 0.1), 
        
        # arrow
        #arr.lwd = c(1, 2,3),
        #arr.length = 2,
        curve = 0.125,
        arr.tcol = "black" , arr.col = "#ec0000bf",
     
        # text
        cex.txt=0.8, txt.col = "white",
        main = "observed transition shifts after perturbation of top-ranked bird"
        )
dev.off() # Close the pdf file



```



### middle/low-ranked observed

```{r}
## observed 
obs_ml <- obs_pattern_change %>%
  filter(bin %in% binperturbations, focalrank=="middle/low") %>%
  group_by(focalrank,before, after, change) %>%
  summarize(obs_n=length(change), obs_prop = obs_n/12)  %>%
  mutate(prop=round(obs_prop, 2))


obs_ml$before <- factor(obs_ml$before, 
                   #levels=c("bullying", "close competitor", "downward heuristic"), 
                                levels=c( "B" , "CC","DH"))

obs_ml$after <- factor(obs_ml$after, 
                  #levels=c("bullying", "close competitor", "downward heuristic"), 
                                levels=c( "B" , "CC","DH"))
# create matrix in plotmat rows=to, cols=from, so after~before
mx <- reshape2::dcast(obs_ml, after~before, value.var="prop") 
obs.ml.mx <- matrix.please(mx)
obs.ml.mx[is.na(obs.ml.mx)] <- 0

# set line width
linewidth <- matrix(nrow=3,
                    ncol=3,0)
linewidth[1,1]<- (obs.ml.mx[1,1]*10)+1      
linewidth[1,2]<- (obs.ml.mx[1,2]*10) 
linewidth[1,3]<- (obs.ml.mx[1,3]*10)+1 
linewidth[2,2]<- (obs.ml.mx[2,2]*10)+1  
linewidth[2,1]<- (obs.ml.mx[2,1]*10)
linewidth[2,3]<- (obs.ml.mx[2,3]*10)+1  
linewidth[3,1]<- (obs.ml.mx[3,1]*10)      
linewidth[3,2]<- (obs.ml.mx[3,2]*10)
linewidth[3,3]<- (obs.ml.mx[3,3]*10)+1 



# plot transition matrix
pdf("./figures/plot_obs_control.pdf")  # open and save the pdf file
plotmat(obs.ml.mx, 
        #pty="s",
        #pos=c(1,1),
        
        # lines
        box.lwd=1, lwd=linewidth, lcol = "#ec0000bf",  #lcol=c( "#0000FF", "#7F7F7F"), 
        
        # boxes
        box.cex=0.8, box.size=0.065 ,box.type="rect", # "circle", "ellipse", "diamond", "rect", "round", "hexa", "multi", "none"
        box.prop=1, box.col = c( "#0000FF","#C00000" , "#7F7F7F"),
        shadow.size = 0.0, 
        my=0, mx=0.0, # vertical and horizontal shift of boxes, respecitvely 
        
        # self 
        relsize=0.7, self.lwd=c(4.3,4.3), #self.lwd = linewidth, 
        self.shiftx=c(.1, -0.1), self.shifty=c(-0.1, 0.1), 
        
        # arrow
        #arr.lwd = c(1, 2,3),
        #arr.length = 2,
        curve = 0.125,
        arr.tcol = "black" , arr.col = "#ec0000bf",
     
        # text
        cex.txt=0.8, txt.col = "white",
        main = " observed transition shifts after perturbation of middle/low-ranked bird"
        )
dev.off() # Close the pdf file



```
#####comparison

```{r}
obs.top.mx
obs.ml.mx


# Is there a correlation between dom pattern matrices for top vs middle/low-ranked birds?
#too few observations for mantel test
ape::mantel.test(obs.top.mx, obs.ml.mx)
vegan::mantel(obs.top.mx, obs.ml.mx)

#Do the number of shifts differ between top and middle/low-ranked focal trials?
#https://rcompanion.org/handbook/H_06.html 
## combine and summarize
obs_change<- bind_rows(obs_pattern_change_removal , obs_pattern_change_reintro) %>%
  group_by(focalrank, same) %>% #perturbation, 
  #filter(same=="no") %>%
  summarize(total=sum(obs_n))

pattern_shifts <- obs_pattern_change_perturbations %>%
  group_by( focalrank, same) %>% #perturbation,
  filter(same=="no") %>%
  summarize(total=sum(obs_n)) 

Table = xtabs(total ~  same + focalrank ,  #+ perturbation
              data=pattern_shifts)

   ###  Note that the grouping variable is last in the xtabs function

ftable(Table)
chisq.test(Table)

fisher.test(Table)

```
The number of dominance pattern shifts are not different when a top-ranked bird or a middle/low-ranked bird is perturbed (chi-square test; X = 1.5, p = 0.22). 





randomization by focalrank separately

####random

averaged separate by focalrank

```{r }

glimpse(before_after)

## ----

# Step 2: create loop to get summary
rand_summ <- data.frame(
                              group = numeric(),
                              focalrank = character(),
                              bin=numeric(),
                              change=character(),
                              random_n=numeric(),
                              prop=numeric())

## filter by rank
loopby <- unique(before_after$focalrank)
#i=1
for(i in seq_along(loopby)){
  run.rank <- loopby[i]
  print(run.rank)
  sub.data <- subset(before_after, focalrank==run.rank)

## filter by group
bygroup <- unique(before_after$group)

for(i in seq_along(bygroup)){
  run.code <- bygroup[i]
  print(run.code)
  group.data <- subset(sub.data, group==run.code)

## filter by bin/trial
 binperturbations <- c(2,4,6,8,10,12,14,16, 18,20, 22,24)

for(i in seq_along(binperturbations)){
  runby <- binperturbations[i]
  print(runby)
  run.data <- subset(group.data, bin==runby)
  
  
  ## summarize
pool<- run.data %>%
  group_by(focalrank, group, bin, random_pattern_change) %>%
  summarise(random_n=length(random_pattern_change), 
            random_prop = random_n/1000) %>%  # each run with 1000 randomized values
  rename(change=random_pattern_change) %>%
  #dplyr::select(-random_n) %>%
  mutate(prop=round(random_prop, 2)
         ) %>%
  dplyr::select(-random_prop)

check<- pool %>%
  summarize(sum=sum(random_n))
print(check$sum) # should be 1000

 rand_summ<-rbind(rand_summ, pool )


}}}

rand <- rand_summ %>%
  group_by(focalrank, change) %>%
  summarize(aveprop=mean(prop),
            sdprop=sd(prop),
            n=sum(random_n),
            se=sdprop/sqrt(n)) %>%
  mutate(prop=round(aveprop, 2),
         sd=round(sdprop, 2))

sum(rand$prop)

```

randomization by focalrank separately

###### top-ranked random

```{r dom pattern randomizations_top}

## random  top-ranked
glimpse(rand)



# filter top-ranked
rand_top <- rand %>%
  filter(focalrank=="top-ranked") 

  
# create matrix
r_top <- rand_top %>% 
  separate(change, into = c("before", "after"), sep="-") 

mx_r_top <- reshape2::dcast(r_top, before~after, value.var="prop") #head(ref.behavior1.mx)
mx_r_top <- matrix.please(mx_r_top)

# set line widtth
curves <- matrix(nrow=ncol(mx_r_top),ncol=ncol(mx_r_top),0)
curves[1,1]<- (mx_r_top[1,1]*10)+1       
curves[1,2]<- (mx_r_top[1,2]*10)+1 
curves[1,3]<- (mx_r_top[1,3]*10)+1  
curves[2,1]<- (mx_r_top[2,1]*10)+1 
curves[2,2]<- (mx_r_top[2,2]*10)+1  
curves[2,3]<- (mx_r_top[2,3]*10)+1 
curves[3,1]<- (mx_r_top[3,1]*10)+1 
curves[3,2]<- (mx_r_top[3,2]*10)+1  
curves[3,3]<- (mx_r_top[3,3]*10)+1 


 
# plot transition diagram  --> colors and location patterns are off. double check props
pdf("./figures/plot_mean_random_top.pdf")  # open and save the pdf file
plotmat(mx_r_top, 
        #pty="s",
        #pos=c(1,1),
        
        # lines
         box.lwd=1, lwd=curves, self.lwd=c(2.3,4.5), lcol = "#56b4e9ff", #self.lwd=curves,  #
        
        # boxes
        box.cex=0.8, box.size=0.065 ,
        box.type="rect", # "circle", "ellipse", "diamond", "rect", "round", "hexa", "multi", "none"
        box.prop=1, box.col = c( "#0000FF","#C00000" , "#7F7F7F"),
        shadow.size = 0.0, 
        my=0, mx=0.0, # vertical and horizontal shift of boxes, respecitvely 
        
        # self 
        relsize=0.7, # rel size to box
        self.shiftx=c(.1, -0.1), self.shifty=c(-0.1, 0.1), 
        
        # arrow
        #arr.lwd = c(1, 2,3),
        #arr.length = 2,
        curve = 0.125, 
        arr.tcol = "black" , arr.col = "#56b4e9ff",
     
        # text
        cex.txt=0.8, txt.col = "white",
        main = "randomised averaged transition probabilities after perturbation of top-ranked focal bird")
dev.off() # Close the pdf file

```

###### control random

```{r dom pattern randomizations_removal}

## random  top-ranked
glimpse(rand)



# filter top-ranked
# rand_removal_control <- rand_removal %>%  
#   filter(focalrank=="middle/low") %>%
#   ungroup() %>%
#    dplyr::select(-focalrank)

rand_ml <- rand %>%
  filter(focalrank=="middle/low") 

  
# create matrix
r_ml <- rand_ml %>% 
  separate(change, into = c("before", "after"), sep="-") 

mx_r_ml <- reshape2::dcast(r_ml, before~after, value.var="prop") #head(ref.behavior1.mx)
mx_r_ml <- matrix.please(mx_r_ml)

# set line widtth
curves <- matrix(nrow=ncol(mx_r_ml),ncol=ncol(mx_r_ml),0)
curves[1,1]<- (mx_r_ml[1,1]*10)+1       
curves[1,2]<- (mx_r_ml[1,2]*10)+1 
curves[1,3]<- (mx_r_ml[1,3]*10)+1  
curves[2,1]<- (mx_r_ml[2,1]*10)+1 
curves[2,2]<- (mx_r_ml[2,2]*10)+1  
curves[2,3]<- (mx_r_ml[2,3]*10)+1 
curves[3,1]<- (mx_r_ml[3,1]*10)+1 
curves[3,2]<- (mx_r_ml[3,2]*10)+1  
curves[3,3]<- (mx_r_ml[3,3]*10)+1 


 
# plot transition diagram  --> colors and location patterns are off. double check props
pdf("./figures/plot_mean_random_ml.pdf")  # open and save the pdf file
plotmat(mx_r_ml, 
        #pty="s",
        #pos=c(1,1),
        
        # lines
         box.lwd=1, lwd=curves, self.lwd=c(2.3,4.5), lcol = "#56b4e9ff", #self.lwd=curves,  #
        
        # boxes
        box.cex=0.8, box.size=0.065 ,
        box.type="rect", # "circle", "ellipse", "diamond", "rect", "round", "hexa", "multi", "none"
        box.prop=1, box.col = c( "#0000FF","#C00000" , "#7F7F7F"),
        shadow.size = 0.0, 
        my=0, mx=0.0, # vertical and horizontal shift of boxes, respecitvely 
        
        # self 
        relsize=0.7, # rel size to box
        self.shiftx=c(.1, -0.1), self.shifty=c(-0.1, 0.1), 
        
        # arrow
        #arr.lwd = c(1, 2,3),
        #arr.length = 2,
        curve = 0.125, 
        arr.tcol = "black" , arr.col = "#56b4e9ff",
     
        # text
        cex.txt=0.8, txt.col = "white",
        main = "randomised averaged transition probabilities after perturbation of middle/low-ranked focal bird")
dev.off() # Close the pdf file
```

#####distribution
```{r}
# per run
randXrun <- before_after %>%
  filter(bin %in% c(2,4,6,8,10,12,14,16, 18,20, 22,24)) %>%
  group_by(runID, random_pattern_change) %>%
  summarise(n_trials=length(random_pattern_change)) %>%  # 3 trials
  rename(change=random_pattern_change) #%>%
  #dplyr::select(-random_n) %>%
  #mutate(prop=round(random_prop, 2)) %>%
  #dplyr::select(-random_prop)

summ_randxrun <- randXrun %>%
  group_by(runID) %>%
  tally() # not all runs have all 9 pattern combinations

pattern_changes <- sort(unique(before_after$obs_pattern_change))
pattern_changes <- as.data.frame(pattern_changes)
pattern_changes <- pattern_changes %>%
  rename(change = "pattern_changes") 

# include all possible patterns

# make empty data frame to put data in
randXrun_all <- data.frame(runID=character(),
                      change=character(), 
                      random_n=numeric(),
                      prop=numeric())

loopby <- unique(randXrun$runID)

for(i in seq_along(loopby)){
  run.code <- loopby[i]
  #print(run.code)
  run.data <- subset(randXrun, runID==run.code)
  
  data_allpatterns <- merge(pattern_changes, run.data, all.x=TRUE,
                       by=c("change")) 

  data_allpatterns$runID<-run.code
  
 #fill newly-merged data with 0's where no patterns
 data_allpatterns[is.na(data_allpatterns)] <- 0
 
 # check
 sum(data_allpatterns$random_n) # should total 3 trials
  
   # combine in dataframe
  randXrun_all<-rbind(randXrun_all, data_allpatterns)
}

glimpse(randXrun_all)
summ_randxrun <- randXrun_all %>%
  group_by(runID) %>%
  tally() # now all runs have all 9 pattern combinations

# calculate proportion 
randXrun_all<- randXrun_all %>%
  mutate(random_prop = n_trials/24)  # raw data of the 6 trials with 12 perturbations  for 2 groups of the averaged summary  (the following provides different info; length(pattern_changes$change) -> moved to supplemental)

sum(obs_pattern_change_perturbations$obs_n)

glimpse(randXrun_all)


# summarize
summ_rand<- randXrun_all %>%
  group_by(change, random_prop) %>%
  summarise(total=length(runID), 
            p.value=total/1000)

# How many runs do we see same pattern as observed? 
obs.vs.rand <- before_after %>%
  filter(bin %in% c(2,4,6,8,10,12,14,16, 18,20, 22,24)) %>%
  group_by(runID) %>%
  mutate(similar_pattern= if_else(obs_pattern_change==random_pattern_change,"yes", "no")) %>%
  group_by(runID,similar_pattern) %>%
  summarize(n=length(similar_pattern))
  
summ_obs.vs.rand  <- obs.vs.rand %>%
  filter(similar_pattern=="yes", n==24) 
total_runs_same_removal <- length(summ_obs.vs.rand$runID)/length(unique(before_after$runID))*100


# figure
glimpse(rand_removalXrun_all)
glimpse(summ_rand_removal)

randXrun_all <- rand_removalXrun_all %>%
  mutate(pattern_change = factor(change, levels=c("downward heuristic-downward heuristic",
                                                  "downward heuristic-close competitor",
                                                  "downward heuristic-bullying",
                                                  "close competitor-downward heuristic",
                                                  "close competitor-close competitor",
                                                  "close competitor-bullying",
                                                  "bullying-downward heuristic",
                                                  "bullying-close competitor",
                                                  "bullying-bullying"),
                                 labels = c("DH-DH", "DH-CC", "DH-B",
                                            "CC-DH", "CC-CC", "CC-B",
                                            "B-DH", "B-CC", "B-B")))
#summ_rand_removalXrun_all <- rand_removalXrun_all %>%
#  group_by(change, random_prop) %>%
#  summarize(n=length(runID),
#            prop=n/1000)


 plot_dist <-  ggplot(randXrun_all, aes(x = random_prop, y = change, fill = change)) +
  geom_density_ridges( stat="binline",bins=8.5, scale=0.8, draw_baseline = F, center = 0) + #alpha=0.6, binwidth=1
  theme_ridges(#font_size = 12,
    #font_family = "",
   line_size = 0.01,
   # grid = FALSE,
    center_axis_labels = FALSE) + #grid=FALSE
  theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8),
      axis.title.x = element_text(hjust = 0.5)
      #axis.title.y = element_text(hjust = 0.5)
    ) +
    xlab("proportion of runs") +
    ylab("") +
    #scale_fill_manual(values = c("#0000FF", "#b3b0e3", "#deebf7", "#7F7F7F")) + #"#C00000" ,
   scale_x_continuous( expand = c(0, 0),limits = c(-0.1,1.2),
                       breaks = c(0.00, 0.33, 0.66, 1.00)) +
   scale_y_discrete(expand = expansion(mult = c(0.0, .3))) +
   
  # include observed proportion top-ranked (color orange)
  geom_segment(y=9, yend=9.8, x = 0.17, xend=0.17, size=1,  color="orange") + # trial 1
  geom_segment(y=7, yend=7.8, x = 0.08, xend=0.08, size=1,  color="orange") + # trial 2 #linetype = "dashed",
   geom_segment(y=6, yend=6.8, x = 0.25, xend=0.25, size=1,  color="orange") + # trial 2 #linetype = "dashed",
   geom_segment(y=5, yend=5.8, x = 0.08, xend=0.08, size=1,  color="orange") + #linetype = "dashed",
  geom_segment(y=4, yend=4.8, x = 0.08, xend=0.08, size=1,  color="orange") +  
  geom_segment(y=3, yend=3.8, x = 0.25, xend=0.25, size=1,  color="orange") +
   geom_segment(y=1, yend=1.8, x = 0.08, xend=0.08, size=1,  color="orange") +
   
   
    # include observed proportion middle/low-ranked (color grey20)
  geom_segment(y=9, yend=9.8, x = 0.17, xend=0.17, size=1,  color="lightgrey") + # trial 1
  geom_segment(y=7, yend=7.8, x = 0.17, xend=0.17, size=1,  color="lightgrey") + # trial 2 #linetype = "dashed",
  geom_segment(y=4, yend=4.8, x = 0.33, xend=0.33, size=1,  color="lightgrey") +  # trial 3
  geom_segment(y=6, yend=6.8, x = 0.17, xend=0.17, size=1,  color="lightgrey") + # trial 2 #linetype = "dashed",
  geom_segment(y=3, yend=3.8, x = 0.17, xend=0.17, size=1,  color="lightgrey") +
   
  #geom_segment(y=1, yend=5, x = 1, xend=1, size=1,  color="white") +
   coord_cartesian(clip = "off") 
plot_dist 


ggsave("figures/plot_dist_2022.pdf") #, width = 2.5, height = 3


total_rand_removal <- summ_rand_removal %>%
  group_by(change) %>%
  summarize(sum=sum(total))

plot_removal_bar <- ggplot(summ_rand_removal, aes(x=change, y=p.value, fill=as.factor(random_prop))) +
  geom_bar(stat = "identity" , position="dodge") +
  coord_flip() +
  ylab("proportion of runs") +
  xlab("") +
  scale_fill_viridis(discrete=TRUE, name="") +
  theme_classic()
plot_removal_bar

```


## Transition proportion by trial X focalrank X perturbation type

separate by focal vs control

Supplemental Info 3

#### removal

##### observed

###### top-ranked observed

```{r}
## observed   {update}
obs_top_removal <- obs_pattern_change %>%
  filter(bin %in% binchange_removal, focalrank=="top-ranked") %>%
  group_by(focalrank,before, after, change) %>%
  summarize(obs_n=length(change), obs_prop = obs_n/6)  %>%
  mutate(prop=round(obs_prop, 2))

obs_top_removal$before<- factor(obs_top_removal$before, 
                                levels=c( "B" , "CC","DH"))
obs_top_removal$after<- factor(obs_top_removal$after, 
                                levels=c( "B" , "CC","DH"))


mx <- reshape2::dcast(obs_top_removal, after~before, value.var="prop") 
obs.removal.mx <- matrix.please(mx)
obs.removal.mx[is.na(obs.removal.mx)] <- 0

# set line width
linewidth <- matrix(nrow=3,
                    ncol=2,0)
linewidth[1,1]<- 0      
linewidth[1,2]<- (obs.removal.mx[1,2]*10)+1 
#linewidth[1,3]<- (obs.removal.mx[1,3]*10)+1 
linewidth[2,2]<- (obs.removal.mx[2,2]*10)+1  
linewidth[2,1]<- (obs.removal.mx[2,1]*10)+1
#linewidth[2,3]<- (obs.removal.mx[2,3]*10)+1  
linewidth[3,1]<- (obs.removal.mx[3,1]*10)+1       
linewidth[3,2]<- (obs.removal.mx[3,2]*10)+1 
#linewidth[3,3]<- (obs.removal.mx[3,3]*10)+1 



# plot transition matrix
pdf("./figures/plot_obs_removal_top.pdf")  # open and save the pdf file
plotmat(obs.removal.mx, 
        #pty="s",
        #pos=c(1,1),
        
        # lines
        box.lwd=1, lwd=linewidth, lcol = "#ff6600ff" ,  # "#ec0000bf" (red) lcol=c( "#0000FF", "#7F7F7F"), 
        
        # boxes
        box.cex=0.8, box.size=0.065 ,box.type="rect", # "circle", "ellipse", "diamond", "rect", "round", "hexa", "multi", "none"
        box.prop=1, box.col = c( "#0000FF","#C00000" , "#7F7F7F"),
        shadow.size = 0.0, 
        my=0, mx=0.0, # vertical and horizontal shift of boxes, respecitvely 
        
        # self 
        relsize=0.7, self.lwd=c(4.3,4.3), #self.lwd = linewidth, 
        self.shiftx=c(.1, -0.1), self.shifty=c(-0.1, 0.1), 
        
        # arrow
        #arr.lwd = c(1, 2,3),
        #arr.length = 2,
        curve = 0.125,
        arr.tcol = "black" , arr.col = "#ff6600ff" ,
     
        # text
        cex.txt=0.8, txt.col = "white",
        main = "observed transition shifts after removal of top-ranked bird"
        )
dev.off() # Close the pdf file



```

NB! arrows are going in the wrong direction when compared to the matrix and boxes do not correpsond to the right patterns

###### control observed

```{r}
## observed 
obs_ml_removal <- obs_pattern_change %>%
  filter(bin %in% binchange_removal, focalrank=="middle/low") %>%
  group_by(focalrank,before, after, change) %>%
  summarize(obs_n=length(change), obs_prop = obs_n/6)  %>%
  mutate(prop=round(obs_prop, 2))

obs_ml_removal$before <- factor(obs_ml_removal$before, 
                   #levels=c("bullying", "close competitor", "downward heuristic"), 
                                levels=c( "B" , "CC","DH"))

obs_ml_removal$after <- factor(obs_ml_removal$after, 
                  #levels=c("bullying", "close competitor", "downward heuristic"), 
                                levels=c( "B" , "CC","DH"))
# create matrix
mx <- reshape2::dcast(obs_ml_removal, after~before, value.var="prop") 
obs.removal.mx <- matrix.please(mx)
obs.removal.mx[is.na(obs.removal.mx)] <- 0

# set line width
linewidth <- matrix(nrow=3,
                    ncol=3,0)
linewidth[1,1]<- (obs.removal.mx[1,1]*10)+1      
linewidth[1,2]<- (obs.removal.mx[1,2]*10)+1 
linewidth[1,3]<- (obs.removal.mx[1,3]*10)+1 
linewidth[2,2]<- (obs.removal.mx[2,2]*10)+1  
linewidth[2,1]<- (obs.removal.mx[2,1]*10)+1
linewidth[2,3]<- (obs.removal.mx[2,3]*10)+1  
linewidth[3,1]<- (obs.removal.mx[3,1]*10)+1       
linewidth[3,2]<- (obs.removal.mx[3,2]*10)+1 
linewidth[3,3]<- (obs.removal.mx[3,3]*10)+1 



# plot transition matrix
pdf("./figures/plot_obs_removal_control.pdf")  # open and save the pdf file
plotmat(obs.removal.mx, 
        #pty="s",
        #pos=c(1,1),
        
        # lines
        box.lwd=1, lwd=linewidth, lcol = "#ccccccff",  #lcol=c( "#0000FF", "#7F7F7F"), 
        
        # boxes
        box.cex=0.8, box.size=0.065 ,box.type="rect", # "circle", "ellipse", "diamond", "rect", "round", "hexa", "multi", "none"
        box.prop=1, box.col = c( "#0000FF","#C00000" , "#7F7F7F"),
        shadow.size = 0.0, 
        my=0, mx=0.0, # vertical and horizontal shift of boxes, respecitvely 
        
        # self 
        relsize=0.7, self.lwd=c(4.3,4.3), #self.lwd = linewidth, 
        self.shiftx=c(.1, -0.1), self.shifty=c(-0.1, 0.1), 
        
        # arrow
        #arr.lwd = c(1, 2,3),
        #arr.length = 2,
        curve = 0.125,
        arr.tcol = "black" , arr.col = "#ccccccff",
     
        # text
        cex.txt=0.8, txt.col = "white",
        main = " observed transition shifts after removal of middle/low-ranked bird"
        )
dev.off() # Close the pdf file



```

randomization by focalrank separately

#####random

averaged separate by focalrank

```{r removal by trial}

glimpse(before_after)

## before removal vs after removal ----

# Step 2: create loop to get summary
rand_summ_removal <- data.frame(
                              group = numeric(),
                              focalrank = character(),
                              bin=numeric(),
                              change=character(),
                              random_n=numeric(),
                              prop=numeric())

## filter by rank
loopby <- unique(before_after$focalrank)
#i=1
for(i in seq_along(loopby)){
  run.rank <- loopby[i]
  print(run.rank)
  sub.data <- subset(before_after, focalrank==run.rank)

## filter by group
bygroup <- unique(before_after$group)

for(i in seq_along(bygroup)){
  run.code <- bygroup[i]
  print(run.code)
  group.data <- subset(sub.data, group==run.code)

## filter by bin/trial
  bytrial <-  c(2,6,10,14, 18, 22)
  # top-ranked <- c(2,14,22)
  # control <- c(6,10,18)
  
  
for(i in seq_along(bytrial)){
  runby <- bytrial[i]
  print(runby)
  run.data <- subset(group.data, bin==runby)
  
  
  ## summarize
pool<- run.data %>%
  group_by(focalrank, group, bin, random_pattern_change) %>%
  summarise(random_n=length(random_pattern_change), 
            random_prop = random_n/1000) %>%  # each run with 1000 randomized values
  rename(change=random_pattern_change) %>%
  #dplyr::select(-random_n) %>%
  mutate(prop=round(random_prop, 2)
         ) %>%
  dplyr::select(-random_prop)

check<- pool %>%
  summarize(sum=sum(random_n))
print(check$sum) # should be 1000

 rand_summ_removal<-rbind(rand_summ_removal, pool )


}}}

rand_removal <- rand_summ_removal %>%
  group_by(focalrank, change) %>%
  summarize(aveprop=mean(prop),
            sdprop=sd(prop),
            n=sum(random_n),
            se=sdprop/sqrt(n)) %>%
  mutate(prop=round(aveprop, 2),
         sd=round(sdprop, 2))



```

randomization by focalrank separately

###### top-ranked random

```{r dom pattern randomizations_removal}

## random  top-ranked
glimpse(rand_removal)



# filter top-ranked
rand_removal_top <- rand_removal %>%
  filter(focalrank=="top-ranked") 

  
# create matrix
r_removal <- rand_removal_top %>% 
  separate(change, into = c("before", "after"), sep="-") 

r_removal$before <- factor(r_removal$before, 
                    levels=c("bullying", "close competitor", "downward heuristic"), 
                                labels=c( "B" , "CC","DH"))

r_removal$after <- factor(r_removal$after, 
                    levels=c("bullying", "close competitor", "downward heuristic"), 
                                labels=c( "B" , "CC","DH"))

mx_r_r <- reshape2::dcast(r_removal, before~after, value.var="prop") #head(ref.behavior1.mx)
r.removal.mx <- matrix.please(mx_r_r)

# set line widtth
curves <- matrix(nrow=ncol(r.removal.mx),ncol=ncol(r.removal.mx),0)
curves[1,1]<- (r.removal.mx[1,1]*10)+1       
curves[1,2]<- (r.removal.mx[1,2]*10)+1 
curves[1,3]<- (r.removal.mx[1,3]*10)+1  
curves[2,1]<- (r.removal.mx[2,1]*10)+1 
curves[2,2]<- (r.removal.mx[2,2]*10)+1  
curves[2,3]<- (r.removal.mx[2,3]*10)+1 
curves[3,1]<- (r.removal.mx[3,1]*10)+1 
curves[3,2]<- (r.removal.mx[3,2]*10)+1  
curves[3,3]<- (r.removal.mx[3,3]*10)+1 


 
# plot transition diagram  --> colors and location patterns are off. double check props
pdf("./figures/plot_mean_random_removal_top.pdf")  # open and save the pdf file
plotmat(r.removal.mx, 
        #pty="s",
        #pos=c(1,1),
        
        # lines
         box.lwd=1, lwd=curves, self.lwd=c(2.3,4.5), lcol = "#56b4e9ff", #self.lwd=curves,  #
        
        # boxes
        box.cex=0.8, box.size=0.065 ,
        box.type="rect", # "circle", "ellipse", "diamond", "rect", "round", "hexa", "multi", "none"
        box.prop=1, box.col = c( "#0000FF","#C00000" , "#7F7F7F"),
        shadow.size = 0.0, 
        my=0, mx=0.0, # vertical and horizontal shift of boxes, respecitvely 
        
        # self 
        relsize=0.7, # rel size to box
        self.shiftx=c(.1, -0.1), self.shifty=c(-0.1, 0.1), 
        
        # arrow
        #arr.lwd = c(1, 2,3),
        #arr.length = 2,
        curve = 0.125, 
        arr.tcol = "black" , arr.col = "#56b4e9ff",
     
        # text
        cex.txt=0.8, txt.col = "white",
        main = "randomised averaged transition probabilities after removal of top-ranked focal bird")
dev.off() # Close the pdf file

```

###### control random

```{r dom pattern randomizations_removal}

## random  top-ranked
glimpse(rand_removal)



# filter top-ranked
rand_removal_control <- rand_removal %>%  
  filter(focalrank=="middle/low") %>%
  ungroup() %>%
   dplyr::select(-focalrank)

  
# create matrix
r_removal <- rand_removal_control  %>% 
  separate(change, into = c("before", "after"), sep="-") 

r_removal$before <- factor(r_removal$before, 
                    levels=c("bullying", "close competitor", "downward heuristic"), 
                                labels=c( "B" , "CC","DH"))

r_removal$after <- factor(r_removal$after, 
                    levels=c("bullying", "close competitor", "downward heuristic"), 
                                labels=c( "B" , "CC","DH"))

mx_r_r <- reshape2::dcast(r_removal, before~after, value.var="prop") #head(ref.behavior1.mx)
r.removal.mx <- matrix.please(mx_r_r)

# set line widtth
curves <- matrix(nrow=ncol(r.removal.mx),
                 ncol=ncol(r.removal.mx),0)
curves[1,1]<- (r.removal.mx[1,1]*10)+1       
curves[1,2]<- (r.removal.mx[1,2]*10)+1 
curves[1,3]<- (r.removal.mx[1,3]*10)+1  
curves[2,1]<- (r.removal.mx[2,1]*10)+1 
curves[2,2]<- (r.removal.mx[2,2]*10)+1  
curves[2,3]<- (r.removal.mx[2,3]*10)+1 
curves[3,1]<- (r.removal.mx[3,1]*10)+1 
curves[3,2]<- (r.removal.mx[3,2]*10)+1  
curves[3,3]<- (r.removal.mx[3,3]*10)+1 


 
# plot transition diagram  --> colors and location patterns are off. double check props
pdf("./figures/plot_mean_random_removal_control.pdf")  # open and save the pdf file
plotmat(r.removal.mx, 
        #pty="s",
        #pos=c(1,1),
        
        # lines
         box.lwd=1, lwd=curves, self.lwd=c(2.3,4.5), lcol = "#56b4e9ff", #self.lwd=curves,  #
        
        # boxes
        box.cex=0.8, box.size=0.065 ,
        box.type="rect", # "circle", "ellipse", "diamond", "rect", "round", "hexa", "multi", "none"
        box.prop=1, box.col = c( "#0000FF","#C00000" , "#7F7F7F"),
        shadow.size = 0.0, 
        my=0, mx=0.0, # vertical and horizontal shift of boxes, respecitvely 
        
        # self 
        relsize=0.7, # rel size to box
        self.shiftx=c(.1, -0.1), self.shifty=c(-0.1, 0.1), 
        
        # arrow
        #arr.lwd = c(1, 2,3),
        #arr.length = 2,
        curve = 0.125, 
        arr.tcol = "black" , arr.col = "#56b4e9ff",
     
        # text
        cex.txt=0.8, txt.col = "white",
        main = "randomised averaged transition probabilities after removal of middle/low-ranked focal bird")
dev.off() # Close the pdf file

```

#### reintroduction

##### observed

###### top-ranked observed

```{r}
## observed   {update}
obs_top_reintro <- obs_pattern_change %>%
  filter(bin %in% binchange_reintro, focalrank=="top-ranked") %>%
  group_by(focalrank,before, after, change) %>%
  summarize(obs_n=length(change), obs_prop = obs_n/6)  %>%
  mutate(prop=round(obs_prop, 2))

obs_top_reintro$before<- factor(obs_top_reintro$before, 
                                levels=c( "B" , "CC","DH"))
obs_top_reintro$after<- factor(obs_top_reintro$after, 
                                levels=c( "B" , "CC","DH"))


mx <- reshape2::dcast(obs_top_reintro, after~before, value.var="prop") 
obs.reintro.mx <- matrix.please(mx)
obs.reintro.mx[is.na(obs.reintro.mx)] <- 0

# set line width
linewidth <- matrix(nrow=3,
                    ncol=2,0)
linewidth[1,1]<- (obs.reintro.mx[1,1]*10)+1  
linewidth[1,2]<- (obs.reintro.mx[1,2]*10)+0
#linewidth[1,3]<- (obs.reintro.mx[1,3]*10)+1 
linewidth[2,2]<- (obs.reintro.mx[2,2]*10)+1  
linewidth[2,1]<- (obs.reintro.mx[2,1]*10)+1
#linewidth[2,3]<- (obs.reintro.mx[2,3]*10)+1  
linewidth[3,1]<- (obs.reintro.mx[3,1]*10)+1       
linewidth[3,2]<- (obs.reintro.mx[3,2]*10)+0 
#linewidth[3,3]<- (obs.reintro.mx[3,3]*10)+1 



# plot transition matrix
pdf("./figures/plot_obs_reintro_top.pdf")  # open and save the pdf file
plotmat(obs.reintro.mx, 
        #pty="s",
        #pos=c(1,1),
        
        # lines
        box.lwd=1, lwd=linewidth, lcol = "#ff6600ff",  #lcol=c( "#0000FF", "#7F7F7F"), 
        
        # boxes
        box.cex=0.8, box.size=0.065 ,box.type="rect", # "circle", "ellipse", "diamond", "rect", "round", "hexa", "multi", "none"
        box.prop=1, box.col = c( "#0000FF","#C00000" , "#7F7F7F"),
        shadow.size = 0.0, 
        my=0, mx=0.0, # vertical and horizontal shift of boxes, respecitvely 
        
        # self 
        relsize=0.7, self.lwd=c(4.3,4.3), #self.lwd = linewidth, 
        self.shiftx=c(.1, -0.1), self.shifty=c(-0.1, 0.1), 
        
        # arrow
        #arr.lwd = c(1, 2,3),
        #arr.length = 2,
        curve = 0.125,
        arr.tcol = "black" , arr.col = "#ff6600ff",
     
        # text
        cex.txt=0.8, txt.col = "white",
        main = "observed transition shifts after reintroduction of top-ranked bird"
        )
dev.off() # Close the pdf file



```

NB! arrows are going in the wrong direction when compared to the matrix

###### control observed

```{r}
## observed   
obs_ml_reintro<- obs_pattern_change %>%
  filter(bin %in% binchange_reintro, focalrank=="middle/low") %>%
  group_by(focalrank,before, after, change) %>%
  summarize(obs_n=length(change), obs_prop = obs_n/6)  %>%
  mutate(prop=round(obs_prop, 2))

obs_ml_reintro$before <- factor(obs_ml_reintro$before, 
                   #levels=c("bullying", "close competitor", "downward heuristic"), 
                                levels=c( "B" , "CC","DH"))

obs_ml_reintro$after <- factor(obs_ml_reintro$after, 
                  #levels=c("bullying", "close competitor", "downward heuristic"), 
                                levels=c( "B" , "CC","DH"))

mx <- reshape2::dcast(obs_ml_reintro, after~before, value.var="prop") 
obs.reintro.mx <- matrix.please(mx)
obs.reintro.mx[is.na(obs.reintro.mx)] <- 0

# set line width
linewidth <- matrix(nrow=3,
                    ncol=2,0)
linewidth[1,1]<- (obs.reintro.mx[1,1]*10)+1  
linewidth[1,2]<- (obs.reintro.mx[1,2]*10)+0
#linewidth[1,3]<- (obs.reintro.mx[1,3]*10)+1 
linewidth[2,2]<- (obs.reintro.mx[2,2]*10)+1  
linewidth[2,1]<- (obs.reintro.mx[2,1]*10)+1
#linewidth[2,3]<- (obs.reintro.mx[2,3]*10)+1  
linewidth[3,1]<- (obs.reintro.mx[3,1]*10)+1       
linewidth[3,2]<- (obs.reintro.mx[3,2]*10)+0 
#linewidth[3,3]<- (obs.reintro.mx[3,3]*10)+1 




# plot transition matrix
pdf("./figures/plot_obs_reintro_control.pdf")  # open and save the pdf file
plotmat(obs.reintro.mx, 
        #pty="s",
        #pos=c(1,1),
        
        # lines
        box.lwd=1, lwd=linewidth, lcol = "#ccccccff",  #lcol=c( "#0000FF", "#7F7F7F"), 
        
        # boxes
        box.cex=0.8, box.size=0.065 ,box.type="rect", # "circle", "ellipse", "diamond", "rect", "round", "hexa", "multi", "none"
        box.prop=1, box.col = c( "#0000FF","#C00000" , "#7F7F7F"),
        shadow.size = 0.0, 
        my=0, mx=0.0, # vertical and horizontal shift of boxes, respecitvely 
        
        # self 
        relsize=0.7, self.lwd=c(4.3,4.3), #self.lwd = linewidth, 
        self.shiftx=c(.1, -0.1), self.shifty=c(-0.1, 0.1), 
        
        # arrow
        #arr.lwd = c(1, 2,3),
        #arr.length = 2,
        curve = 0.125,
        arr.tcol = "black" , arr.col = "#ccccccff",
     
        # text
        cex.txt=0.8, txt.col = "white",
        main = "observed transition shifts after reintroduction of middle/low
        
        
        -ranked bird"
        )
dev.off() # Close the pdf file



```

##### random

averaged separate by focalrank, group, trial

```{r reintro  by trial}

## before vs after reintroduction----

# Step 2: create loop to get summary
rand_summ_reintro <- data.frame(
                              group = numeric(),
                              focalrank = character(),
                              bin=numeric(),
                              change=character(),
                              random_n=numeric(),
                              prop=numeric())

## filter by rank
loopby <- unique(before_after$focalrank)
#i=1
for(i in seq_along(loopby)){
  run.rank <- loopby[i]
  print(run.rank)
  sub.data <- subset(before_after, focalrank==run.rank)

## filter by group
bygroup <- unique(before_after$group)

for(i in seq_along(bygroup)){
  run.code <- bygroup[i]
  print(run.code)
  group.data <- subset(sub.data, group==run.code)

## filter by bin/trial
  bytrial <-  c(4,16,24,8,12,20 )
  # top-ranked <- c(4,16,24)
  # control <- c(8,12,20)
  
  
for(i in seq_along(bytrial)){
  runby <- bytrial[i]
  print(runby)
  run.data <- subset(group.data, bin==runby)
  
  
  ## summarize
pool<- run.data %>%
  group_by(focalrank, group, bin, random_pattern_change) %>%
  summarise(random_n=length(random_pattern_change), 
            random_prop = random_n/1000) %>%  # each run with 1000 randomized values
  rename(change=random_pattern_change) %>%
  #dplyr::select(-random_n) %>%
  mutate(prop=round(random_prop, 2)
         ) %>%
  dplyr::select(-random_prop)

check<- pool %>%
  summarize(sum=sum(random_n))
print(check$sum) # should be 1000

 rand_summ_reintro <- rbind(rand_summ_reintro, pool )


}}}

rand_reintro <- rand_summ_reintro %>%
  group_by(focalrank, change) %>%
  summarize(aveprop=mean(prop),
            sdprop=sd(prop),
            n=sum(random_n),
            se=sdprop/sqrt(n)) %>%
  mutate(prop=round(aveprop, 2),
         sd=round(sdprop, 2))



```

arrow directions are in the wrong direction! 

###### top-ranked random

```{r dom pattern randomizations_reintro}

## random  top-ranked
glimpse(rand_reintro)

# filter top-ranked
rand_reintro_top <- rand_reintro %>%
  filter(focalrank=="top-ranked") 

  
# create matrix
r_reintro  <- rand_reintro_top %>% 
  separate(change, into = c("before", "after"), sep="-") 

r_reintro$before <- factor(r_reintro$before, 
                    levels=c("bullying", "close competitor", "downward heuristic"), 
                                labels=c( "B" , "CC","DH"))

r_reintro$after <- factor(r_reintro$after, 
                    levels=c("bullying", "close competitor", "downward heuristic"), 
                                labels=c( "B" , "CC","DH"))

mx_r_r <- reshape2::dcast(r_reintro, before~after, value.var="prop") #head(ref.behavior1.mx)
r.reintro.mx <- matrix.please(mx_r_r)

# set line widtth
curves <- matrix(nrow=ncol(r.reintro.mx),ncol=ncol(r.reintro.mx),0)
curves[1,1]<- (r.reintro.mx[1,1]*10)+1       
curves[1,2]<- (r.reintro.mx[1,2]*10)+1 
curves[1,3]<- (r.reintro.mx[1,3]*10)+1  
curves[2,1]<- (r.reintro.mx[2,1]*10)+1 
curves[2,2]<- (r.reintro.mx[2,2]*10)+1  
curves[2,3]<- (r.reintro.mx[2,3]*10)+1 
curves[3,1]<- (r.reintro.mx[3,1]*10)+1 
curves[3,2]<- (r.reintro.mx[3,2]*10)+1  
curves[3,3]<- (r.reintro.mx[3,3]*10)+1 


 
# plot transition diagram  --> colors and location patterns are off. double check props
pdf("./figures/plot_mean_random_reintro_top.pdf")  # open and save the pdf file
plotmat(r.reintro.mx, 
        #pty="s",
        #pos=c(1,1),
        
        # lines
         box.lwd=1, lwd=curves, self.lwd=c(2.3,4.5), lcol = "#56b4e9ff", #self.lwd=curves,  #
        
        # boxes
        box.cex=0.8, box.size=0.065 ,
        box.type="rect", # "circle", "ellipse", "diamond", "rect", "round", "hexa", "multi", "none"
        box.prop=1, box.col = c( "#0000FF","#C00000" , "#7F7F7F"),
        shadow.size = 0.0, 
        my=0, mx=0.0, # vertical and horizontal shift of boxes, respecitvely 
        
        # self 
        relsize=0.7, # rel size to box
        self.shiftx=c(.1, -0.1), self.shifty=c(-0.1, 0.1), 
        
        # arrow
        #arr.lwd = c(1, 2,3),
        #arr.length = 2,
        curve = 0.125, 
        arr.tcol = "black" , arr.col = "#56b4e9ff",
     
        # text
        cex.txt=0.8, txt.col = "white",
        main = "randomised averaged transition probabilities after reintroduction of top-ranked focal bird")
dev.off() # Close the pdf file

```

###### control random

```{r dom pattern randomizations_reintro}

## random  control
glimpse(rand_reintro)

# filter control
rand_reintro_control <- rand_reintro %>%  
  filter(focalrank=="middle/low") %>%
  ungroup() %>%
   dplyr::select(-focalrank)

  
# create matrix
r_reintro <- rand_reintro_control  %>% 
  separate(change, into = c("before", "after"), sep="-") 

r_reintro$before <- factor(r_reintro$before, 
                    levels=c("bullying", "close competitor", "downward heuristic"), 
                                labels=c( "B" , "CC","DH"))

r_reintro$after <- factor(r_reintro$after, 
                    levels=c("bullying", "close competitor", "downward heuristic"), 
                                labels=c( "B" , "CC","DH"))

mx_r_r <- reshape2::dcast(r_reintro, before~after, value.var="prop") #head(ref.behavior1.mx)
r.reintro.mx <- matrix.please(mx_r_r)

# set line widtth
curves <- matrix(nrow=ncol(r.reintro.mx),
                 ncol=ncol(r.reintro.mx),0)
curves[1,1]<- (r.reintro.mx[1,1]*10)+1       
curves[1,2]<- (r.reintro.mx[1,2]*10)+1 
curves[1,3]<- (r.reintro.mx[1,3]*10)+1  
curves[2,1]<- (r.reintro.mx[2,1]*10)+1 
curves[2,2]<- (r.reintro.mx[2,2]*10)+1  
curves[2,3]<- (r.reintro.mx[2,3]*10)+1 
curves[3,1]<- (r.reintro.mx[3,1]*10)+1 
curves[3,2]<- (r.reintro.mx[3,2]*10)+1  
curves[3,3]<- (r.reintro.mx[3,3]*10)+1 


 
# plot transition diagram  --> colors and location patterns are off. double check props
pdf("./figures/plot_mean_random_reintro_control.pdf")  # open and save the pdf file
plotmat(r.reintro.mx, 
        #pty="s",
        #pos=c(1,1),
        
        # lines
         box.lwd=1, lwd=curves, self.lwd=c(2.3,4.5), lcol = "#56b4e9ff", #self.lwd=curves,  #
        
        # boxes
        box.cex=0.8, box.size=0.065 ,
        box.type="rect", # "circle", "ellipse", "diamond", "rect", "round", "hexa", "multi", "none"
        box.prop=1, box.col = c( "#0000FF","#C00000" , "#7F7F7F"),
        shadow.size = 0.0, 
        my=0, mx=0.0, # vertical and horizontal shift of boxes, respecitvely 
        
        # self 
        relsize=0.7, # rel size to box
        self.shiftx=c(.1, -0.1), self.shifty=c(-0.1, 0.1), 
        
        # arrow
        #arr.lwd = c(1, 2,3),
        #arr.length = 2,
        curve = 0.125, 
        arr.tcol = "black" , arr.col = "#56b4e9ff",
     
        # text
        cex.txt=0.8, txt.col = "white",
        main = "randomised averaged transition probabilities after reintroduction of middle/low-ranked focal bird")
dev.off() # Close the pdf file

```

## Is there a relationship between number of pattern shifts and focalrank by perturbation?

Do the number of shifts differ between top and middle/low-ranked focal trials by perturbation?

https://rcompanion.org/handbook/H_06.html 
```{r}
## combine and summarize
obs_change<- bind_rows(obs_pattern_change_removal , obs_pattern_change_reintro) %>%
  group_by(perturbation, focalrank) %>%
  filter(same=="no") %>%
  summarize(total=sum(obs_n))

pattern_shifts <- obs_change %>%
  group_by(perturbation, focalrank, same) %>%
  tally()



Table = xtabs(n ~ focalrank + same + perturbation,
              data=pattern_shifts)

   ###  Note that the grouping variable is last in the xtabs function

ftable(Table)
mantelhaen.test(Table)
### Woolf test for homogeneity of odds ratios across strata.
###   If significant, C-M-H test is not appropriate
library(vcd)
woolf_test(Table)

# post hoc 
library(rcompanion)

groupwiseCMH(Table,
                    group   = 3,
                       fisher  = F,
                       gtest   = F,
                       chisq   = T,
                       method  = "fdr",
                       correct = "none",
                       digits  = 3)
```

<https://cran.r-project.org/web/packages/samplesizeCMH/vignettes/samplesizeCMH-introduction.html>

```{r}

obs_shift <- obs_pattern_change %>%
   group_by(focalrank, before,after,change) %>% #group_by(group) 
 # summarize(obs_n=length(change), obs_prop = obs_n/6) %>% 
  #dplyr::select(-obs_n) %>% 
  mutate(shift=if_else(before==after, "same", "shift"), 
         perturbation=if_else(bin %in% binchange_removal, "removal", 
                      if_else(bin %in% binchange_reintro, "reintroduction", "NA"))) %>%
  filter(perturbation!="NA") %>%
  ungroup()

obs_shift$perturbation <- factor(obs_shift$perturbation , 
                                 levels=c("removal", "reintroduction"))


table(obs_shift$shift, obs_shift$focalrank,obs_shift$perturbation )
ftable(obs_shift$shift, obs_shift$focalrank,obs_shift$perturbation )

mantelhaen.test(obs_shift$shift, obs_shift$focalrank,obs_shift$perturbation )

dfobs <- obs_shift %>%
  dplyr::select(shift,   focalrank, perturbation) %>%
  table()
str(dfobs)
apply(dfobs, 3, function(x) (x[1,1]*x[2,2])/(x[1,2]*x[2,1]))
## This suggests that the assumption of homogeneous (conditional)
## odds ratios may be violated.  The traditional approach would be
## using the Woolf test for interaction:
woolf <- function(x) {
  x <- x + 1 / 2
  k <- dim(x)[3]
  or <- apply(x, 3, function(x) (x[1,1]*x[2,2])/(x[1,2]*x[2,1]))
  w <-  apply(x, 3, function(x) 1 / sum(1 / x))
  1 - pchisq(sum(w * (log(or) - weighted.mean(log(or), w)) ^ 2), k - 1)
}
woolf(dfobs)
## => p = 0.12, indicating that there is no heterogeneity. One assumption of the test is that there are no three-way interactions in the data.  This is confirmed with a non-significant result from a test such as the Woolf test or Breslow–Day test.(And hence the Mantel-Haenszel test can be used.)

# odds ratio 
apply(table(obs_shift$shift, obs_shift$focalrank,obs_shift$perturbation), 3, odds.ratio)


library(DescTools)

BreslowDayTest(table(obs_shift$shift, obs_shift$focalrank,obs_shift$perturbation), OR = 1)
```

No evidence for association between number of pattern shifts and focal rank when adjusted for perturbation type (Mantel-Haenszel chi-squared test: X = 1.38, df = 1, p = 0.2, common (weighted) odds ratio = 3.4) . 


## Are the pattern shifts the same between focal rank for perturbation separately?

<https://www.datacamp.com/tutorial/contingency-tables-r>
https://www.datacamp.com/tutorial/markov-chain-analysis-r 

matrix correlation between top/control for removal and reintroduction separately. 

### removal
observed

```{r}
binchange_removal <- c(2,6,10,14, 18, 22)

obs_shift_removal <- obs_pattern_change %>%
  filter(bin %in% binchange_removal) %>%
  group_by(focalrank, before,after,change) %>% #group_by(group) 
 # summarize(obs_n=length(change), obs_prop = obs_n/6) %>% 
  #dplyr::select(-obs_n) %>% 
  mutate(perturbation="removal",
         same=if_else(before==after, "yes", "no"))

# matrix  
obs_top_rm <- obs_shift_removal %>%
  filter(focalrank=="top-ranked")
  mx <- reshape2::dcast(obs_top_rm, before~after) #head(ref.behavior1.mx)
  mx <- matrix.please(mx)
  
  CC <- c(0,0,0)
  mx.top <- cbind(mx, CC)
  col.order <- c("B","CC","DH")
   mx.top <- mx.top[ , col.order]

obs_con_rm <- obs_shift_removal %>%
  filter(focalrank=="middle/low")
  mx.c <- reshape2::dcast(obs_con_rm, before~after) #head(ref.behavior1.mx)
  mx.c <- matrix.please(mx.c)
  
  
# Mantel test
  library(ape)
  mantel.test(mx.top, mx.c) # ape package
  mantel(mx.top, mx.c, method = "spearman") # vegan package


```

The pattern transitions upon removal are not indpenedent between top- and middle/low-ranked focal trials (G test: G=10.04, df = 6, p = 0.1)

Random
```{r}
binchange_removal <- c(2,6,10,14, 18, 22)

r_shift_removal <- before_after %>%
  filter(bin %in% binchange_removal) %>% 
  separate(random_pattern_change, into=c("before", "after"), sep = "-", remove=F) %>%
  rename(change=random_pattern_change) %>%
  group_by(focalrank, before,after,change) %>% #group_by(group) 
 # summarize(obs_n=length(change), obs_prop = obs_n/6) %>% 
  #dplyr::select(-obs_n) %>% 
  mutate(perturbation="removal",
         same=if_else(before==after, "yes", "no")) %>%
  ungroup()

rm_table<- table(r_shift_removal$change, r_shift_removal$focalrank)
rm_table

# test statistic by run
r_removal_test <- data.frame(run.code=character(),
                             #X=numeric(),
                      #chi.p=numeric(),
                      G=numeric(),
                      p=numeric())



loopby <- unique(r_shift_removal$runID)

#i=1

for(i in seq_along(unique(r_shift_removal$runID))){
  run.code <- loopby[i]
  print(run.code)
  run.data <- subset(r_shift_removal, runID==run.code)
  
Xtest <-  chisq.test(run.data$change, 
                 run.data$focalrank)
#chisq.test(run.data$change, run.data$focalrank)$expected
X <- Xtest$statistic
chi.p <- Xtest$p.value

test <-GTest(run.data$change, 
                 run.data$focalrank)

G <- test$statistic
p <- test$p.value

  # --- combine dataframe
pool <-  cbind.data.frame(run.code, 
                          #X, chi.p,
                         G, p) 

r_removal_test  <- rbind(pool, r_removal_test )
  
}

glimpse(r_removal_test)

```
plot
```{r}
ggplot(r_removal_test, aes(x=p)) +
  geom_histogram(bins=25) +
  theme_classic() +
  geom_vline(xintercept = obsGtest$p.value, color="red", size=1)


ggplot(r_removal_test, aes(x=G)) +
  geom_histogram(bins=25) +
  theme_classic() +
  geom_vline(xintercept = obsGtest$statistic, color="red", size=1) +
  annotate("text", x = 12, y = 175, label = "p = 0.47" )

ggsave("./figures/plotGtest_removal.pdf", width= 125, height=125, units="mm") 
```

Are observed values significantly different from random values in reference models?

find proportion of random values less than the observed values, you can use this as a kind of p value. p should be >0.975 for two-tailed test, >0.95 for one-tailed test for something significantly different from the random values in the reference model
  
```{r}
# p-values 
prop.val <- nrow(r_removal_test[r_removal_test$G<obsGtest$statistic, ])/nrow(r_removal_test) 
p.removal<- ifelse(prop.val>0.5, 1-prop.val, prop.val) 
p.removal
```


### reintroduction

```{r}
binchange_reintro <- c(4, 8, 12, 16, 20, 24)

obs_shift_reintro <- obs_pattern_change %>%
  filter(bin %in% binchange_reintro) %>%
  group_by(focalrank, before,after,change) %>% #group_by(group) 
 # summarize(obs_n=length(change), obs_prop = obs_n/6) %>% 
  #dplyr::select(-obs_n) %>% 
  mutate(perturbation="removal",
         same=if_else(before==after, "yes", "no"))

# matrix  
obs_top_re <- obs_shift_reintro %>%
  filter(focalrank=="top-ranked")
  mx <- reshape2::dcast(obs_top_re, before~after) #head(ref.behavior1.mx)
  mx <- matrix.please(mx)
  DH <- c(0,0,0)
  mx.top.re <- cbind(mx, DH) *10


obs_con_re <- obs_shift_reintro %>%
  filter(focalrank=="middle/low")
  mx.c <- reshape2::dcast(obs_con_re, before~after) #head(ref.behavior1.mx)
  mx.c <- matrix.please(mx.c)
  B <- c(0,0,0)
  mx.con.re <- cbind(B, mx.c) *10
  
  
  
# Mantel test
  library(ape)
  mantel.test(mx.top.re, mx.con.re) # ape package
  mantel(mx.top.re, mx.con.re, method = "spearman", permutations=100) # vegan package
```




Random
```{r}
binchange_reintro <- c(4, 8, 12, 16, 20, 24)

r_shift_reintro <- before_after %>%
  filter(bin %in% binchange_reintro) %>% 
  separate(random_pattern_change, into=c("before", "after"), sep = "-", remove=F) %>%
  rename(change=random_pattern_change) %>%
  group_by(focalrank, before,after,change) %>% #group_by(group) 
 # summarize(obs_n=length(change), obs_prop = obs_n/6) %>% 
  #dplyr::select(-obs_n) %>% 
  mutate(perturbation="reintroduction",
         same=if_else(before==after, "yes", "no")) %>%
  ungroup()

ri_table<- table(r_shift_reintro$change, r_shift_reintro$focalrank)
ri_table

# test statistic by run
r_reintro_test <- data.frame(run.code=character(),
                             #X=numeric(),
                      #chi.p=numeric(),
                      G=numeric(),
                      p=numeric())



loopby <- unique(r_shift_reintro$runID)

#i=1

for(i in seq_along(unique(r_shift_reintro$runID))){
  run.code <- loopby[i]
  print(run.code)
  run.data <- subset(r_shift_reintro, runID==run.code)
  
rtop <- run.data %>%
  filter(focalrank=="top-ranked")
  mx <- reshape2::dcast(rtop, before~after) #head(ref.behavior1.mx)
  mx <- matrix.please(mx)
  DH <- c(0,0,0)
  mx.top.re <- cbind(mx, DH) *10
  
  

cor <- mantel(r.mx.top, r.mx.con, method = "spearman") # vegan package
  stat <- cor$statistic
  p <- cor$p

  # --- combine dataframe
pool <-  cbind.data.frame(run.code, 
                          #X, chi.p,
                         G, p) 

r_reintro_test  <- rbind(pool, r_reintro_test )
  
}

glimpse(r_reintro_test)

```
plot
```{r}
ggplot(r_reintro_test, aes(x=p)) +
  geom_histogram(bins=25) +
  theme_classic() +
  geom_vline(xintercept = reintro_obsGtest$p.value, color="red", size=1)


ggplot(r_reintro_test, aes(x=G)) +
  geom_histogram(bins=25) +
  theme_classic() +
  geom_vline(xintercept = reintro_obsGtest$statistic, color="red", size=1) +
  annotate("text", x = 12, y = 175, label = "p = 0.09" )

ggsave("./figures/plotGtest_reintro.pdf", width= 125, height=125, units="mm") 
```

# Zombie

## are the patterns the same?
### removal
observed

```{r}
binchange_removal <- c(2,6,10,14, 18, 22)

obs_shift_removal <- obs_pattern_change %>%
  filter(bin %in% binchange_removal) %>%
  group_by(focalrank, before,after,change) %>% #group_by(group) 
 # summarize(obs_n=length(change), obs_prop = obs_n/6) %>% 
  #dplyr::select(-obs_n) %>% 
  mutate(perturbation="removal",
         same=if_else(before==after, "yes", "no"))

rm_table<- table(obs_shift_removal$change, obs_shift_removal$focalrank)


odds.ratio(table(obs_shift_removal$change, obs_shift_removal$focalrank))


prop.table(table(obs_shift_removal$change, 
                 obs_shift_removal$focalrank))

prop.table(table(obs_shift_removal$change, 
                 obs_shift_removal$focalrank), margin=2)*100

chisq.test(obs_shift_removal$change, 
                 obs_shift_removal$focalrank)
chisq.test(obs_shift_removal$change, 
                 obs_shift_removal$focalrank)$expected

X<- chisq.test(obs_shift_removal$focalrank, 
                 obs_shift_removal$change)
X
X$expected

fisher.test(obs_shift_removal$change, 
                 obs_shift_removal$focalrank)

library(DescTools)
obsGtest <- GTest(obs_shift_removal$change, 
                 obs_shift_removal$focalrank)
obsGtest



```

The pattern transitions upon removal are not indpenedent between top- and middle/low-ranked focal trials (G test: G=10.04, df = 6, p = 0.1)

Random
```{r}
binchange_removal <- c(2,6,10,14, 18, 22)

r_shift_removal <- before_after %>%
  filter(bin %in% binchange_removal) %>% 
  separate(random_pattern_change, into=c("before", "after"), sep = "-", remove=F) %>%
  rename(change=random_pattern_change) %>%
  group_by(focalrank, before,after,change) %>% #group_by(group) 
 # summarize(obs_n=length(change), obs_prop = obs_n/6) %>% 
  #dplyr::select(-obs_n) %>% 
  mutate(perturbation="removal",
         same=if_else(before==after, "yes", "no")) %>%
  ungroup()

rm_table<- table(r_shift_removal$change, r_shift_removal$focalrank)
rm_table

# test statistic by run
r_removal_test <- data.frame(run.code=character(),
                             #X=numeric(),
                      #chi.p=numeric(),
                      G=numeric(),
                      p=numeric())



loopby <- unique(r_shift_removal$runID)

#i=1

for(i in seq_along(unique(r_shift_removal$runID))){
  run.code <- loopby[i]
  print(run.code)
  run.data <- subset(r_shift_removal, runID==run.code)
  
Xtest <-  chisq.test(run.data$change, 
                 run.data$focalrank)
#chisq.test(run.data$change, run.data$focalrank)$expected
X <- Xtest$statistic
chi.p <- Xtest$p.value

test <-GTest(run.data$change, 
                 run.data$focalrank)

G <- test$statistic
p <- test$p.value

  # --- combine dataframe
pool <-  cbind.data.frame(run.code, 
                          #X, chi.p,
                         G, p) 

r_removal_test  <- rbind(pool, r_removal_test )
  
}

glimpse(r_removal_test)

```
plot
```{r}
ggplot(r_removal_test, aes(x=p)) +
  geom_histogram(bins=25) +
  theme_classic() +
  geom_vline(xintercept = obsGtest$p.value, color="red", size=1)


ggplot(r_removal_test, aes(x=G)) +
  geom_histogram(bins=25) +
  theme_classic() +
  geom_vline(xintercept = obsGtest$statistic, color="red", size=1) +
  annotate("text", x = 12, y = 175, label = "p = 0.47" )

ggsave("./figures/plotGtest_removal.pdf", width= 125, height=125, units="mm") 
```

Are observed values significantly different from random values in reference models?

find proportion of random values less than the observed values, you can use this as a kind of p value. p should be >0.975 for two-tailed test, >0.95 for one-tailed test for something significantly different from the random values in the reference model
  
```{r}
# p-values 
prop.val <- nrow(r_removal_test[r_removal_test$G<obsGtest$statistic, ])/nrow(r_removal_test) 
p.removal<- ifelse(prop.val>0.5, 1-prop.val, prop.val) 
p.removal
```


### reintroduction

```{r}
binchange_reintro <- c(4, 8, 12, 16, 20, 24)

obs_shift_reintro <- obs_pattern_change %>%
  filter(bin %in% binchange_reintro) %>%
  group_by(focalrank, before,after,change) %>% #group_by(group) 
 # summarize(obs_n=length(change), obs_prop = obs_n/6) %>% 
  #dplyr::select(-obs_n) %>% 
  mutate(perturbation="removal",
         same=if_else(before==after, "yes", "no"))

marginal_table<- table(obs_shift_reintro$change, obs_shift_reintro$focalrank)

library(samplesizeCMH)
odds.ratio(table(obs_shift_reintro$change, obs_shift_reintro$focalrank))


prop.table(table(obs_shift_reintro$change, 
                 obs_shift_reintro$focalrank))

prop.table(table(obs_shift_reintro$change, 
                 obs_shift_reintro$focalrank), margin=2)*100

chisq.test(obs_shift_reintro$change, 
                 obs_shift_reintro$focalrank)
chisq.test(obs_shift_reintro$change, 
                 obs_shift_reintro$focalrank)$expected


fisher.test(obs_shift_reintro$change, 
                 obs_shift_reintro$focalrank)

library(DescTools)
reintro_obsGtest<- GTest(obs_shift_reintro$change, 
                 obs_shift_reintro$focalrank)
```

The pattern transitions upon reintroduction are independent between top- and middle/low-ranked focal trials (G test: G=13.9, df = 6, p = 0.03 )


Random
```{r}
binchange_reintro <- c(4, 8, 12, 16, 20, 24)

r_shift_reintro <- before_after %>%
  filter(bin %in% binchange_reintro) %>% 
  separate(random_pattern_change, into=c("before", "after"), sep = "-", remove=F) %>%
  rename(change=random_pattern_change) %>%
  group_by(focalrank, before,after,change) %>% #group_by(group) 
 # summarize(obs_n=length(change), obs_prop = obs_n/6) %>% 
  #dplyr::select(-obs_n) %>% 
  mutate(perturbation="reintroduction",
         same=if_else(before==after, "yes", "no")) %>%
  ungroup()

ri_table<- table(r_shift_reintro$change, r_shift_reintro$focalrank)
ri_table

# test statistic by run
r_reintro_test <- data.frame(run.code=character(),
                             #X=numeric(),
                      #chi.p=numeric(),
                      G=numeric(),
                      p=numeric())



loopby <- unique(r_shift_reintro$runID)

#i=1

for(i in seq_along(unique(r_shift_reintro$runID))){
  run.code <- loopby[i]
  print(run.code)
  run.data <- subset(r_shift_reintro, runID==run.code)
  
# Xtest <-  chisq.test(run.data$change, 
#                  run.data$focalrank)
# #chisq.test(run.data$change, run.data$focalrank)$expected
# X <- Xtest$statistic
# chi.p <- Xtest$p.value

test <-GTest(run.data$change, 
                 run.data$focalrank)

G <- test$statistic
p <- test$p.value

  # --- combine dataframe
pool <-  cbind.data.frame(run.code, 
                          #X, chi.p,
                         G, p) 

r_reintro_test  <- rbind(pool, r_reintro_test )
  
}

glimpse(r_reintro_test)

```
plot
```{r}
ggplot(r_reintro_test, aes(x=p)) +
  geom_histogram(bins=25) +
  theme_classic() +
  geom_vline(xintercept = reintro_obsGtest$p.value, color="red", size=1)


ggplot(r_reintro_test, aes(x=G)) +
  geom_histogram(bins=25) +
  theme_classic() +
  geom_vline(xintercept = reintro_obsGtest$statistic, color="red", size=1) +
  annotate("text", x = 12, y = 175, label = "p = 0.09" )

ggsave("./figures/plotGtest_reintro.pdf", width= 125, height=125, units="mm") 
```

Are observed values significantly different from random values in reference models?

find proportion of random values less than the observed values, you can use this as a kind of p value. p should be >0.975 for two-tailed test, >0.95 for one-tailed test for something significantly different from the random values in the reference model
  
```{r}
# p-values 
prop.val.reintro <- nrow(r_reintro_test[r_reintro_test$G<reintro_obsGtest$statistic, ])/nrow(r_reintro_test) 
p.reintro<- ifelse(prop.val.reintro>0.5, 1-prop.val.reintro,prop.val.reintro) #ifelse(test, yes, no)
p.reintro
```




# Transition distribution

### removal

#### top-ranked

top-ranked \<- c(2,14,22)

```{r removal by run}

## before removal vs after removal ----

# per run
rand_removalXrun <- before_after %>%
  filter(bin %in% c(2,14,22)) %>%
  group_by(runID, random_pattern_change) %>%
  summarise(n_trials=length(random_pattern_change)) %>%  # 3 trials
  rename(change=random_pattern_change) #%>%
  #dplyr::select(-random_n) %>%
  #mutate(prop=round(random_prop, 2)) %>%
  #dplyr::select(-random_prop)

pattern_changes <- sort(unique(before_after$obs_pattern_change))
pattern_changes <- as.data.frame(pattern_changes)
pattern_changes <- pattern_changes %>%
  rename(change = "pattern_changes") 

# include all possible patterns

# make empty data frame to put data in
rand_removalXrun_all <- data.frame(runID=character(),
                      change=character(), 
                      random_n=numeric(),
                      prop=numeric())

loopby <- unique(rand_removalXrun$runID)

for(i in seq_along(loopby)){
  run.code <- loopby[i]
  #print(run.code)
  run.data <- subset(rand_removalXrun, runID==run.code)
  
  data_allpatterns <- merge(pattern_changes, run.data, all.x=TRUE,
                       by=c("change")) 

  data_allpatterns$runID<-run.code
  
 #fill newly-merged data with 0's where no patterns
 data_allpatterns[is.na(data_allpatterns)] <- 0
 
 # check
 sum(data_allpatterns$random_n) # should total 3 trials
  
   # combine in dataframe
  rand_removalXrun_all<-rbind(rand_removalXrun_all, data_allpatterns)
}

glimpse(rand_removalXrun_all)

# calculate proportion 
rand_removalXrun_all<- rand_removalXrun_all %>%
  mutate(random_prop = n_trials/6)  # raw data of the 3 trials of the averaged summary  (the following provides different info; length(pattern_changes$change) -> moved to supplemental)

glimpse(rand_removalXrun_all)


# summarize
summ_rand_removal <- rand_removalXrun_all %>%
  group_by(change, random_prop) %>%
  summarise(total=length(runID), 
            p.value=total/1000)

# How many runs do we see same pattern as observed? 
obs.vs.rand_removal <- before_after %>%
  filter(bin %in% c(2,14,22)) %>%
  group_by(runID) %>%
  mutate(similar_pattern= if_else(obs_pattern_change==random_pattern_change,"yes", "no")) %>%
  group_by(runID,similar_pattern) %>%
  summarize(n=length(similar_pattern))
  
summ_obs.vs.rand_removal  <- obs.vs.rand_removal %>%
  filter(similar_pattern=="yes", n==6) 
total_runs_same_removal <- length(summ_obs.vs.rand_removal$runID)/length(unique(before_after$runID))*100


# figure
glimpse(rand_removalXrun_all)
glimpse(summ_rand_removal)

rand_removalXrun_all <- rand_removalXrun_all %>%
  mutate(pattern_change = factor(change, levels=c("downward heuristic-downward heuristic",
                                                  "downward heuristic-close competitor",
                                                  "downward heuristic-bullying",
                                                  "close competitor-downward heuristic",
                                                  "close competitor-close competitor",
                                                  "close competitor-bullying",
                                                  "bullying-downward heuristic",
                                                  "bullying-close competitor",
                                                  "bullying-bullying"),
                                 labels = c("DH-DH", "DH-CC", "DH-B",
                                            "CC-DH", "CC-CC", "CC-B",
                                            "B-DH", "B-CC", "B-B")))
#summ_rand_removalXrun_all <- rand_removalXrun_all %>%
#  group_by(change, random_prop) %>%
#  summarize(n=length(runID),
#            prop=n/1000)


 plot_removal_dist <-  ggplot(rand_removalXrun_all, aes(x = random_prop, y = change, fill = change)) +
  geom_density_ridges( stat="binline",bins=8.5, scale=0.8, draw_baseline = F, center = 0) + #alpha=0.6, binwidth=1
  theme_ridges(#font_size = 12,
    #font_family = "",
   line_size = 0.01,
   # grid = FALSE,
    center_axis_labels = FALSE) + #grid=FALSE
  theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8),
      axis.title.x = element_text(hjust = 0.5)
      #axis.title.y = element_text(hjust = 0.5)
    ) +
    xlab("proportion of runs") +
    ylab("") +
    #scale_fill_manual(values = c("#0000FF", "#b3b0e3", "#deebf7", "#7F7F7F")) + #"#C00000" ,
   scale_x_continuous( expand = c(0, 0),limits = c(-0.1,1.2),
                       breaks = c(0.00, 0.33, 0.66, 1.00)) +
   scale_y_discrete(expand = expansion(mult = c(0.0, .3))) +
   
  # include observed proportion
  geom_segment(y=9, yend=9.8, x = 0.17, xend=0.17, size=1,  color="red") + # trial 1
  geom_segment(y=7, yend=7.8, x = 0.17, xend=0.17, size=1,  color="red") + # trial 2 #linetype = "dashed",
  geom_segment(y=4, yend=4.8, x = 0.33, xend=0.33, size=1,  color="red") +  # trial 3
  geom_segment(y=6, yend=6.8, x = 0.17, xend=0.17, size=1,  color="red") + # trial 2 #linetype = "dashed",
  geom_segment(y=3, yend=3.8, x = 0.17, xend=0.17, size=1,  color="red") +
   
  #geom_segment(y=1, yend=5, x = 1, xend=1, size=1,  color="white") +
   coord_cartesian(clip = "off") 
plot_removal_dist 


ggsave("figures/plot_dist_removal_top.pdf") #, width = 2.5, height = 3


total_rand_removal <- summ_rand_removal %>%
  group_by(change) %>%
  summarize(sum=sum(total))

plot_removal_bar <- ggplot(summ_rand_removal, aes(x=change, y=p.value, fill=as.factor(random_prop))) +
  geom_bar(stat = "identity" , position="dodge") +
  coord_flip() +
  ylab("proportion of runs") +
  xlab("") +
  scale_fill_viridis(discrete=TRUE, name="") +
  theme_classic()
plot_removal_bar

```

0% of the runs showed the same pattern changes for all 6 trials across both groups as the observed pattern changes

Calculate distribution of pattern changes and confidence intervals per run. So we get 1000 proportion values.

If observed pattern change falls outside reference model values, a change from downward heuristic to bullying is different from random.

#### control

control \<- c(6,10,18)

```{r removal by run}

## before removal vs after removal ----

# per run
rand_removalXrun <- before_after %>%
  filter(bin %in% c(6,10,18)) %>%
  group_by(runID, random_pattern_change) %>%
  summarise(n_trials=length(random_pattern_change)) %>%  # 3 trials
  rename(change=random_pattern_change) #%>%
  #dplyr::select(-random_n) %>%
  #mutate(prop=round(random_prop, 2)) %>%
  #dplyr::select(-random_prop)

pattern_changes <- sort(unique(before_after$obs_pattern_change))
pattern_changes <- as.data.frame(pattern_changes)
pattern_changes <- pattern_changes %>%
  rename(change = "pattern_changes") 

# include all possible patterns

# make empty data frame to put data in
rand_removalXrun_all <- data.frame(runID=character(),
                      change=character(), 
                      random_n=numeric(),
                      prop=numeric())

loopby <- unique(rand_removalXrun$runID)

for(i in seq_along(loopby)){
  run.code <- loopby[i]
  #print(run.code)
  run.data <- subset(rand_removalXrun, runID==run.code)
  
  data_allpatterns <- merge(pattern_changes, run.data, all.x=TRUE,
                       by=c("change")) 

  data_allpatterns$runID<-run.code
  
 #fill newly-merged data with 0's where no patterns
 data_allpatterns[is.na(data_allpatterns)] <- 0
 
 # check
 sum(data_allpatterns$random_n) # should total 3 trials
  
   # combine in dataframe
  rand_removalXrun_all<-rbind(rand_removalXrun_all, data_allpatterns)
}

glimpse(rand_removalXrun_all)

# calculate proportion 
rand_removalXrun_all<- rand_removalXrun_all %>%
  mutate(random_prop = n_trials/6)  # raw data of the 3 trials of the averaged summary  (the following provides different info; length(pattern_changes$change) -> moved to supplemental)

glimpse(rand_removalXrun_all)


# summarize
summ_rand_removal <- rand_removalXrun_all %>%
  group_by(change, random_prop) %>%
  summarise(total=length(runID), 
            p.value=total/1000)

# How many runs do we see same pattern as observed? 
obs.vs.rand_removal <- before_after %>%
  filter(bin %in%  c(6,10,18)) %>%
  group_by(runID) %>%
  mutate(similar_pattern= if_else(obs_pattern_change==random_pattern_change,"yes", "no")) %>%
  group_by(runID,similar_pattern) %>%
  summarize(n=length(similar_pattern))
  
summ_obs.vs.rand_removal  <- obs.vs.rand_removal %>%
  filter(similar_pattern=="yes", n==6) 
total_runs_same_removal <- length(summ_obs.vs.rand_removal$runID)/length(unique(before_after$runID))*100


# figure

glimpse(rand_removalXrun_all)
glimpse(summ_rand_removal)

rand_removalXrun_all <- rand_removalXrun_all %>%
  mutate(pattern_change = factor(change, levels=c("downward heuristic-downward heuristic",
                                                  "downward heuristic-close competitor",
                                                  "downward heuristic-bullying",
                                                  "close competitor-downward heuristic",
                                                  "close competitor-close competitor",
                                                  "close competitor-bullying",
                                                  "bullying-downward heuristic",
                                                  "bullying-close competitor",
                                                  "bullying-bullying"),
                                 labels = c("DH-DH", "DH-CC", "DH-B",
                                            "CC-DH", "CC-CC", "CC-B",
                                            "B-DH", "B-CC", "B-B")))

 plot_removal_dist_control <-  ggplot(rand_removalXrun_all, 
                                      aes(x = random_prop, y = change, fill = change)) +
  geom_density_ridges( stat="binline",bins=8.5, scale=0.8, draw_baseline = F, center = 0) + #alpha=0.6, binwidth=1
  
   theme_ridges(#font_size = 12,
    #font_family = "",
   line_size = 0.01,
   # grid = FALSE,
    center_axis_labels = FALSE) + #grid=FALSE
   
  theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8),
      axis.title.x = element_text(hjust = 0.5)
      #axis.title.y = element_text(hjust = 0.5)
    ) +
    xlab("proportion of runs") +
    ylab("") +
    #scale_fill_manual(values = c("#0000FF", "#b3b0e3", "#deebf7", "#7F7F7F")) + #"#C00000" ,
   scale_x_continuous( expand = c(0, 0),limits = c(-0.1,1.2),
                       breaks = c(0.00, 0.33, 0.66, 1.00)) +
   scale_y_discrete(expand = expansion(mult = c(0.0, .3))) +
   
  # include observed proportion
  geom_segment(y=9, yend=9.8, x = 0.33, xend=0.33, size=1,  color="red") + # trial 1
  geom_segment(y=6, yend=6.8, x = 0.17, xend=0.17, size=1,  color="red") + # trial 2 #linetype = "dashed",
  #geom_segment(y=4, yend=4.8, x = 0.33, xend=0.33, size=1,  color="red") +  # trial 3
  geom_segment(y=5, yend=5.8, x = 0.33, xend=0.33, size=1,  color="red") + # trial 2 #linetype = "dashed",
  geom_segment(y=1, yend=1.8, x = 0.17, xend=0.17, size=1,  color="red") +
   
  #geom_segment(y=1, yend=5, x = 1, xend=1, size=1,  color="white") +
   coord_cartesian(clip = "off") 
plot_removal_dist_control 


ggsave("figures/plot_dist_removal_control.pdf") # , width = 2.5, height = 3


total_rand_removal <- summ_rand_removal %>%
  group_by(change) %>%
  summarize(sum=sum(total))

plot_removal_bar <- ggplot(summ_rand_removal, aes(x=change, y=p.value, fill=as.factor(random_prop))) +
  geom_bar(stat = "identity" , position="dodge") +
  coord_flip() +
  ylab("proportion of runs") +
  xlab("") +
  scale_fill_viridis(discrete=TRUE, name="") +
  theme_classic()
plot_removal_bar

```

0% of the runs showed the same pattern changes for all 6 trials across both groups as the observed pattern changes

Calculate distribution of pattern changes and confidence intervals per run. So we get 1000 proportion values.

If observed pattern change falls outside reference model values, a change from downward heuristic to bullying is different from random.

### reintroduction

#### top-ranked

top-ranked \<- c(4,16,24)

```{r reintroduction by run}

# per run
rand_reintroXrun <- before_after %>%
  filter(bin %in% c(4,16,24)) %>%
  group_by(runID, random_pattern_change) %>%
  summarise(n_trials=length(random_pattern_change)) %>%  # 3 trials
  rename(change=random_pattern_change) #%>%
  #dplyr::select(-random_n) %>%
  #mutate(prop=round(random_prop, 2)) %>%
  #dplyr::select(-random_prop)

pattern_changes <- sort(unique(before_after$obs_pattern_change))
pattern_changes <- as.data.frame(pattern_changes)
pattern_changes <- pattern_changes %>%
  rename(change = "pattern_changes") 

# include all possible patterns

# make empty data frame to put data in
rand_reintroXrun_all <- data.frame(runID=character(),
                      change=character(), 
                      random_n=numeric(),
                      prop=numeric())

loopby <- unique(rand_reintroXrun$runID)

for(i in seq_along(loopby)){
  run.code <- loopby[i]
  #print(run.code)
  run.data <- subset(rand_reintroXrun, runID==run.code)
  
  data_allpatterns <- merge(pattern_changes, run.data, all.x=TRUE,
                       by=c("change")) 

  data_allpatterns$runID<-run.code
  
 #fill newly-merged data with 0's where no patterns
 data_allpatterns[is.na(data_allpatterns)] <- 0
 
 # check
 sum(data_allpatterns$random_n) # should total 3 trials
  
   # combine in dataframe
  rand_reintroXrun_all<-rbind(rand_reintroXrun_all, data_allpatterns)
}

glimpse(rand_reintroXrun_all)

# calculate proportion 
rand_reintroXrun_all<- rand_reintroXrun_all %>%
  mutate(random_prop = n_trials/6) # 3 trials instead of 4 possible pattern changes (length(pattern_changes$change))


# summarize
summ_rand_reintro <- rand_reintroXrun_all %>%
  group_by(change, random_prop) %>%
  summarise(total=length(runID), 
            p.value=total/1000)


# How many runs do we see same pattern as observed? 
obs.vs.rand_reintro <- before_after %>%
  filter(bin %in% c(4,16,24)) %>%
  group_by(runID) %>%
  mutate(similar_pattern= if_else(obs_pattern_change==random_pattern_change,"yes", "no")) %>%
  group_by(runID,similar_pattern) %>%
  summarize(n=length(similar_pattern))
  
summ_obs.vs.rand_reintro <- obs.vs.rand_reintro %>%
  filter(similar_pattern=="yes", n==6) 
total_runs_same_reintro <- length(summ_obs.vs.rand_reintro$runID)/length(unique(before_after$runID))*100

total_runs_same_reintro 



# fugure
plot_reintro_dist_top <- ggplot(rand_reintroXrun_all, aes(x = random_prop, y = change, fill = change)) +
  #stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.025, 0.975), alpha = 0.7) 
  #geom_density_ridges2() 
  # geom_density_ridges(
  #  jittered_points = TRUE, quantile_lines = TRUE, scale = 0.9, alpha = 0.7,
  #  vline_size = 1, vline_color = "red",
  #  point_size = 0.4, point_alpha = 1,
  #  position = position_raincloud(adjust_vlines = TRUE)
  #)
  #stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.025, 0.975), alpha = 0.7) +
  geom_density_ridges( stat="binline", bins=8.5, scale=0.8, draw_baseline = F) + #alpha=0.6,
   theme_ridges(#font_size = 12,
    #font_family = "",
   line_size = 0.01,
   # grid = FALSE,
    center_axis_labels = FALSE) + #grid=FALSE
  theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8),
      axis.title.x = element_text(hjust = 0.5)
      #axis.title.y = element_text(hjust = 0.5)
    ) +
   #scale_fill_manual(values = c("#0000FF", "#b3b0e3", "#deebf7", "#7F7F7F")) + #"#C00000" ,
   scale_x_continuous( expand = c(0, 0),limits = c(-0.1,1.2),
                       breaks = c(0.00, 0.33, 0.66, 1.00)) +
   scale_y_discrete(expand = expansion(mult = c(0.0, .3))) +
    xlab("Pattern transition proportions") +
    ylab("") +
  coord_cartesian(clip = "off") +
   
  # include observed proportion
  geom_segment(y=7, yend=7.8, x = 0.33, xend=0.33, size=1,  color="red") + 
  geom_segment(y=5, yend=5.8, x = 0.17, xend=0.17, size=1,  color="red") + 
  geom_segment(y=4, yend=4.8, x = 0.17, xend=0.17, size=1,  color="red") + 
  geom_segment(y=1, yend=1.8, x = 0.33, xend=0.33, size=1,  color="red") 

plot_reintro_dist_top
ggsave("figures/fig_dist_reintro_top.pdf") #, width = 2.5, height = 3

```

#### control

control \<- c(8,12,20)

```{r reintroduction by run}

# per run
rand_reintroXrun <- before_after %>%
  filter(bin %in% c(8,12,20)) %>%
  group_by(runID, random_pattern_change) %>%
  summarise(n_trials=length(random_pattern_change)) %>%  # 3 trials
  rename(change=random_pattern_change) #%>%
  #dplyr::select(-random_n) %>%
  #mutate(prop=round(random_prop, 2)) %>%
  #dplyr::select(-random_prop)

pattern_changes <- sort(unique(before_after$obs_pattern_change))
pattern_changes <- as.data.frame(pattern_changes)
pattern_changes <- pattern_changes %>%
  rename(change = "pattern_changes") 

# include all possible patterns

# make empty data frame to put data in
rand_reintroXrun_all <- data.frame(runID=character(),
                      change=character(), 
                      random_n=numeric(),
                      prop=numeric())

loopby <- unique(rand_reintroXrun$runID)

for(i in seq_along(loopby)){
  run.code <- loopby[i]
  #print(run.code)
  run.data <- subset(rand_reintroXrun, runID==run.code)
  
  data_allpatterns <- merge(pattern_changes, run.data, all.x=TRUE,
                       by=c("change")) 

  data_allpatterns$runID<-run.code
  
 #fill newly-merged data with 0's where no patterns
 data_allpatterns[is.na(data_allpatterns)] <- 0
 
 # check
 sum(data_allpatterns$random_n) # should total 3 trials
  
   # combine in dataframe
  rand_reintroXrun_all<-rbind(rand_reintroXrun_all, data_allpatterns)
}

glimpse(rand_reintroXrun_all)

# calculate proportion 
rand_reintroXrun_all<- rand_reintroXrun_all %>%
  mutate(random_prop = n_trials/6) # 3 trials instead of 4 possible pattern changes (length(pattern_changes$change))


# summarize
summ_rand_reintro <- rand_reintroXrun_all %>%
  group_by(change, random_prop) %>%
  summarise(total=length(runID), 
            p.value=total/1000)


# How many runs do we see same pattern as observed? 
obs.vs.rand_reintro <- before_after %>%
  filter(bin %in% c(8,12,20)) %>%
  group_by(runID) %>%
  mutate(similar_pattern= if_else(obs_pattern_change==random_pattern_change,"yes", "no")) %>%
  group_by(runID,similar_pattern) %>%
  summarize(n=length(similar_pattern))
  
summ_obs.vs.rand_reintro <- obs.vs.rand_reintro %>%
  filter(similar_pattern=="yes", n==6) 
total_runs_same_reintro <- length(summ_obs.vs.rand_reintro$runID)/length(unique(before_after$runID))*100

total_runs_same_reintro 



# fugure
plot_reintro_dist_control <- ggplot(rand_reintroXrun_all, aes(x = random_prop, y = change, fill = change)) +
  #stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.025, 0.975), alpha = 0.7) 
  #geom_density_ridges2() 
  # geom_density_ridges(
  #  jittered_points = TRUE, quantile_lines = TRUE, scale = 0.9, alpha = 0.7,
  #  vline_size = 1, vline_color = "red",
  #  point_size = 0.4, point_alpha = 1,
  #  position = position_raincloud(adjust_vlines = TRUE)
  #)
  #stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.025, 0.975), alpha = 0.7) +
  geom_density_ridges( stat="binline", bins=8.5, scale=0.8, draw_baseline = F) + #alpha=0.6,
   theme_ridges(#font_size = 12,
    #font_family = "",
   line_size = 0.01,
   # grid = FALSE,
    center_axis_labels = FALSE) + #grid=FALSE
  theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8),
      axis.title.x = element_text(hjust = 0.5)
      #axis.title.y = element_text(hjust = 0.5)
    ) +
   #scale_fill_manual(values = c("#0000FF", "#b3b0e3", "#deebf7", "#7F7F7F")) + #"#C00000" ,
   scale_x_continuous( expand = c(0, 0),limits = c(-0.1,1.2),
                       breaks = c(0.00, 0.33, 0.66, 1.00)) +
   scale_y_discrete(expand = expansion(mult = c(0.0, .3))) +
    xlab("Pattern transition proportions") +
    ylab("") +
  coord_cartesian(clip = "off") +
   
  # include observed proportion
  geom_segment(y=9, yend=9.8, x = 0.33, xend=0.33, size=1,  color="red") + 
  geom_segment(y=6, yend=6.8, x = 0.33, xend=0.33, size=1,  color="red") + 
  geom_segment(y=5, yend=5.8, x = 0.17, xend=0.17, size=1,  color="red") + 
  geom_segment(y=3, yend=3.8, x = 0.17, xend=0.17, size=1,  color="red") 

plot_reintro_dist_control
ggsave("figures/fig_dist_reintro_control.pdf") #, width = 2.5, height = 3

```

0% of the runs showed the same pattern changes for all three trials as the observed pattern changes

Calculate distribution of pattern changes and confidence intervals per run. So we get 1000 proportion values.

If observed pattern change falls outside reference model values, a change from downward heuristic to bullying is different from random.

# plot network tranistions

use network graphs instead of transition diagram

```{r}
# all possible pattern changes
pattern <- c("DH", "B", "CC")
pattern.list<- expand.grid(pattern, pattern)
names(pattern.list) <- c("before", "after")
pattern.list$change <- paste(pattern.list$before, pattern.list$after, sep="-")
```

#### removal

top-ranked

```{r}

obs_top_removal <- obs_pattern_change %>%
  filter(bin %in% binchange_removal, focalrank=="top-ranked") %>%
  group_by(focalrank,before, after, change) %>%
  summarize(obs_n=length(change), obs_prop = obs_n/6)  %>%
  mutate(prop=round(obs_prop, 2))

obs_top_removal$before<- factor(obs_top_removal$before, 
                                levels=c("DH", "CC", "B"))

  #right_join(pattern.list ) %>%  
# obs_top_removal$focalrank <- "top-ranked"
# obs_top_removal[is.na(obs_top_removal)] <-0
# obs_top_removal$prop <- round(obs_top_removal$obs_prop, 2)

  # create graph from dataframe
 #gdf <- graph.data.frame(obs_top_removal)
 g <- graph_from_data_frame(obs_top_removal, directed=TRUE)

set.seed(42)

E(g)$weight <- obs_top_removal$obs_prop
E(g)$edgelabel <- obs_top_removal$prop

# set nodes 
V(g)$name <- c("B", "CC", "DH")
V(g)$boxcolor <- c( "#0000FF","#C00000" , "#7F7F7F")


# layout

dflayout <- create_layout(g, layout=lay)
dflayout

x <- c(.1, -.1, 0)
y <- c(0, 0, .5)
lay<-cbind(x, y)

# plot

g_top_removal <-
  ggraph(g, layout=lay) +
  
  # --- edges
    geom_edge_arc(aes(label=edgelabel,
                      edge_width =.5*weight
                    #alpha = .6,
                    ),
                  colour="red", #weight
                  arrow = arrow(length = unit(4, 'mm')), 
                  start_cap = circle(5, 'mm'),
                  end_cap = circle(10, 'mm'),
                  strength=0.2,
                   angle_calc = 'along',
                   label_dodge = unit(2.5, 'mm'),
                  label_push = unit(2, 'mm')) +

    # self_loop
  geom_edge_loop(aes(label=edgelabel,
                     edge_width =.5*weight, 
                    #alpha = 0.6 # ..index..
                    span=120, 
                    strength=0.1),
                 # angle_calc = 'across',
                 label_dodge = unit(-1, 'mm'),
                 label_push = unit(2, 'mm') ,
        
                 colour= "red" , #weight
                 start_cap = circle(1, 'mm'),
                 end_cap = circle(1, 'mm'),
                  #strength=0.2,
                 ) +
   

  # --- nodes
  
   geom_node_point(aes( shape= layout$name,
                       fill = as.factor(layout$boxcolor)
                       ),color = "black", size=10) +
   scale_fill_manual(name = "boxcolor",
                     values=  c( "#0000FF","#7F7F7F","#C00000"  )) +
   scale_shape_manual( name = "name",
                      values = c( 22,22,22 ), #c( 21, 23 )  19, 17
                      labels = c( "B", "CC" ,"DH")) +
   geom_node_text(aes(label = name, color="white")) +
  
  # --- layout
  theme_graph() +
  theme(legend.position = "none")
  
  
 
# ggsave( "./figures/obs_top_removal.pdf",
#         width = 30, height = 30, units = "mm",
#         device = cairo_pdf,
#         plot=g_top_removal)

```

middle/low

```{r}
obs_ml_removal <- obs_pattern_change %>%
  filter(bin %in% binchange_removal, focalrank=="middle/low") %>%
  group_by(focalrank,before, after, change) %>%
  summarize(obs_n=length(change), obs_prop = obs_n/6)  %>%
  mutate(prop=round(obs_prop, 2))

obs_top_removal$before<- factor(obs_top_removal$before, 
                                levels=c("DH", "CC", "B"))


  # create graph from dataframe

 g <- graph_from_data_frame(obs_ml_removal, directed=TRUE)

set.seed(42)

E(g)$weight <- obs_ml_removal$obs_prop
E(g)$edgelabel <- obs_ml_removal$prop

# set nodes 
V(g)$name <- c("B", "CC", "DH")
V(g)$boxcolor <- c( "#0000FF","#C00000" , "#7F7F7F")


# layout
x <- c(.1, -.1, 0)
y <- c(0, 0, .5)
lay<-cbind(x, y)

dflayout <- create_layout(g, layout=lay)
dflayout

# plot

g_ml_removal <-
  ggraph(g, layout=lay) +
  
  # --- edges
    geom_edge_arc(aes(label=edgelabel,
                      edge_width =.5*weight
                    #alpha = .6,
                    ),
                  colour="red", #weight
                  arrow = arrow(length = unit(4, 'mm')), 
                  start_cap = circle(5, 'mm'),
                  end_cap = circle(10, 'mm'),
                  strength=0.2,
                   angle_calc = 'along',
                   label_dodge = unit(2.5, 'mm'),
                  label_push = unit(2, 'mm')) +

    # self_loop
  geom_edge_loop(aes(label=edgelabel,
                     edge_width =.5*weight, 
                    #alpha = 0.6 # ..index..
                    span=120, 
                    strength=0.1),
                 # angle_calc = 'across',
                 label_dodge = unit(-1, 'mm'),
                 label_push = unit(2, 'mm') ,
        
                 colour= "red" , #weight
                 start_cap = circle(1, 'mm'),
                 end_cap = circle(1, 'mm'),
                  #strength=0.2,
                 ) +
   

  # --- nodes
  
   geom_node_point(aes( shape= layout$name,
                       fill = as.factor(layout$boxcolor)
                       ),color = "black", size=10) +
   scale_fill_manual(name = "boxcolor",
                     values=  c( "#0000FF","#7F7F7F","#C00000"  )) +
   scale_shape_manual( name = "name",
                      values = c( 22,22,22 ), #c( 21, 23 )  19, 17
                      labels = c( "B", "CC" ,"DH")) +
   geom_node_text(aes(label = name, color="white")) +
  
  # --- layout
  theme_graph() +
  theme(legend.position = "none")
  
```

#### reintroduction

top-ranked

```{r}

obs_top_reintro <- obs_pattern_change %>%
  filter(bin %in% binchange_reintro, focalrank=="top-ranked") %>%
  group_by(focalrank,before, after, change) %>%
  summarize(obs_n=length(change), obs_prop = obs_n/6)  %>%
  mutate(prop=round(obs_prop, 2))

obs_top_reintro$before<- factor(obs_top_reintro$before, 
                                levels=c("DH", "CC", "B"))

  # create graph from dataframe
 g <- graph_from_data_frame(obs_top_reintro, directed=TRUE)

set.seed(42)

E(g)$weight <- obs_top_reintro$obs_prop
E(g)$edgelabel <- obs_top_reintro$prop

# set nodes 
V(g)$name <- c("B", "CC", "DH")
V(g)$boxcolor <- c( "#0000FF","#C00000" , "#7F7F7F")


# layout


x <- c(.1, -.1, 0)
y <- c(0, 0, .5)
lay<-cbind(x, y)

#dflayout <- create_layout(g, layout=lay)
# dflayout


# plot

g_top_reintro <-
  ggraph(g, layout=lay) +
  
  # --- edges
    geom_edge_arc(aes(label=edgelabel,
                      edge_width =.5*weight
                    #alpha = .6,
                    ),
                  colour="red", #weight
                  arrow = arrow(length = unit(4, 'mm')), 
                  start_cap = circle(5, 'mm'),
                  end_cap = circle(10, 'mm'),
                  strength=0.2,
                   angle_calc = 'along',
                   label_dodge = unit(2.5, 'mm'),
                  label_push = unit(2, 'mm')) +

    # self_loop
  geom_edge_loop(aes(label=edgelabel,
                     edge_width =.5*weight, 
                    #alpha = 0.6 # ..index..
                    span=120, 
                    strength=0.1),
                 # angle_calc = 'across',
                 label_dodge = unit(-1, 'mm'),
                 label_push = unit(2, 'mm') ,
        
                 colour= "red" , #weight
                 start_cap = circle(1, 'mm'),
                 end_cap = circle(1, 'mm'),
                  #strength=0.2,
                 ) +
   

  # --- nodes
  
   geom_node_point(aes( shape= layout$name,
                       fill = as.factor(layout$boxcolor)
                       ),color = "black", size=10) +
   scale_fill_manual(name = "boxcolor",
                     values=  c( "#0000FF","#7F7F7F","#C00000"  )) +
   scale_shape_manual( name = "name",
                      values = c( 22,22,22 ), #c( 21, 23 )  19, 17
                      labels = c( "B", "CC" ,"DH")) +
   geom_node_text(aes(label = name, color="white")) +
  
  # --- layout
  theme_graph() +
  theme(legend.position = "none")
  
  
 
# ggsave( "./figures/obs_top_removal.pdf",
#         width = 30, height = 30, units = "mm",
#         device = cairo_pdf,
#         plot=g_top_removal)

```

middle/low

```{r}
obs_ml_reintro <- obs_pattern_change %>%
  filter(bin %in% binchange_reintro, focalrank=="middle/low") %>%
  group_by(focalrank,before, after, change) %>%
  summarize(obs_n=length(change), obs_prop = obs_n/6)  %>%
  mutate(prop=round(obs_prop, 2))

obs_top_reintro$before<- factor(obs_top_reintro$before, 
                                levels=c("DH", "CC", "B"))


  # create graph from dataframe

 g <- graph_from_data_frame(obs_ml_reintro, directed=TRUE)

set.seed(42)

E(g)$weight <- obs_ml_reintro$obs_prop
E(g)$edgelabel <- obs_ml_reintro$prop

# set nodes 
V(g)$name <- c("B", "CC", "DH")
V(g)$boxcolor <- c( "#0000FF","#C00000" , "#7F7F7F")


# layout
x <- c(.1, -.1, 0)
y <- c(0, 0, .5)
lay<-cbind(x, y)

# dflayout <- create_layout(g, layout=lay)
# dflayout

# plot

g_ml_removal <-
  ggraph(g, layout=lay) +
  
  # --- edges
    geom_edge_arc(aes(label=edgelabel,
                      edge_width =.5*weight
                    #alpha = .6,
                    ),
                  colour="red", #weight
                  arrow = arrow(length = unit(4, 'mm')), 
                  start_cap = circle(5, 'mm'),
                  end_cap = circle(10, 'mm'),
                  strength=0.2,
                   angle_calc = 'along',
                   label_dodge = unit(2.5, 'mm'),
                  label_push = unit(2, 'mm')) +

    # self_loop
  geom_edge_loop(aes(label=edgelabel,
                     edge_width =.5*weight, 
                    #alpha = 0.6 # ..index..
                    span=120, 
                    strength=0.1),
                 # angle_calc = 'across',
                 label_dodge = unit(-1, 'mm'),
                 label_push = unit(2, 'mm') ,
        
                 colour= "red" , #weight
                 start_cap = circle(1, 'mm'),
                 end_cap = circle(1, 'mm'),
                  #strength=0.2,
                 ) +
   

  # --- nodes
  
   geom_node_point(aes( shape= layout$name,
                       fill = as.factor(layout$boxcolor)
                       ),color = "black", size=10) +
   scale_fill_manual(name = "boxcolor",
                     values=  c( "#0000FF","#7F7F7F","#C00000"  )) +
   scale_shape_manual( name = "name",
                      values = c( 22,22,22 ), #c( 21, 23 )  19, 17
                      labels = c( "B", "CC" ,"DH")) +
   geom_node_text(aes(label = name, color="white")) +
  
  # --- layout
  theme_graph() +
  theme(legend.position = "none")
  
```

```{r}
 # tryouts
  ggraph(g, layout = 'graphopt') + 
    geom_edge_link(aes(start_cap = label_rect(node1.name),
                       end_cap = label_rect(node2.name)), 
                   arrow = arrow(length = unit(4, 'mm'))) + 
    geom_node_text(aes(label = name))
  
ggraph(g, layout = lay) + 

  geom_node_text(aes(label = name)) +
  geom_edge_arc(aes(width=weight, colour = weight, alpha = ..index..
                    ), 
                start_cap = circle(10, 'mm'),
                end_cap = circle(5, 'mm'),
                #arrow = arrow(length = unit(4, 'mm')),
                strength=0.2) + 
    scale_edge_alpha('Edge direction', guide = 'edge_direction') +
       #scale_edge_alpha('Edge direction', guide = 'edge_direction') +
  # geom_edge_fan(aes(edge_width =weight, 
  #                   colour=weight,
  #                   alpha = 0.6 # ..index..
  #                   ), 
  #               strength = 1.55) + 
   # scale_edge_colour_manual(values = c("#f03b20", "#2c7fb8")) +

  theme_graph() +
  theme(legend.position = "none")
```
