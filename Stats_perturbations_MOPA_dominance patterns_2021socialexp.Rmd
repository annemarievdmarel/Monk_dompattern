---
title: "Perturbations monk parakeets"
author: "Annemarie"
date: "23/05/2020"
output:
  
  pdf_document: default
    dev: cairo_pdf # could remove
  html_document: default
editor_options: 
  chunk_output_type: console
---

R code to obtain the dominance hierarchy of 3-day period 
  - social dominance pattern

Basics
-	Number of total aggressive events observed
-	Total hours observed

Figures
-	Daily amount of aggression received/given corrected for hours observed
-	Time series social dominance patterns
-	transition diagram observed and random expectation
- aggression networks


#Session info
```{r}
sessionInfo()

#citation('diagram')
#citation('ggridges')
```


#Load packages
```{r, include=FALSE, echo=FALSE}
library(tidyverse)
library(reshape2)
library(stringr)
library(purrr)
library(domstruc) #remotes::install_github("danm0nster/domstruc")
library(ggraph)
library(diagram)
library(ggpubr)
library(ggridges)
library(igraph)
library(ggraph)
library(vegan)
```


# Import data

```{r data import, include=FALSE, echo=FALSE}
## raw data
behave_raw <- read.csv("./data/2021_interactions_raw.csv") %>%
  dplyr::select(-X)
unique(behave_raw$date)

# behave_agg <- read.csv("data/2021_interactions_social perturbations_bin0-12.csv") %>%
#   dplyr::select(-X)
#unique(behave_agg$date)

# check
unique(behave_raw$actor)
unique(behave_raw$subject)

#checkbehave <- anti_join( behave_agg, behave_bin)
#unique(behave_bin$date)
#unique(behave_agg$date)


# period file
#obs.day.key <- read.csv("../2021_timeline_fieldwork.csv") 
bin.dates <- read.csv("data/2021_3daybins.csv") #%>%
unique(bin.dates$bin)
bins <- bin.dates %>%
  #filter(bin<10) %>% 
  dplyr::select(date, type, bin, n_birds) 

# bird list
 birdIDs_capture<- read.csv("data/2021_birdIDs.csv") 
attrib_node <- birdIDs_capture %>%
  filter(mark_id3!="") %>%
  dplyr::select(-mark_id1,-mark_id2,-mark_id3, -year_death)

birdIDs <- birdIDs_capture %>%
  dplyr::select(mark_id3) %>%
  filter(mark_id3!="") # all 20 birds
birdIDs_removal1 <- birdIDs %>% filter(mark_id3!="BBB")
birdIDs_removal2 <- birdIDs %>% filter(mark_id3!="GPG")
birdIDs_removal3 <- birdIDs %>% filter(mark_id3!="OPP")





## summary files
# aggression dataframe by dyad without duplicates
dyad.totalaggXbin.21exp <-read.csv("./output/dyad.aggXbin.socialexp21.csv") %>%
  dplyr::select(-X) %>%
  rename(rank_assessment=bin) %>%
  right_join(bin.dates %>% 
              filter(bin>10, bin<23) %>%
              select(bin, rank_assessment) %>%
              group_by(bin) %>%
              slice_tail() %>%
              ungroup(), by = "rank_assessment") 
sort(unique(dyad.totalaggXbin.21exp$bin))
sum(dyad.totalaggXbin.21exp$n.aggXbin)



# dominance
#ec_rankXbin <- read.csv("output/dominance_perturbation_long.csv")

#  long perturbation summary
summary <- read.csv("./output/long_perturbation_summary_v1.csv")

# focal rank aggression per bin
focal_rank_agg <- read.csv("./output/id_level_agg_longperturbation.csv")


# observation hours:
hours_obs_raw <- read.csv("./data/2021_observation hours_cleaned.csv") %>%
  dplyr::select(-X)




```

## periods
```{r}


# from bin 10 onward; only social experiment
bin.dates$bin <- as.integer(bin.dates$bin)
bin_exp <- bin.dates %>%
  filter(bin>10, bin<23) %>% 
  dplyr::select(date, bin, type, n_birds) %>%
  group_by(bin) %>% 
  slice_tail() %>%
  ungroup()

bin_exp_dates <- bin.dates %>%
  filter(bin>10, bin<23) %>% 
  dplyr::select(date, bin, type, n_birds)
```


##Include bin and period to behavior file + orderkey
bin 11 start of experiment


```{r}
behave_bin <- behave_raw %>%
  left_join(bin_exp_dates) %>%
  filter(bin!="NA")

unique(behave_bin$bin)
unique(behave_bin$date)
sort(unique(behave_bin$actor)) # check for GBB, BOO, NPB, BBP
sort(unique(behave_bin$subject)) 

head(behave_bin)
tail(behave_bin)

# how many days per period
day_sum<- behave_bin %>% 
  group_by( bin) %>%
  summarise(n=n_distinct(date))

```


## change bird names for actor and subject

I still had instances for aggression with NPB who is not in the bird list, now I updated the name. 

```{r}

 #(mark_id1 = mark_id2)


## mark_id1 = mark_id2 ; from 22 to 20 birds
# GBB = NPB
behave_bin$actor[behave_bin$actor=="GBB"] <- "NPB"
behave_bin$subject[behave_bin$subject=="GBB"] <- "NPB"

# BOO = POO
behave_bin$actor[behave_bin$actor=="BOO"] <- "POO"
behave_bin$subject[behave_bin$subject=="BOO"] <- "POO"

## mark_id2 = mark_id3 ; different colors
# GBB = NPB
behave_bin$actor[behave_bin$actor=="NPB"] <- "PPB"
behave_bin$subject[behave_bin$subject=="NPB"] <- "PPB"


# check
sort(unique(behave_bin$actor))
sort(unique(behave_bin$subject)) 

#bird.list


```

## check for removed birds in social perturbation period
BBP
OBG

```{r}

unique(behave_bin$type)
period20birds <- c("duo", "switch")

check_social_actor<-filter(behave_bin, #type %in% period20birds, 
                           actor == "BBP"|actor =="OBG") 
check_social_subject<-filter(behave_bin, #type %in% period20birds, 
                             subject == "BBP"|subject =="OBG")
check_social<-bind_rows(check_social_actor,check_social_subject)
length(behave_bin$orderkey)-length(check_social$orderkey) 

#behave_correct<-anti_join(behavekey, check_social, by = "orderkey")
#length(behave_correct$orderkey)
```



# Helper functions & data
```{r echo=FALSE}
# include calibri as text font
windowsFonts(Calibri = windowsFont("Calibri"))
#windowsFonts()


#make matrix function (from dataframe, 1st col with row names)
matrix.please<-function(x) {
  m<-as.matrix(x[,-1])
  rownames(m)<-x[,1]
  m
}



```

## set ggplot theme
```{r}
theme_new <-   theme_classic() +
  theme(legend.position="bottom",
         text = element_text(size=16),
         axis.text = element_text(size=18),
         axis.title.x = element_blank())
```

# bird list

change for each perturbation as different birds are removed
```{r}
##list of all valid color combinations
# birdIDs$mark_id3 = all 20 birds
birdIDs_removal1 <- birdIDs %>% filter(mark_id3!="BBB")
birdIDs_removal2 <- birdIDs %>% filter(mark_id3!="GPG")
birdIDs_removal3 <- birdIDs %>% filter(mark_id3!="OPP")

# change each time
bird.list <- sort(unique(birdIDs$mark_id3)) # change each time
length(bird.list)
bird.list

# list of all possible dyads
dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")

```


# Remove duplicates

more conservative: removing duplicates using crowds and displacements combined from the beginning, results in less agonistic events but mistakes per behavior (entered crowd while it had to be displacement) are excluded. 


to compare hierarchy over time include aggression at feeder. From 2021-04-24, aggression at feeders separate but to compare with beginning add aggression at feeders with the rest

```{r remove duplicates conservative method X bin}
#### Remove duplicates for displacements and crowds ####
##more conservative: removing duplicates by crowds and displacements combined
#behave_totalagg<-behave_totalagg_removal

# include all aggression (at the feeder and away from feeder)
unique(behave_bin$behavior)

# all aggression (both feeders and nonfeeders)
behave_agg <- behave_bin %>%
  separate(behavior, c("behavior", "type"), sep="_") # all aggression at both feeders and away from feeders

unique(behave_agg$behavior)
unique(behave_agg$date)
unique(behave_agg$bin)

# filter displacement & crowd data from all data
aggDC <- behave_agg %>% #behave_agg
  subset(behavior=="displace" | behavior=="crowd") %>% 
  select(sessionKEY, session_start_timeStamp, type, bin, date, time, actor, subject, behavior) 

unique((aggDC$bin))
str(aggDC)
length(aggDC$sessionKEY)

# keep only observations where the actor is in the list of bird IDs
aggDC.goodID <- subset(aggDC, actor %in% bird.list)

# keep only observations where the actor (found above) and the subject are both in the list of bird IDs
aggDC.goodID <- subset(aggDC.goodID, subject %in% bird.list)


## for total agonistic events (crowds and displacements combined)
#finds n CD and crowds by sessionKEY, date, time, actor, subject, behavior
dyad.totalagg.key <- aggDC.goodID %>% 
  dplyr::group_by(sessionKEY, bin, date, time,actor, subject) %>%  # removed , behavior
  tally() # counts behaviors that were observed within the same minute

#finds max agg per actor by date, time, and behavior type. Return just that summary
dyad.totalagg.maxkey <- dyad.totalagg.key %>% 
  group_by(actor, subject,bin,  date, time) %>% # removed behavior, behavior
  slice(which.max(n)) %>% # n.aggXaggXkey if summarise, n if tally
  ungroup()
#head(dyad.totalagg.maxkey)

#finds n disps per actor by date for summarized/trimmed data
dyad.totalaggXbin <- dyad.totalagg.maxkey %>% 
  group_by(actor, subject, bin) %>% # removed behavior to get total aggression
  summarise(n.aggXbin=sum(n)) %>% 
  ungroup()
#head(dyad.totalaggXbin)
sum(dyad.totalaggXbin$n.aggXbin)


#Here we are interested in total number of interactions instead of chronological #order of interactions. If you require order of interactions, then next steps will #be different from the following setup as you will have to add the behaviors with #n>1 as separate rows. 


```

### save summarized aggression df
```{r}

dyad.totalaggXbin.2021socialexp <- dyad.totalaggXbin
#write.csv(dyad.totalaggXbin, "./output/dyad.aggXbin.socialexp21.csv")

```

### total aggression
```{r sum total aggression}
## Summarize displacements & crowds combined --> total aggression
dyad.totalaggXbin<- read.csv("./output/dyad.aggXbin.socialexp21.csv")
sum(dyad.totalaggXbin$n.aggXbin)

#dyad.totalaggXbin <- dyad.totalaggXbin.21exp

#head(dyad.totalaggXbin) # crowds and displacement combined from the start, which is more conservative
str(dyad.totalaggXbin)


# check 
unique(dyad.totalaggXbin$actor)
length(unique(dyad.totalaggXbin$actor))
unique(dyad.totalaggXbin$subject)
length(unique(dyad.totalaggXbin$subject))
sort(unique(dyad.totalaggXbin$bin))

sum(dyad.totalaggXbin$n.aggXbin, na.rm = T)

# summarize total aggression events per bin
sum.aggDCXbin_21exp <-dyad.totalaggXbin %>%
  group_by(bin) %>%
  summarize(n.agg = sum(n.aggXbin), 
            n.dyads=length(actor), 
            actors=n_distinct(actor), 
            receivers=n_distinct(subject))
#head(sum.aggDCXbin_conservative)

n.aggDC.21exp <- sum(sum.aggDCXbin_21exp$n.agg)

# check 
sum(dyad.totalaggXbin$n.aggXbin)==sum(sum.aggDCXbin_21exp$n.agg)




```



# Individual dominance rank X bin 
This is the code to identify the top-ranked bird in the bins prior the removal. 

```{r indivdidual rank}
#dyad.totalaggXbin <-read.csv("./output/dyad.aggXbin.socialexp21.csv")

# check data
sort(unique(dyad.totalaggXbin$bin))
sort(unique(dyad.totalaggXbin$actor))
sort(unique(dyad.totalaggXbin$subject))
length(unique(dyad.totalaggXbin$actor))
length(unique(dyad.totalaggXbin$subject))

sum(dyad.totalaggXbin$n.aggXbin)
#### DOMINANCE RANK BY bin####

#head(dyad.totalaggXbin)

# make empty data frame to put data in
ec_rank <- data.frame(run.code=character(),
                      bird.list=character(), 
                      dom_ec=numeric(),
                      rank=numeric())

# run = 1

start.time <- Sys.time()

# select only bins prior removal
rank_assessment_bins <- c(11, 15, 19)


#i=1

for(i in seq_along(rank_assessment_bins)){
  run.code <- rank_assessment_bins[i]
  print(run.code)
  run.data <- subset(dyad.totalaggXbin, bin==run.code)
  
# number of dyads correct?
  #length(run.data$actor)
  #check <- sum.aggXday %>% filter(date==run.code)
  #head(check)
  
  data_alldyads <- merge(dyad.list, run.data, all.x=TRUE,
                       by=c("actor", "subject")) 
  
  #head(data_alldyads)
  #length(unique(data_alldyads$dyadID)) # with 20 birds: 380 dyads, with 21 birds should be 420 and with 22 462 dyads
  
  data_alldyads$date<-run.code
  
 #fill newly-merged data with 0's where no interactions
 data_alldyads[is.na(data_alldyads)] <- 0
  
   #print a check
  check <- length(data_alldyads$actor)
  print(check)

# matrix  
  mx <- reshape2::dcast(data_alldyads, actor~subject, value.var="n.aggXbin") #head(ref.behavior1.mx)
  mx[is.na(mx)] <- 0 #for linearity measure, matrix needs to be fully filled, no NAs
  mx <- matrix.please(mx)
  
  ## dominance
  dom_ec <- dom_ec(mx)

  rank <- dom_ranks(dom_ec)


  # combine in dataframe
  pool <- cbind.data.frame(run.code, 
                         bird.list,
                         dom_ec,
                         rank)

  ec_rank<-rbind(ec_rank, pool )

}

end.time <- Sys.time()

#Time to run:
end.time - start.time

# check
glimpse(ec_rank)
length(unique(ec_rank$run.code))
check <- ec_rank %>% 
  group_by(run.code) %>% 
  summarize(length(bird.list))

ec_rankXbin <- ec_rank %>%
  rename(bin=run.code, id=bird.list) %>%
  mutate(power=1-dom_ec, 
         rank=21-rank) %>%
  group_by(bin) %>%
  arrange(dom_ec)

focalbirds <- ec_rankXbin %>%
  filter(bin %in% c(11, 15, 19), rank==1) %>%
  arrange(bin)
#focalbirds

```

Top-ranked birds
Trial 1: BBB (we used toin coss to choose between PPB and BBB)
Trial 2: GPG
Trial 3: OPP


# Social dominance pattern X bin
We have to run the dominance pattern analysis separately for the removal periods as we excluded one of the group members. Therefore when we are making the matrix we have to filter out the top-ranked focal bird, which is a different ID each trial. 

```{r}
#dyad.totalaggXbin <-read.csv("./output/dyad.aggXbin.socialexp21.csv")
unique(dyad.totalaggXbin$bin)

dyad.totalaggXbin.longperturb <-dyad.totalaggXbin
glimpse(dyad.totalaggXbin)

unique(dyad.totalaggXbin$actor)
unique(dyad.totalaggXbin$subject)
length(unique(dyad.totalaggXbin$actor))
length(unique(dyad.totalaggXbin$subject))


## for bins with all 20 birds ----
bin20birds<- c(11, 14, 15,18,19 ,22) # rank_assessment: c(0, 1, 4, 5, 8, 9, 12)
dyad.totalaggXbin <- dyad.totalaggXbin.longperturb %>%
  filter(bin %in% bin20birds)

# change bird list
bird.list <- sort(unique(birdIDs$mark_id3)) # birdIDs$mark_id3 = all 20 birds
length(bird.list)
bird.list

# list of all possible dyads
dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")

unique(dyad.totalaggXbin$actor)
unique(dyad.totalaggXbin$subject)
length(unique(dyad.totalaggXbin$actor))
length(unique(dyad.totalaggXbin$subject))

## removal trial 1 ----
dyad.totalaggXbin <- dyad.totalaggXbin.longperturb %>%
  filter(bin %in% c(12,13)) # c(2,3)

birdIDs_removal1 <- birdIDs %>% filter(mark_id3!="BBB")

# change bird list
bird.list <- sort(unique(birdIDs_removal1$mark_id3)) # change each time
length(bird.list)
bird.list

# list of all possible dyads
dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")

unique(dyad.totalaggXbin$actor) # is BBB excluded?
unique(dyad.totalaggXbin$subject)
length(unique(dyad.totalaggXbin$actor))
length(unique(dyad.totalaggXbin$subject))


## removal trial 2 ----
dyad.totalaggXbin <- dyad.totalaggXbin.longperturb %>%
  filter(bin %in% c(16,17)) #c(6,7)

birdIDs_removal2 <- birdIDs %>% filter(mark_id3!="GPG")

# change bird list
bird.list <- sort(unique(birdIDs_removal2$mark_id3))
length(bird.list)
bird.list

# list of all possible dyads
dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")

unique(dyad.totalaggXbin$actor) # is GPG excluded?
unique(dyad.totalaggXbin$subject) 
length(unique(dyad.totalaggXbin$actor))
length(unique(dyad.totalaggXbin$subject))


## removal trial 3 ----
dyad.totalaggXbin <- dyad.totalaggXbin.longperturb %>%
  filter(bin %in% c(20,21)) #c(10,11)

birdIDs_removal3 <- birdIDs %>% filter(mark_id3!="OPP")

# change bird list
bird.list <- sort(unique(birdIDs_removal3$mark_id3)) 
length(bird.list)
bird.list

# list of all possible dyads
dyad.list <- expand.grid(bird.list, bird.list) #head(dyad.list)
names(dyad.list) <- c("actor", "subject")
dyad.list <- subset(dyad.list, actor!=subject)
dyad.list$dyadID <- paste(dyad.list$actor, dyad.list$subject, sep="-")

unique(dyad.totalaggXbin$actor) # is OPP excluded
unique(dyad.totalaggXbin$subject)
length(unique(dyad.totalaggXbin$actor))
length(unique(dyad.totalaggXbin$subject))


```

## observed dominance pattern

```{r Dominance pattern using crowds and displacements_ conservative, echo=FALSE}
# order date 
#head(dyad.totalaggXbin)
dyad.totalaggXbin<- dyad.totalaggXbin %>%
    arrange( bin, by_group = FALSE) 


# make empty data frame to put data in
strategies <- data.frame(run.code=character(),
                      focus=numeric(),
                      position=numeric(),
                      strategy=character())

# run = 1

start.time <- Sys.time()

loopby<-unique(dyad.totalaggXbin$bin)

i=1

for(i in seq_along(unique(dyad.totalaggXbin$bin))){
  run.code <- loopby[i]
  print(run.code)
  run.data <- subset(dyad.totalaggXbin, bin==run.code)
  
# number of dyads correct?
  #length(run.data$actor)
  #check <- sum.aggXday %>% filter(date==run.code)
  #head(check)
  
  data_alldyads <- merge(dyad.list, run.data, all.x=TRUE,
                       by=c("actor", "subject")) 
  
  #head(data_alldyads)
  #length(unique(data_alldyads$dyadID)) # with 21 birds should be 420 and with 22 462 dyads
  
  data_alldyads$date<-run.code
  
 #fill newly-merged data with 0's where no interactions
 data_alldyads[is.na(data_alldyads)] <- 0
  
   #print a check
  check <- length(data_alldyads$actor)
  print(check)

# matrix  
  mx <- reshape2::dcast(data_alldyads, actor~subject, value.var="n.aggXbin") #head(ref.behavior1.mx)
  mx[is.na(mx)] <- 0 #for linearity measure, matrix needs to be fully filled, no NAs
  mx <- matrix.please(mx)

  # ---- aggression strategy  
  # Compute focus & position
  focus <- dom_focus(mx)
  position <- dom_position(mx)
  fp <- cbind.data.frame(focus, position)
  colnames(fp) <- c("focus", "position")
  
  #Compute blur models
  blur <- dom_make_blur_data(mx)
  dom_plot_strategy(fp, blur) # plot aggression stategies
  
  #Find strategy
  strategy <- dom_categorize_strategy(data=fp, blur_data=blur)
  
  # --- combine dataframe
pool <-  cbind.data.frame(run.code, 
                         focus, 
                         position, 
                         strategy) 

strategies <- rbind(pool, strategies)

}

end.time <- Sys.time()

#Time to run:
end.time - start.time


```

```{r change each time}

#strategies_20birds <- strategies
#strategies_removal1 <- strategies
#strategies_removal2 <- strategies
#strategies_removal3 <- strategies

strategies_21exp <- bind_rows(strategies_20birds, 
                                    strategies_removal1,
                                    strategies_removal2,
                                    strategies_removal3)
strategies_21exp  <- strategies_21exp  %>%
  rename(bin=run.code) %>%
  arrange(bin) %>%
  mutate(dominance_pattern= if_else(strategy=="downward.heuristic", "downward heuristic","bullying"),
         year='2021') %>%
  dplyr::select(year, everything(), -strategy)
                                            

```

```{r}
# save file
write.csv(strategies_21exp, "output/dompatterns_21exp.csv")
```



## observed pattern changes

strategies take long to run, so import from file
```{r import strategies }

strategies <- read.csv("output/dompatterns_21exp.csv") %>%
  #dplyr::select(trial, bin,rank_assessment, perturbation, hours_observed,person_hours, dominance_pattern) %>%
  add_row( bin=25, dominance_pattern="close competitor") %>%
  mutate(rank = if_else(dominance_pattern=="downward heuristic", 1, 
                        ifelse(dominance_pattern=="bullying", 2, 3))) %>% 
  mutate(use = if_else(dominance_pattern=="downward heuristic", "A", 
                        ifelse(dominance_pattern=="bullying", "A", "B"))) %>% 
  mutate(observed_pattern = factor(dominance_pattern, 
                             levels =c(  "bullying", "close competitor","downward heuristic"))) #unique(dominance_pattern))

strategies$rank <-as.integer(strategies$rank)

strategies$dompattern <- factor(strategies$dominance_pattern, 
                                levels=c("downward heuristic", "bullying", "close competitor"), 
                                labels=c("DH", "B", "CC"))


```


before vs after removal
BBB: bin c(1,2)
GPG: bin c(5,6)
OPP: bin c(9,12)

before reintroduction vs upon reintroduction 
BBB: bin 13 and 14 # c(13,14) 
GPG: bin 17 and 18 # c(17,18)
OPP: bin 21 and 22 # c(21,22)

```{r}
# observed pattern change
obs_pattern_change <- strategies %>%
  dplyr::select( bin,  dompattern) %>%
  filter(!bin %in% c(25)) %>%
  mutate(obs_after=lead(dompattern),
         obs_pattern_change = paste(dompattern, obs_after, sep="-"))

## removal
binchange_removal <- c(11, 15, 19)

obs_pattern_change_removal <- obs_pattern_change %>%
  filter(bin %in% binchange_removal) %>%
  group_by(obs_pattern_change) %>%
  summarize(obs_n=length(obs_pattern_change), obs_prop = obs_n/3) %>% 
  rename(change=obs_pattern_change) %>%
  dplyr::select(-obs_n)


## reintroduction
binchange_reintro <- c(13, 17, 21)

obs_pattern_change_reintro <- obs_pattern_change %>%
  filter(bin %in% binchange_reintro) %>%
  group_by(obs_pattern_change) %>%
  summarize(obs_n=length(obs_pattern_change), obs_prop = obs_n/3) %>% 
  rename(change=obs_pattern_change) %>%
  dplyr::select(-obs_n)


```



# Figure: Effects of the perturbation of a key individual 

## Fig 1a) aggression rate controlled for person hours observed and group size

### observation hours
Total hours is calculated without pee breaks as observations continued. Calculate for
  total hours per bin

```{r observation hours X bin}

glimpse(hours_obs_raw)

hours_obs_raw$breaks[hours_obs_raw$breaks=="break"] <- "lunch"

## lubridate: hm(..., quiet = FALSE, roll = FALSE)
# obs_hours$start <-  hm(obs_hours$start)
# obs_hours$end <-  hm(obs_hours$end)

## total observation hours
hoursobs <- hours_obs_raw %>%
  right_join(bin_exp_dates, by="date") %>% # length(unique(hoursobs$date))
  filter(breaks %in% c("obs", "lunch")) %>%
  group_by(bin, breaks) %>%
  summarize(sum=sum(totaltime_hour)) %>%
  pivot_wider(names_from = breaks,
              values_from = sum) %>%
  mutate(hours_obs=obs-lunch) %>%
  dplyr::select(bin, hours_obs)


sum(hoursobs$hours_obs)

sumhoursobs <- hoursobs %>% 
  ungroup() %>%
  summarize(meanhoursobs=mean(hours_obs),
            sdhoursobs=sd(hours_obs),
            n=n(),
            se=sdhoursobs/sqrt(n))
```

We observed the birds during the social experiment for a total of 255.5 hours averaging 21.3 +- 2.3 hours (n = 12 bins) for each 3-day observation period. 


Person hours  (remove breaks and multiply observation hours by the number of observers)


```{r person hours X bin}

## person hours

# total over 4 observed (luncg already excluded)
sumperson <- hoursobs %>%
  mutate(sumperson=hours_obs*4)

# personal breaks
person_hoursXbin <- hours_obs_raw %>%
  right_join(bin_exp_dates, by="date") %>%
  filter(!subject %in% c("lunch","")) %>%
  group_by(bin) %>%
  summarise(breaks=sum(totaltime_hour)) %>%
  left_join(sumperson) %>%
  mutate(person_hours = sumperson-breaks)

sum(person_hoursXbin$person_hours)

## combine
obs.hours <- hoursobs %>% 
  left_join(person_hoursXbin) %>%
  dplyr::select(bin, hours_obs, person_hours ) 


```
255.5 hours and 940.3 person hours across 37 days, with an average of 21.3 Â± 2.3 (SD) hours of observation per three-day bin (n = 12 bins) 


### groups size and aggression rate X bin

```{r plot aggression controlled for group size and hours observed}


# total aggression
glimpse(sum.aggDCXbin_21exp)

# mean total of agonistic events observed per bin
summ_agXbin <- sum.aggDCXbin_21exp %>%
  summarize(mean_ag =mean(n.agg),
            sd_ag = sd(n.agg))

# mean and SD value
summ_ag_21exp <- sum.aggDCXbin_21exp %>% 
  left_join(bin_exp, by="bin") %>%
  left_join(obs.hours, by="bin")
summ_ag_21exp$n_birds<-as.numeric(summ_ag_21exp$n_birds)
summ_ag_21exp <-summ_ag_21exp %>%
  mutate(ag_bird= n.agg/n_birds, 
         ag_obs= n.agg/n_birds/hours_obs, 
         ag_person_obs = n.agg/n_birds/person_hours, 
         mean = mean(ag_obs),
         sd = sd(ag_obs),
         n=n(),
         se=sd/sqrt(n))

ave.ag.rate <- mean(summ_ag_21exp$ag_obs, na.rm = T)
sd.ag.rate <- sd(summ_ag_21exp$ag_obs, na.rm = T)

min(summ_ag_21exp$ag_obs, na.rm = T)
max(summ_ag_21exp$ag_obs, na.rm = T)

# person hours
# ave.ag.rate <- mean(summ_ag_21exp $ag_person_obs, na.rm = T)
# sd.ag.rate <- sd(summ_ag_21exp $ag_person_obs, na.rm = T)
# 
# min(summ_ag_21exp $ag_person_obs, na.rm = T)
# max(summ_ag_21exp $ag_person_obs, na.rm = T)

write.csv(summ_ag_21exp, "output/summ_agg2021social.csv")
```

### plot aggression rate

```{r}
plot_controlaggression_21exp <-  ggplot(summ_ag_21exp, aes(x = bin)) +
  # add average rate of aggression
  geom_hline(yintercept = ave.ag.rate, color = alpha("grey", 0.6), size=2) +
  
  # aggression / bird / hours observed
  geom_line(aes(y=ag_obs), size=1) + 
  geom_point(aes(y=ag_obs), size=3) +
  
  scale_y_continuous(limits=c(0.0, 6.0)) +
  scale_x_continuous(limits = c(11, 22),
                     breaks= c(11:22)) +
  
  theme_classic() +
  theme(legend.position="bottom",
         text = element_text(size=14),
         axis.text = element_text(size=12),
         axis.title.x = element_blank()) +
   #     axis.text.x = element_blank(),
    #    axis.ticks.x=element_line()) +
  labs(y="aggression rate") + #, title = "Amount of aggression controlled for group size and hours observed"
  
  geom_vline(xintercept = 11.5, linetype="dashed", color =  alpha("black", 0.6)) + # removal
  geom_vline(xintercept = 13.5, linetype="solid", color =  alpha("black", 0.6)) + # reintroduction
  geom_vline(xintercept = 15.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 17.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 19.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 21.5, linetype="solid", color =  alpha("black", 0.6)) 
  
  
 

plot_controlaggression_21exp 
```




## Fig 1b) dominance patterns

```{r plot patterns over time}

# dominance patterns experimental period
plot_strategies_21exp <- ggplot(strategies, 
                               aes(bin, dominance_pattern)) +
  geom_point(size = 6, shape = 21, colour = "black", aes(fill = dominance_pattern )) +
  labs(title = "", y="", x="social dominance pattern assessment points") + #title = "social dominance pattern"
  scale_fill_manual(values = c( "#0000FF","#C00000" , "#7F7F7F")) +
  theme_classic() + #theme_minimal() 
  theme(#axis.title = element_text(size=12, angle = 45), #element_blank()
        #axis.text.y =element_text(size=12, angle = 25), 
        legend.position = "none",
        text = element_text(size =16),
        axis.text = element_text(size=14),
        plot.margin = unit(c(1, 1, 0.5, 1), "cm")) +
  
  scale_x_continuous(limits = c(11, 22),
                     breaks= c(11,12,13,14,15,16,17,18,19,20,21,22)) +
  # scale_x_continuous(limits = c(0, 13),
  #                    breaks= c(0,1,2,3,4,5,6,7,8,9,10,11,12)) +
  
  # add lines to highlight removals and reintroductions
  geom_vline(xintercept = 11.5, linetype="dashed", color =  alpha("black", 0.6)) + # removal
  geom_vline(xintercept = 13.5, linetype="solid", color =  alpha("black", 0.6)) + # reintroduction
  geom_vline(xintercept = 15.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 17.5, linetype="solid", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 19.5, linetype="dashed", color =  alpha("black", 0.6)) +
  geom_vline(xintercept = 21.5, linetype="solid", color =  alpha("black", 0.6)) 

plot_strategies_21exp

```


## combine plots

```{r combine plots }

# combine plots
  ggarrange(plot_controlaggression_21exp, plot_strategies_21exp, 
            nrow=2, ncol=1, align = "hv",
            labels = c("(a)", "(b)")
            ) # legend = "bottom", label.x = 0.15, label.y=0.85

  ggsave("./figures/plot_Fig2021_exp_v3.pdf",  width= 175, height=125, units="mm")
        # width= 7, height=7, units="in") # full page  width= 7, height=11, units="in") # half page width= 125, height=250, units="mm"
```

https://rdrr.io/cran/ggbump/man/geom_bump.html



# Reference model: randomise patterns
Permute social dominance pattern points 
  -> How unusual is it that the group keeps the same strategy after removal? 
  -> How unusual is the change from downward heuristic to a bullying strategy   
     upon reintroduction?

-	Change order of the data points
- calculate percent time change bullying strategy from bin 13-14, bin 17-18, bin 21-22 -> per trial, then summarize
- comparisons: 
  1) before vs after removal
  2) before vs after reintroduction


```{r randomise strategies}

# randomise dom patterns -----
# Step 1: create new df
s.pattern <- strategies %>%
  dplyr::select(bin, dompattern) %>%
  filter(!bin %in% c(25)) %>%
  rename(observed_pattern=dompattern)


# Step 2: create loop to get 1000 randomised patterns
random_patterns <- data.frame(runID =numeric(),
                              bin=numeric(),
                              oberved_pattern=character(),
                              random_pattern=character())

replicates <- 1000

for(run in 1:replicates){
 r.seed <- run
 set.seed(r.seed)

# create random distribution dominance patterns
  s.pattern$runID <- rep(paste0("run",str_pad(r.seed, 4, side="left", pad = "0")))
	
  samplepat <- sample(1:length(s.pattern$observed_pattern))
	samplepat
	s.pattern$random_pattern <- s.pattern$observed_pattern[samplepat]

  random_patterns <- rbind.data.frame(random_patterns, s.pattern)
  
}


## check ref model output

#check that the randomized interactions vary from the observed patterns
random_patterns$observed_pattern == random_patterns$random_pattern

#check that runs are different from each other
head(subset(random_patterns, runID=="run0001"))
head(subset(random_patterns, runID=="run0002"))
head(subset(random_patterns, runID=="run0003"))
head(subset(random_patterns, runID=="run0011"))
head(subset(random_patterns, runID=="run0100"))

#check that all runs ran as expected
unique(random_patterns$runID)
length(unique(random_patterns$runID))


# Step 3: Calculate how often we see the same strategies or a change to bullying 

before_after <- random_patterns %>% 
  dplyr::select(runID, bin, observed_pattern, random_pattern) %>%

  # observed pattern change 
  rename(obs_before = observed_pattern) %>%
  group_by(runID) %>%
  mutate(obs_after = lead(obs_before)) %>%
  #drop_na() %>%
  mutate(obs_pattern_change = paste(obs_before, obs_after, sep="-")) %>%

# randomized pattern change
  rename(random_before = random_pattern) %>%
  group_by(runID) %>%
  mutate(random_after = lead(random_before)) %>%
  mutate(random_pattern_change = paste(random_before, random_after, sep="-")) %>%
  drop_na() %>%
  
  
  dplyr:: select(runID, bin, obs_pattern_change,  random_pattern_change)

#write.csv(before_after, "output/dompattern_random.csv")

glimpse(before_after)

```

## Transition proportion by trial (summary)

### removal averaged
```{r removal by trial}

## before removal vs after removal ----
# observed pattern change from downward heuristic to downward heuristic for trial 1 and 3 (bin 11->12,  bin 19->20), from bullying to bullying for trial 2 (bin 15 ->bin16) 

# per trial
rand_summ_removal1 <- before_after %>%
  filter(bin==1) %>%
  group_by(random_pattern_change) %>%
  summarise(random_n=length(random_pattern_change), random_prop = random_n/1000) %>%  # 3 trials each with 1000 randomized values
  rename(change=random_pattern_change) %>%
  #dplyr::select(-random_n) %>%
  mutate(prop=round(random_prop, 2),
         trial=1
         ) %>%
  dplyr::select(-random_prop)

rand_summ_removal2 <- before_after %>%
  filter(bin==5) %>%
  group_by(random_pattern_change) %>%
  summarise(random_n=length(random_pattern_change), random_prop = random_n/1000) %>%  # 3 trials each with 1000 randomized values
  rename(change=random_pattern_change) %>%
  #dplyr::select(-random_n) %>%
  mutate(prop=round(random_prop, 2),
         trial=2
         ) %>%
  dplyr::select(-random_prop)

rand_summ_removal3 <- before_after %>%
  filter(bin==9) %>%
  group_by(random_pattern_change) %>%
  summarise(random_n=length(random_pattern_change), random_prop = random_n/1000) %>%  # 3 trials each with 1000 randomized values
  rename(change=random_pattern_change) %>%
  #dplyr::select(-random_n) %>%
  mutate(prop=round(random_prop, 2),
         trial=3
         ) %>%
  dplyr::select(-random_prop)


# combine
rand_summ_removal <- bind_rows(rand_summ_removal1,
                               rand_summ_removal2,
                               rand_summ_removal3) 

rand_removal <- rand_summ_removal %>%
  group_by(change) %>%
  summarize(aveprop=mean(prop),
            sdprop=sd(prop),
            n=sum(random_n),
            se=sdprop/sqrt(n)) %>%
  mutate(prop=round(aveprop, 2),
         sd=round(sdprop, 2))



```

#### Fig 2a) removal


```{r dom pattern randomizations_removal}

## random 
glimpse(rand_removal)
  
# create matrix
r_removal <- rand_removal %>% 
  separate(change, into = c("before", "after"), sep="-") 

mx_r_r <- reshape2::dcast(r_removal, before~after, value.var="prop") #head(ref.behavior1.mx)
r.removal.mx <- matrix.please(mx_r_r)

# set line widtth
curves <- matrix(nrow=ncol(r.removal.mx),ncol=ncol(r.removal.mx),0)
curves[1,1]<- (r.removal.mx[1,1]*10)+1       
curves[1,2]<- (r.removal.mx[1,2]*10)+1 
curves[2,2]<- (r.removal.mx[2,2]*10)+1  
curves[2,1]<- (r.removal.mx[2,1]*10)+1 

 
# plot transition diagram  
pdf("./figures/plot_mean_random_removal.pdf")  # open and save the pdf file
plotmat(r.removal.mx, 
        #pty="s",
        #pos=c(1,1),
        
        # lines
         box.lwd=1, lwd=curves, self.lwd=c(2.3,4.5), #self.lwd=curves,
        
        # boxes
        box.cex=0.8, box.size=0.065 ,
        box.type="rect", # "circle", "ellipse", "diamond", "rect", "round", "hexa", "multi", "none"
        box.prop=1, box.col = c("#0000FF", "#7F7F7F"),
        shadow.size = 0.0, 
        my=0, mx=0.0, # vertical and horizontal shift of boxes, respecitvely 
        
        # self 
        relsize=0.7, # rel size to box
        self.shiftx=c(.1, -0.1), self.shifty=c(-0.1, 0.1), 
        
        # arrow
        #arr.lwd = c(1, 2,3),
        #arr.length = 2,
        curve = 0.125,
     
        # text
        cex.txt=0.8, txt.col = "white",
        main = " random pattern change before and after removal")
dev.off() # Close the pdf file



## observed 
glimpse(obs_pattern_change_removal)

obs_pattern_change_removal <- obs_pattern_change %>%
  filter(bin %in% binchange_removal) %>%
  group_by(obs_pattern_change) %>%
  summarize(obs_n=length(obs_pattern_change), obs_prop = obs_n/3) %>% 
  rename(change=obs_pattern_change) %>%
  mutate(prop=round(obs_prop, 2)) %>%
  dplyr::select( -obs_n,-obs_prop)

# create matrix
obs_removal <- obs_pattern_change_removal %>% 
  separate(change, into = c("before", "after"), sep="-") 

mx <- reshape2::dcast(obs_removal, before~after, value.var="prop") 
obs.removal.mx <- matrix.please(mx)
obs.removal.mx[is.na(obs.removal.mx)] <- 0

# set line width
linewidth <- matrix(nrow=ncol(obs_pattern_change_removal),ncol=ncol(obs_pattern_change_removal),0)
linewidth[1,1]<- (obs.removal.mx[1,1]*10)+1       
linewidth[1,2]<- (obs.removal.mx[1,2]*10)+1 
linewidth[2,2]<- (obs.removal.mx[2,2]*10)+1  
linewidth[2,1]<- (obs.removal.mx[2,1]*10)+1  


# plot transition matrix
pdf("./figures/plot_obs_removal_updated.pdf")  # open and save the pdf file
plotmat(obs.removal.mx, 
        #pty="s",
        #pos=c(1,1),
        
        # lines
        box.lwd=1, lwd=linewidth, #lcol=c( "#0000FF", "#7F7F7F"), 
        
        # boxes
        box.cex=0.8, box.size=0.065 ,box.type="rect", # "circle", "ellipse", "diamond", "rect", "round", "hexa", "multi", "none"
        box.prop=1, box.col = c("#0000FF", "#7F7F7F"),
        shadow.size = 0.0, 
        my=0, mx=0.0, # vertical and horizontal shift of boxes, respecitvely 
        
        # self 
        relsize=0.7, self.lwd=c(4.3,4.3), #self.lwd = linewidth, 
        self.shiftx=c(.1, -0.1), self.shifty=c(-0.1, 0.1), 
        
        # arrow
        #arr.lwd = c(1, 2,3),
        #arr.length = 2,
        curve = 0.125,
     
        # text
        cex.txt=0.8, txt.col = "white",
        main = " observed pattern change before and after removal"
        )
dev.off() # Close the pdf file



```

### reintroduction averaged
```{r reintroduction by trial}

# per trial 
rand_summ_reintro1 <- before_after %>%
  filter(bin==3) %>%
  group_by(random_pattern_change) %>%
  summarise(n=length(random_pattern_change), random_prop = n/1000) %>% # 3 trials with 1000 randomized values
  rename(change=random_pattern_change) %>%
  mutate(prop=round(random_prop, 2),
         trial=1) %>%
  dplyr::select(-random_prop)

rand_summ_reintro2 <- before_after %>%
  filter(bin==7) %>%
  group_by(random_pattern_change) %>%
  summarise(n=length(random_pattern_change), random_prop = n/1000) %>% # 3 trials with 1000 randomized values
  rename(change=random_pattern_change) %>%
  mutate(prop=round(random_prop, 2),
         trial=2) %>%
  dplyr::select(-random_prop)


rand_summ_reintro3 <- before_after %>%
  filter(bin==11) %>%
  group_by(random_pattern_change) %>%
  summarise(n=length(random_pattern_change), random_prop = n/1000) %>% # 3 trials with 1000 randomized values
  rename(change=random_pattern_change) %>%
  mutate(prop=round(random_prop, 2),
         trial=3) %>%
  dplyr::select(-random_prop)

# combine
rand_summ_reintro <- bind_rows(rand_summ_reintro1,
                               rand_summ_reintro2, 
                               rand_summ_reintro3)

rand_reintro <- rand_summ_reintro %>%
  group_by(change) %>%
  summarize(aveprop=mean(prop),
            sdprop=sd(prop),
            n=sum(n),
            se=sdprop/sqrt(n)) %>%
  mutate(prop=round(aveprop, 2),
         sd=round(sdprop, 2))
```

#### Fig 2c) reintro

```{r dom pattern randomizations_reintro}

# reintroduction

## random 
glimpse(rand_reintro)

# create matrix
r_reintro <- rand_reintro  %>% 
  separate(change, into = c("before", "after"), sep="-") 

r_reintro_mx <- reshape2::dcast(r_reintro, before~after, value.var="prop") #head(ref.behavior1.mx)
r.reintro.mx <- matrix.please(r_reintro_mx )

# set line widtth
r.lwd.reintro <- matrix(nrow=ncol(r.reintro.mx ),ncol=ncol(r.reintro.mx),0)
r.lwd.reintro[1,1]<- (r.reintro.mx[1,1]*10)+1       
r.lwd.reintro[1,2]<- (r.reintro.mx[1,2]*10)+1 
r.lwd.reintro[2,2]<- (r.reintro.mx[2,2]*10)+1  
r.lwd.reintro[2,1]<- (r.reintro.mx[2,1]*10)+1 


# transition diagram
pdf("./figures/plot_mean_random_reintro.pdf")  # open and save the pdf file
plotmat(r.reintro.mx, 
        #pty="s",
        #pos=c(1,1),
        
        # lines
         box.lwd=1, lwd=r.lwd.reintro, 
         self.lwd=c(1.8,3.4), #self.lwd=curves,
        
        # boxes
        box.cex=0.8, box.size=0.065 ,box.type="rect", # "circle", "ellipse", "diamond", "rect", "round", "hexa", "multi", "none"
        box.prop=1, box.col = c("#0000FF", "#7F7F7F"),
        shadow.size = 0.0, 
        my=0, mx=0.0, # vertical and horizontal shift of boxes, respecitvely 
        
        # self 
        self.shiftx=c(.1, -0.1), self.shifty=c(-0.1, 0.1), 
        relsize=0.7, 
        
        # arrow
        #arr.lwd = c(1, 2,3),
        #arr.length = 2,
        curve = 0.125,
     
        # text
        cex.txt=0.8, txt.col = "white",
        main = " random pattern change before and after reintroduction")
dev.off()  


## observed 
glimpse(obs_pattern_change_reintro) 
# DH_B = 1.00, all others 0


obs_reintro <- obs_pattern_change_reintro %>% 
  separate(change, into = c("before", "after"), sep="-") 
obs_reintro 

# create matrix
obs.reintro.mx <- matrix(nrow=ncol(obs_pattern_change_reintro),ncol=ncol(obs_pattern_change_reintro),0)
obs.reintro.mx[1,1]<- obs.reintro.mx[1,2]<- obs.reintro.mx[2,2]<- 0.00
obs.reintro.mx[2,1]<- 1.00
obs.reintro.mx

rownames(obs.reintro.mx) <- c("B", "DH")
colnames(obs.reintro.mx) <- c("B", "DH")

obs.reintro.mx

# set line width
linewidth_reintro <- matrix(nrow=ncol(obs_pattern_change_reintro),ncol=ncol(obs_pattern_change_reintro),0)
linewidth_reintro[1,1]<- (obs.reintro.mx[1,1]*10)+1       
linewidth_reintro[1,2]<- (obs.reintro.mx[1,2]*10)+1 
linewidth_reintro[2,1]<- (obs.reintro.mx[2,1]*10)+1  
linewidth_reintro[2,2]<- (obs.reintro.mx[2,2]*10)+1 
linewidth_reintro
 
# create transition diagram
pdf("./figures/plot_obs_reintro.pdf")  # open and save the pdf file
plotmat(obs.reintro.mx, 
        #pty="s",
        #pos=c(1,1),
        
        # lines
        box.lwd=1, lwd=linewidth_reintro, 
        #self.lwd=c(0,10),
        
        # boxes
        box.cex=0.8, box.size=0.065 ,
        box.type="rect", # "circle", "ellipse", "diamond", "rect", "round", "hexa", "multi", "none"
        box.prop=1, box.col = c("#0000FF", "#7F7F7F"),
        shadow.size = 0.0, 
        my=0, mx=0.0, # vertical and horizontal shift of boxes, respecitvely 
        
        # self 
         relsize=0.7,  
        self.shiftx=c(.1, -0.1), self.shifty=c(-0.1, 0.1), 
        
        # arrow
        #arr.lwd = c(1, 2,3),
        #arr.length = 2,
        curve = 0.125,
     
        # text
        cex.txt=0.8, txt.col = "white",
        main = " observed pattern change before and after reintroduction"
        )
dev.off()


```
arrow directions are in the wrong direction! 



## Proportion changes by run across 3 trials (raw data)
### removal by run
```{r removal by run}

## before removal vs after removal ----
# observed pattern change from bullying to downward heuristic (trial 1, bin 11->12), downward heuristic to downward heuristic for trial  3  (bin 19->20), from bullying to bullying for trial 2 (bin 15 ->bin16) 

# per run
rand_removalXrun <- before_after %>%
  filter(bin %in% c(1,5,9)) %>%
  group_by(runID, random_pattern_change) %>%
  summarise(n_trials=length(random_pattern_change)) %>%  # 3 trials
  rename(change=random_pattern_change) #%>%
  #dplyr::select(-random_n) %>%
  #mutate(prop=round(random_prop, 2)) %>%
  #dplyr::select(-random_prop)

pattern_changes <- sort(unique(before_after$obs_pattern_change))
pattern_changes <- as.data.frame(pattern_changes)
pattern_changes <- pattern_changes %>%
  rename(change = "pattern_changes") 

# include all possible patterns

# make empty data frame to put data in
rand_removalXrun_all <- data.frame(runID=character(),
                      change=character(), 
                      random_n=numeric(),
                      prop=numeric())

loopby <- unique(rand_removalXrun$runID)

for(i in seq_along(loopby)){
  run.code <- loopby[i]
  #print(run.code)
  run.data <- subset(rand_removalXrun, runID==run.code)
  
  data_allpatterns <- merge(pattern_changes, run.data, all.x=TRUE,
                       by=c("change")) 

  data_allpatterns$runID<-run.code
  
 #fill newly-merged data with 0's where no patterns
 data_allpatterns[is.na(data_allpatterns)] <- 0
 
 # check
 sum(data_allpatterns$random_n) # should total 3 trials
  
   # combine in dataframe
  rand_removalXrun_all<-rbind(rand_removalXrun_all, data_allpatterns)
}

glimpse(rand_removalXrun_all)

# calculate proportion 
rand_removalXrun_all<- rand_removalXrun_all %>%
  mutate(random_prop = n_trials/3)  # raw data of the 3 trials of the averaged summary  (the following provides different info; length(pattern_changes$change) -> moved to supplemental)

glimpse(rand_removalXrun_all)


# summarize
summ_rand_removal <- rand_removalXrun_all %>%
  group_by(change, random_prop) %>%
  summarise(total=length(runID), 
            p.value=total/1000)

# How many runs do we see same pattern as observed? 
obs.vs.rand_removal <- before_after %>%
  filter(bin %in% c(1,5,9)) %>%
  group_by(runID) %>%
  mutate(similar_pattern= if_else(obs_pattern_change==random_pattern_change,"yes", "no")) %>%
  group_by(runID,similar_pattern) %>%
  summarize(n=length(similar_pattern))
  
summ_obs.vs.rand_removal  <- obs.vs.rand_removal %>%
  filter(similar_pattern=="yes", n==3) 
total_runs_same_removal <- length(summ_obs.vs.rand_removal$runID)/length(unique(before_after$runID))*100

```
2.9% of the runs showed the same pattern changes for all three trials as the observed pattern changes

#### Fig 2b) removal
Calculate distribution of pattern changes and confidence intervals per run. So we get 1000 proportion values. 

If observed pattern change falls outside reference model values, a change from downward heuristic to bullying is different from random. 

trial 1: bullying - downward heuristic  -> 0.33
trial 2: bullying - bullying            -> 0.33
trial 3: downward heuristic - downward heuristic -> 0.33
of 3 trials

```{r}

glimpse(rand_removalXrun_all)
glimpse(summ_rand_removal)

rand_removalXrun_all <- rand_removalXrun_all %>%
  mutate(pattern_change = factor(change, levels=c("DH-DH", "DH-B", "B-DH", "B-B"),
                                 labels = c("downward heuristic - downward heuristic",
                                            "downward heuristic - bullying",
                                            "bullying - downward heuristic",
                                            "bullying - bullying")))
#summ_rand_removalXrun_all <- rand_removalXrun_all %>%
#  group_by(change, random_prop) %>%
#  summarize(n=length(runID),
#            prop=n/1000)


 plot_removal_dist <-  ggplot(rand_removalXrun_all, aes(x = random_prop, y = change, fill = change)) +
  geom_density_ridges( stat="binline",bins=8.5, scale=0.8, draw_baseline = F, center = 0) + #alpha=0.6, binwidth=1
  theme_ridges(#font_size = 12,
    #font_family = "",
   line_size = 0.01,
   # grid = FALSE,
    center_axis_labels = FALSE) + #grid=FALSE
  theme(
      legend.position="bottom",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8),
      axis.title.x = element_text(hjust = 0.5)
      #axis.title.y = element_text(hjust = 0.5)
    ) +
    xlab("proportion of runs") +
    ylab("") +
    scale_fill_manual(values = c("#0000FF", "#b3b0e3", "#deebf7", "#7F7F7F")) + #"#C00000" ,
   scale_x_continuous( expand = c(0, 0),limits = c(-0.1,1.2),
                       breaks = c(0.00, 0.33, 0.66, 1.00)) +
   scale_y_discrete(expand = expansion(mult = c(0.0, .3))) +
   
  # include observed proportion
  geom_segment(y=2, yend=2.8, x = 0.33, xend=0.33, size=1,  color="red") + # trial 1
  geom_segment(y=1, yend=1.8, x = 0.33, xend=0.33, size=1,  color="red") + # trial 2 #linetype = "dashed",
  geom_segment(y=4, yend=5, x = 0.33, xend=0.33, size=1,  color="red") +  # trial 3
  
  #geom_segment(y=1, yend=5, x = 1, xend=1, size=1,  color="white") +
   coord_cartesian(clip = "off") 
plot_removal_dist 


ggsave("figures/fig.2b_dist_removal_random.pdf", width = 2.5, height = 3)


total_rand_removal <- summ_rand_removal %>%
  group_by(change) %>%
  summarize(sum=sum(total))

plot_removal_bar <- ggplot(summ_rand_removal, aes(x=change, y=p.value, fill=as.factor(random_prop))) +
  geom_bar(stat = "identity" , position="dodge") +
  coord_flip() +
  ylab("proportion of runs") +
  xlab("") +
  scale_fill_viridis(discrete=TRUE, name="") +
  theme_classic()
plot_removal_bar

```





### reintroduction by run
```{r reintroduction by run}

# per run
rand_reintroXrun <- before_after %>%
  filter(bin %in% c(3,7,11)) %>%
  group_by(runID, random_pattern_change) %>%
  summarise(n_trials=length(random_pattern_change)) %>%  # 3 trials
  rename(change=random_pattern_change) #%>%
  #dplyr::select(-random_n) %>%
  #mutate(prop=round(random_prop, 2)) %>%
  #dplyr::select(-random_prop)

pattern_changes <- sort(unique(before_after$obs_pattern_change))
pattern_changes <- as.data.frame(pattern_changes)
pattern_changes <- pattern_changes %>%
  rename(change = "pattern_changes") 

# include all possible patterns

# make empty data frame to put data in
rand_reintroXrun_all <- data.frame(runID=character(),
                      change=character(), 
                      random_n=numeric(),
                      prop=numeric())

loopby <- unique(rand_reintroXrun$runID)

for(i in seq_along(loopby)){
  run.code <- loopby[i]
  #print(run.code)
  run.data <- subset(rand_reintroXrun, runID==run.code)
  
  data_allpatterns <- merge(pattern_changes, run.data, all.x=TRUE,
                       by=c("change")) 

  data_allpatterns$runID<-run.code
  
 #fill newly-merged data with 0's where no patterns
 data_allpatterns[is.na(data_allpatterns)] <- 0
 
 # check
 sum(data_allpatterns$random_n) # should total 3 trials
  
   # combine in dataframe
  rand_reintroXrun_all<-rbind(rand_reintroXrun_all, data_allpatterns)
}

glimpse(rand_reintroXrun_all)

# calculate proportion 
rand_reintroXrun_all<- rand_reintroXrun_all %>%
  mutate(random_prop = n_trials/3) # 3 trials instead of 4 possible pattern changes (length(pattern_changes$change))


# summarize
summ_rand_reintro <- rand_reintroXrun_all %>%
  group_by(change, random_prop) %>%
  summarise(total=length(runID), 
            p.value=total/1000)


# How many runs do we see same pattern as observed? 
obs.vs.rand_reintro <- before_after %>%
  filter(bin %in% c(3,7,11)) %>%
  group_by(runID) %>%
  mutate(similar_pattern= if_else(obs_pattern_change==random_pattern_change,"yes", "no")) %>%
  group_by(runID,similar_pattern) %>%
  summarize(n=length(similar_pattern))
  
summ_obs.vs.rand_reintro <- obs.vs.rand_reintro %>%
  filter(similar_pattern=="yes", n==3) 
total_runs_same_reintro <- length(summ_obs.vs.rand_reintro$runID)/length(unique(before_after$runID))*100

total_runs_same_reintro 
```
2.6% of the runs showed the same pattern changes for all three trials as the observed pattern changes


#### Fig 2d) reintro
Calculate distribution of pattern changes and confidence intervals per run. So we get 1000 proportion values. 

If observed pattern change falls outside reference model values, a change from downward heuristic to bullying is different from random. 

observed pattern changes:
3x downward heuristic - bullying -> 1
of 4 potential pattern changes

dh -b 1

```{r}
glimpse(rand_reintroXrun_all)



rand_reintroXrun_all <- rand_reintroXrun_all %>%
  mutate(pattern_change = factor(change, levels=c("DH-DH", "DH-B", "B-DH", "B-B"),
                                 labels = c("downward heuristic - downward heuristic",
                                            "downward heuristic - bullying",
                                            "bullying - downward heuristic",
                                            "bullying - bullying")))

plot_reintro_dist <- ggplot(rand_reintroXrun_all, aes(x = random_prop, y = change, fill = change)) +
  #stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.025, 0.975), alpha = 0.7) 
  #geom_density_ridges2() 
  # geom_density_ridges(
  #  jittered_points = TRUE, quantile_lines = TRUE, scale = 0.9, alpha = 0.7,
  #  vline_size = 1, vline_color = "red",
  #  point_size = 0.4, point_alpha = 1,
  #  position = position_raincloud(adjust_vlines = TRUE)
  #)
  #stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.025, 0.975), alpha = 0.7) +
  geom_density_ridges( stat="binline", bins=8.5, scale=0.8, draw_baseline = F) + #alpha=0.6,
   theme_ridges(#font_size = 12,
    #font_family = "",
   line_size = 0.01,
   # grid = FALSE,
    center_axis_labels = FALSE) + #grid=FALSE
  theme(
      legend.position="bottom",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8),
      axis.title.x = element_text(hjust = 0.5)
      #axis.title.y = element_text(hjust = 0.5)
    ) +
   scale_fill_manual(values = c("#0000FF", "#b3b0e3", "#deebf7", "#7F7F7F")) + #"#C00000" ,
   scale_x_continuous( expand = c(0, 0),limits = c(-0.1,1.2),
                       breaks = c(0.00, 0.33, 0.66, 1.00)) +
   scale_y_discrete(expand = expansion(mult = c(0.0, .3))) +
    xlab("Pattern transition proportions") +
    ylab("") +
   
     # include observed proportion
  geom_segment(y=3, yend=3.8, x = 1, xend=1, size=1,  color="red")  # trial 1, 2, 3

plot_reintro_dist
ggsave("figures/fig.2d_dist_reintro_random.pdf", width = 2.5, height = 3)

```




# Aggression networks

join dominance scores to dyad aggression dataframe for both actor and subject

Structure of hierarchy:
- % of fights rule breakers vs rule followers

plot aggression network by dominance rank on y-axis and jitter on x-axis. One convenient way to adjust node coordinates is to plot with tkplot first, handtune the placement of the vertices, query the coordinates by the tk_coords function and use them with plot to plot the graph to any R device.

## bin selection
before vs after removal
BBB: bin c(1,2)
GPG: bin c(5,6)
OPP: bin c(9,10)

before reintroduction vs upon reintroduction 
BBB: bin  c(3,4) 
GPG: bin  c(7,8)
OPP: bin  c(11,12)
```{r}
bin19birds <- c(2,3,6,7,10,11) # include removed focal bird in matrix with 0's
bin20birds <- c(1,4,5,8,9,12)

# per trial and period separate -> differently colored focals compared to the rest of the birds
bintrial1_focal <- c(1,4)
bintrial1_nofocal <- c(2,3)
bintrial2_focal <- c(5,8)
bintrial2_nofocal <- c(6,7)
bintrial3_focal <- c(9,12)
bintrial3_nofocal <- c(10,11)

```

## prepare rank dataframe
```{r}
glimpse(ec_rankXbin)
range(ec_rankXbin$dom_ec)

# change bins
bins <- bin.dates %>%
  dplyr::select(bin, rank_assessment) %>%
  drop_na() %>%
  mutate(bin=as.integer(bin)) %>%
  group_by(bin) %>%
  slice(1)

ec_rank<- ec_rankXbin %>%
  left_join(bins) %>% 
  dplyr::select(-bin) %>%
  rename(bin=rank_assessment) %>%
  mutate(power=1-dom_ec,
         bin=as.factor(bin)) %>%
  dplyr::select(bin, id,power, dom_ec, rank)
  
glimpse(ec_rank)

```

## create edge list
change bin each time as the loop didn't work
```{r}
# check data
glimpse(dyad.totalaggXbin)
sum(dyad.totalaggXbin$n.aggXbin)
unique(dyad.totalaggXbin$subject)
length(unique(dyad.totalaggXbin$actor))
length(unique(dyad.totalaggXbin$subject))
sort(unique(dyad.totalaggXbin$bin))

dyad.totalaggXbin$bin <- as.factor(dyad.totalaggXbin$bin)

# combine dom_ec and rank to edge  dataframe
attrib_edge <- dyad.totalaggXbin %>%
  dplyr::select(-X) %>%
  #filter(bin %in% bintrial2_nofocal) %>%   # change 
  filter(bin==8) %>%
  #slice(rep(seq_len(n()), n.aggXbin)) %>%  # transform to edge list
  #mutate(weight = 1) %>%
  dplyr::rename(id=actor, weight=n.aggXbin) %>% 
  left_join(ec_rank, by=c("id", "bin")) %>% 
  dplyr::rename(actor=id, actor_power=power, actor_domec=dom_ec, actor_rank=rank) %>%
  dplyr::rename(id=subject) %>%
  left_join(ec_rank, by=c("id", "bin")) %>%
  dplyr::rename(subject=id, subject_power=power, subject_domec=dom_ec, subject_rank=rank) %>%
  mutate(rule = if_else(actor_rank < subject_rank, "follower", "breaker"),# low dom_ec/rank = higher ranking
         color= if_else(rule=="breaker", "#f03b20","#2c7fb8")) %>% #"#dc8580", "#83b2d0" -> too dull
  arrange(-actor_power) 
glimpse(attrib_edge)
```

## visualize aggression networks

### network graph (20 birds)


First, for all 20 birds, where focals are highlighted
bin20birds <- c(1,4,5,8,9,12)

```{r aggression network 20 birds (highlight focal)}
  # choose bin
  run.code<-sort(unique(attrib_edge$bin))
  run.code
  
  # create graph from dataframe
 gdf <- graph.data.frame(attrib_edge)
 
  # create layout
 ## add rank 
 power_plot <- ec_rank %>% 
  filter(bin==run.code) %>%
  left_join(attrib_node) %>%
  dplyr::select(id, sex, power, rank) %>%
  arrange(-power) # changed to descending order rank instead of alphabethical order
 
 range(ec_rank$power)
 #range_ec_GPG <- range(ec_rank$dom_ec)

  treelayout <- layout_as_tree(gdf)  #V1=x, V2=y
  treelayout

  # change per bin
  ## change y axis to represent highest ranking on top of the netwwork
  ec_lay <- cbind(treelayout, power_plot$power) # observed ec rank 
  ec_lay<-ec_lay[,-2] # delete column 2

  ## change x axis to provide jitter of nodes
  #jitter<- c(0,-4,-5,1,2,3,0.5,3.5,-1.5,-3,-4,5,1.5,-2,2.5,5,-3.5,-1,-2.5,4.5,4)
  jitter20<- c(0,2,0.5,-3,-2,4,2.5,-4,3.5,-1,4.5,3,-4,-5,-0.5,-3,5,1,-2.5, 0) # diamond shape
  ec_lay <- cbind(jitter20, ec_lay)
  ec_lay<-ec_lay[,-2] # delete column 2
  #colnames(ec_lay) <- c("V1", "V2")

  
## set edge color
E(gdf)$rule <- as.character(attrib_edge$rule)
# unique(bin.data$color)
#E(gdf)$rule <- adjustcolor(as.character(bin.data$color),alpha=.6)

## add vertex/node attribute
V(gdf)$name <- power_plot$id
V(gdf)$dom <- power_plot$power # now we have to reverse y-axis
V(gdf)$sex <- power_plot$sex

## set node color  
# all green during removal period focals
#V(gdf)$fill <- c(alpha("#b8d79c", 1)) # all birds green

# highlight focal; "#1f78b4" for BBB; "#33a02c" for GPG; "#ff7f00" for OPP
#V(gdf)$fill<- c( alpha("#b8d79c", 1), "#1f78b4")[1+(V(gdf)$name=="BBB")]
V(gdf)$fill<- c(alpha("#b8d79c", 1), "#6a51a3")[1+(V(gdf)$name=="GPG")]  # "#6a51a3" -> PURPLE & "#33a02c" -> DARK GREEN
#V(gdf)$fill<- c( alpha("#b8d79c", 1), "#ff7f00")[1+(V(gdf)$name=="OPP")] # "#ff7f00" -> orange & 


 # plot graph
 #library(ggraph); class(gdf); gdf

set.seed(42)

# layout
layout <- create_layout(gdf, layout=ec_lay)
head(layout)


# plot

p8 <-
  ggraph(gdf, layout = ec_lay) +
  
  # --- edges
  # geom_edge_link0(aes(edge_width = weight), edge_colour = E(gdf)$color) + # edges going in multiple directions are overlapped
  geom_edge_fan(aes(edge_width = weight, 
                    colour=rule,
                    alpha = 0.6 # ..index..
                    ), 
                strength = 0.05) + # 0.05; curved edges. strength > 1 will create wider fans while the reverse will make them more narrow. If there are no parallel edges it behaves like geom_edge_link() and draws a straight line, but if parallel edges exists it will spread them out as arcs with different curvature.
  #scale_edge_alpha('Edge direction', guide = 'edge_direction') + # have to include ..index..instead of alpha 0.6 to create gradient
  scale_y_continuous(limits = c(0.82, 1.0), breaks = c(0.85,0.90, 0.95, 1.00) ) +
  scale_edge_width_continuous(range = c(0.2,3)) + 
  scale_edge_colour_manual(values = c("#f03b20", "#2c7fb8")) +
  
  # --- nodes
  geom_node_point(aes( shape= sex,
                       fill = as.factor(layout$fill),
                       color = "white", size=10)) + 
  # highlight focal; "#1f78b4" for BBB; green("#33a02c") or purple (alpha("#7030A0", 0.6) for GPG; "#ff7f00" for OPP
  scale_fill_manual(name = "fill",
                     values=  c("#6a51a3", alpha("#b8d79c", 1))) + #c(  "#1f78b4", alpha("#b8d79c", 1)) /  "#6a51a3" GPG / alpha("#b8d79c", 1), "#ff7f00") OPP
  scale_color_manual(values="white") +
  scale_shape_manual( name = "sex", 
                      values = c( 21, 23 ), #c( 21, 23 )  19, 17 
                      labels = c( "female", "male" )) +
  #geom_node_text(aes(label = layout$name), size=3) + #, , size=2 # bird names
  
  # --- layout
  #scale_size_continuous(range = c(1,6))+
  theme_graph()+ 
  labs(y="Power score" ) +
  ggtitle(paste("bin",run.code, sep=" ")) +
  theme(legend.position = "none", #"bottom"
        text=element_text(size=12),
        axis.line.y = element_line(),
        axis.text.y = element_text(),
        axis.title.y = element_text(),
        axis.ticks.y = element_line())  

 p8

 #ggsave(paste0("./figures/aggnwXbin_bin",run.code,"_3x3.pdf"), 
#        width = 3, height = 3,
#       device = cairo_pdf,
#       plot=p) #device = cairo_pdf,

# ggsave(paste0("./figures/aggnwXbin_bin",run.code,".pdf"), 
#       device = cairo_pdf,
#       plot=p) 
#dev.off()


#}

 
 nw_before_removal <- ggarrange(p1, p5, p9,  
          nrow = 3, ncol = 1)
  nw_before_removal
 ggsave( "./figures/nw_before_removal.pdf",
        width = 3.5, height = 9,
        device = cairo_pdf)


nw_after_reintro <- ggarrange(p4, p8, p12, 
                               nrow = 3, ncol = 1)
nw_after_reintro
ggsave( "./figures/nw_after==reintro.pdf",
        width = 3.5, height = 9,
        device = cairo_pdf)
```

### network graph (19 birds)
Second, for 19 birds, where focals are removed; this affects the layout. 
bin19birds <- c(2,3,6,7,10,11) 

```{r aggression network 19 birds (removal period)}

# combine dom_ec and rank to edge  dataframe
attrib_edge <- dyad.totalaggXbin %>%
  dplyr::select(-X) %>%
  #filter(bin %in% bintrial2_nofocal) %>%   # change 
  filter(bin %in% c(2,3,6,7,10,11) ) %>%
  #slice(rep(seq_len(n()), n.aggXbin)) %>%  # transform to edge list
  #mutate(weight = 1) %>%
  dplyr::rename(id=actor, weight=n.aggXbin) %>% 
  left_join(ec_rank, by=c("id", "bin")) %>% 
  dplyr::rename(actor=id, actor_power=power, actor_domec=dom_ec, actor_rank=rank) %>%
  dplyr::rename(id=subject) %>%
  left_join(ec_rank, by=c("id", "bin")) %>%
  dplyr::rename(subject=id, subject_power=power, subject_domec=dom_ec, subject_rank=rank) %>%
  mutate(rule = if_else(actor_rank < subject_rank, "follower", "breaker"),# low dom_ec/rank = higher ranking
         color= if_else(rule=="breaker", "#f03b20","#2c7fb8")) %>% #"#dc8580", "#83b2d0" -> too dull
  arrange(-actor_power) 
glimpse(attrib_edge)

  
loopby<-sort(unique(attrib_edge$bin))

for(i in seq_along(sort(unique(attrib_edge$bin)))){
  run.code <- 11
  print(run.code)
  
# SUBSET data by bin
 bin.data <- attrib_edge %>% 
   filter( bin==run.code) %>% #run.code
   arrange(-actor_power) 

  ## create graph from dataframe
 gdf <- graph.data.frame(bin.data)
 
  # create layout
 ## add rank 
 power_plot <- ec_rank %>% 
  filter(bin==run.code) %>%
  left_join(attrib_node) %>%
  dplyr::select(id, sex, power, rank) %>%
  arrange(-power) # changed to descending order rank instead of alphabethical order
 
 range(ec_rank$power)
 #range_ec_GPG <- range(ec_rank$dom_ec)

 
  treelayout <- layout_as_tree(gdf)  #V1=x, V2=y
  treelayout

  # change per bin
  ## change y axis to represent highest ranking on top of the netwwork
  ec_lay <- cbind(treelayout, power_plot$power) # observed ec rank 
  ec_lay<-ec_lay[,-2] # delete column 2

  ## change x axis to provide jitter of nodes
  #jitter<- c(0,-4,-5,1,2,3,0.5,3.5,-1.5,-3,-4,5,1.5,-2,2.5,5,-3.5,-1,-2.5,4.5,4)
  #jitter1<- c(0,2,0.5,3,5,4,2,3,4,-4,-1,-3,-4,-5,0,-3,-2,1,-2) # diamond shape
  jitter19<- c(0,2,0.5,-3,-2,4,2.5,-4,3.5,-1,4.5,3,-4,-5,0,-3,5,1,-2.5)
  ec_lay <- cbind(jitter19, ec_lay)
  ec_lay<-ec_lay[,-2] # delete column 2
  #colnames(ec_lay) <- c("V1", "V2")

  
## set edge color
E(gdf)$rule <- as.character(bin.data$rule)
# unique(bin.data$color)
#E(gdf)$rule <- adjustcolor(as.character(bin.data$color),alpha=.6)

## add vertex/node attribute
V(gdf)$name <- power_plot$id
V(gdf)$dom <- power_plot$power # now we have to reverse y-axis
V(gdf)$sex <- power_plot$sex

## set node color  
# all green during removal period focals
V(gdf)$fill <- c(alpha("#b8d79c", 1)) # all birds green

# highlight focal; "#1f78b4" for BBB; "#33a02c" for GPG; "#ff7f00" for OPP
#V(gdf)$fill<- c( alpha("#b8d79c", 1), "#1f78b4")[1+(V(gdf)$name=="BBB")]
#V(gdf)$fill<- c(alpha("#b8d79c", 1), "#6a51a3")[1+(V(gdf)$name=="GPG")]  # "#6a51a3" -> PURPLE & "#33a02c" -> DARK GREEN
#V(gdf)$fill<- c( alpha("#b8d79c", 1), "#ff7f00")[1+(V(gdf)$name=="OPP")] # "#ff7f00" -> orange & 


 # plot graph
 #library(ggraph); class(gdf); gdf

set.seed(42)

# layout
layout <- create_layout(gdf, layout=ec_lay)
head(layout)


# plot

p11 <-
  ggraph(gdf, layout = ec_lay) +
  
  # --- edges
  # geom_edge_link0(aes(edge_width = weight), edge_colour = E(gdf)$color) + # edges going in multiple directions are overlapped
  geom_edge_fan(aes(edge_width = weight, 
                    colour=rule,
                    alpha = 0.6 # ..index..
                    ), 
                strength = 0.05) + # 0.05; curved edges. strength > 1 will create wider fans while the reverse will make them more narrow. If there are no parallel edges it behaves like geom_edge_link() and draws a straight line, but if parallel edges exists it will spread them out as arcs with different curvature.
  #scale_edge_alpha('Edge direction', guide = 'edge_direction') + # have to include ..index..instead of alpha 0.6 to create gradient
  scale_y_continuous(limits = c(0.82, 1.0), breaks = c(0.85,0.90, 0.95, 1.00) ) +
  scale_edge_width_continuous(range = c(0.2,3)) + 
  scale_edge_colour_manual(values = c("#f03b20", "#2c7fb8")) +
  
  # --- nodes
  geom_node_point(aes( shape= sex,
                       fill = as.factor(layout$fill),
                       color = "white", size=10)) + 
  # highlight focal; "#1f78b4" for BBB; green("#33a02c") or purple (alpha("#7030A0", 0.6) for GPG; "#ff7f00" for OPP
  scale_fill_manual(name = "fill",
                     values=  c( alpha("#b8d79c", 1))) + #c(  "#1f78b4", alpha("#b8d79c", 1)) / alpha("#b8d79c", 1)) /  "#6a51a3" GPG
  scale_color_manual(values="white") +
  scale_shape_manual( name = "sex", 
                      values = c( 21, 23 ), #c( 21, 23 )  19, 17 
                      labels = c( "female", "male" )) +
  #geom_node_text(aes(label = layout$name), size=3) + #, , size=2 # bird names
  
  # --- layout
  #scale_size_continuous(range = c(1,6))+
  theme_graph()+ 
  labs(y="Power score" ) +
  ggtitle(paste("bin",run.code, sep=" ")) +
  theme(legend.position = "none", #"bottom"
        text=element_text(size=12),
        axis.line.y = element_line(),
        axis.text.y = element_text(),
        axis.title.y = element_text(),
        axis.ticks.y = element_line())  

 p11

 ggsave(paste0("./figures/aggnwXbin_bin",run.code,"_3.5x3.pdf"), 
        width = 3.5, height = 3,
       device = cairo_pdf,
       plot=p) #device = cairo_pdf,

 ggsave(paste0("./figures/aggnwXbin_bin",run.code,".pdf"), 
       device = cairo_pdf,
       plot=p) 
#dev.off()


}



```



## Network summary

```{r network summaries}
# make empty data frame to put data in
summ_network <- data.frame(run.code=character(),
                      density=numeric(),
                      total_agg =numeric(),
                      rulebreakers=numeric(),
                      rulefollowers=numeric())

  loopby<-sort(unique(attrib_edge$bin))
#i=1
  run.code <- loopby[i]
  print(run.code)
  
 # total aggressive events
 total_agg <- sum(attrib_edge$weight)

 # percent rule breakers and followers of total dyads
 rulebreakers <- length(attrib_edge$rule[attrib_edge$rule=="breaker"])/length(attrib_edge$actor) *100
 rulefollowers <- length(attrib_edge$rule[attrib_edge$rule=="follower"])/length(attrib_edge$actor) *100
 
 ## create graph from dataframe
 gdf <- graph.data.frame(attrib_edge)

  density <-   edge_density(gdf)

  # combine in dataframe
  pool <- cbind.data.frame(run.code, 
                         density,
                         total_agg,
                         rulebreakers,
                         rulefollowers)

  summ_network <-rbind(summ_network, pool )
 
  #summ_network1 <- summ_network
  #summ_network2 <- summ_network
  #summ_network3 <- summ_network
  #summ_network4 <- summ_network
  #summ_network5 <- summ_network
  #summ_network6 <- summ_network
  #summ_network7 <- summ_network
  #summ_network8 <- summ_network
  #summ_network9 <- summ_network
  #summ_network10 <- summ_network
  #summ_network11 <- summ_network
  #summ_network12 <- summ_network

# combine network summaries
summ_network <- bind_rows(summ_network1,
                          summ_network2,
                          summ_network3,
                          summ_network4,
                          summ_network5,
                          summ_network6,
                          summ_network7,
                          summ_network8,
                          summ_network9,
                          summ_network10,
                          summ_network11,
                          summ_network12)
summ_network <- summ_network %>%
  drop_na()

write.csv(summ_network, "output/network_summaries.csv")

```

```{r}
summ_network <- read.csv("output/network_summaries.csv") %>%
  dplyr::select(-X) %>%
  rename(period=run.code)

glimpse(summ_network)
write.csv(summ_network, "output/network_summaries_table.csv")

#summarize rules
mean(summ_network$rulefollowers)
sd(summ_network$rulefollowers)

mean(summ_network$rulebreakers)
sd(summ_network$rulebreakers)
```




## Mantel correlations
for aggression matrices:
  - before vs after removal
  - before vs after reintroduction

before vs after removal
BBB: bin c(1,2)
GPG: bin c(5,6)
OPP: bin c(9,10)

before reintroduction vs upon reintroduction 
BBB: bin  c(3,4) 
GPG: bin  c(7,8)
OPP: bin  c(11,12)

```{r correlation}

# CHANGE EACH TIME
observedXdyad <- dyad.totalaggXbin %>%
  filter(bin %in% c(11,12)) %>%
  pivot_wider(c(actor, subject), 
              names_from = bin, names_prefix = "bin",
              values_from = n.aggXbin,
              values_fill = 0) %>%
  dplyr::rename(before=bin11, after=bin12) # change each time
  
head(observedXdyad)
str(observedXdyad)

# check 
unique(observedXdyad$actor)
unique(observedXdyad$subject)


## correlation matrix  
# merge data with full dyad list in case any didn't interact
observedXdyad.alldyads <- merge(observedXdyad, dyad.list, 
                           by=c("actor", "subject"), 
                           all.y=TRUE)
head(observedXdyad.alldyads)
str(observedXdyad.alldyads) 

# convert NA to 0's
observedXdyad.alldyads[is.na(observedXdyad.alldyads)] <- 0

#check
head(observedXdyad.alldyads)
length(observedXdyad.alldyads$dyadID) # with 20 birds, we should have 380 dyads total

# before matrix
  obs.behavior1.mx <- reshape2::dcast(observedXdyad.alldyads, actor~subject, value.var="before") #head(ref.behavior1.mx)
  obs.behavior1.mx[is.na(obs.behavior1.mx)] <- 0
  obs.behavior1.mx <- matrix.please(obs.behavior1.mx)
  
  # after matrix
  obs.behavior2.mx <- reshape2::dcast(observedXdyad.alldyads, actor~subject, value.var="after") #head(ref.behavior2.mx)
  obs.behavior2.mx[is.na(obs.behavior2.mx)] <- 0
  obs.behavior2.mx <- matrix.please(obs.behavior2.mx)
  
  # Mantel test
  #mantel.test(obs.behavior1.mx, obs.behavior2.mx) # ape package
  obs.cor.result <- mantel(obs.behavior1.mx, obs.behavior2.mx, method = "spearman") # vegan package
  obs.cor.matrix <- obs.cor.result$statistic
obs.cor.result$statistic
obs.cor.result$signif
```

before vs after removal
BBB: bin c(1,2) -> mantel = 0.69, p = 0.001
GPG: bin c(5,6) -> mantel = 0.65, p = 0.001
OPP: bin c(9,10) -> mantel = 0.66, p = 0.001

before reintroduction vs upon reintroduction 
BBB: bin  c(3,4) -> mantel = 0.66, p = 0.001
GPG: bin  c(7,8) -> mantel = 0.51, p = 0.001
OPP: bin  c(11,12) -> mantel = 0.71, p = 0.001


# Supplemental information

## Proportion changes by run across 4 possible pattern changes
### removal by run
```{r removal by run}

## before removal vs after removal ----
# observed pattern change from bullying to downward heuristic (trial 1, bin 11->12), downward heuristic to downward heuristic for trial  3  (bin 19->20), from bullying to bullying for trial 2 (bin 15 ->bin16) 

# per run
rand_removalXrun <- before_after %>%
  filter(bin %in% c(1,5,9)) %>%
  group_by(runID, random_pattern_change) %>%
  summarise(n_trials=length(random_pattern_change)) %>%  # 3 trials
  rename(change=random_pattern_change) #%>%
  #dplyr::select(-random_n) %>%
  #mutate(prop=round(random_prop, 2)) %>%
  #dplyr::select(-random_prop)

pattern_changes <- sort(unique(before_after$obs_pattern_change))
pattern_changes <- as.data.frame(pattern_changes)
pattern_changes <- pattern_changes %>%
  rename(change = "pattern_changes") 

# include all possible patterns

# make empty data frame to put data in
rand_removalXrun_all <- data.frame(runID=character(),
                      change=character(), 
                      random_n=numeric(),
                      prop=numeric())

loopby <- unique(rand_removalXrun$runID)

for(i in seq_along(loopby)){
  run.code <- loopby[i]
  #print(run.code)
  run.data <- subset(rand_removalXrun, runID==run.code)
  
  data_allpatterns <- merge(pattern_changes, run.data, all.x=TRUE,
                       by=c("change")) 

  data_allpatterns$runID<-run.code
  
 #fill newly-merged data with 0's where no patterns
 data_allpatterns[is.na(data_allpatterns)] <- 0
 
 # check
 sum(data_allpatterns$random_n) # should total 3 trials
  
   # combine in dataframe
  rand_removalXrun_all<-rbind(rand_removalXrun_all, data_allpatterns)
}

glimpse(rand_removalXrun_all)

# calculate proportion 
rand_removalXrun_all<- rand_removalXrun_all %>%
  mutate(random_prop = n_trials/length(pattern_changes$change))

glimpse(rand_removalXrun_all)


# summarize
summ_rand_removal <- rand_removalXrun_all %>%
  group_by(change, random_prop) %>%
  summarise(total=length(runID), 
            p.value=total/1000)

# How many runs do we see same pattern as observed? 
obs.vs.rand_removal <- before_after %>%
  filter(bin %in% c(1,5,9)) %>%
  group_by(runID) %>%
  mutate(similar_pattern= if_else(obs_pattern_change==random_pattern_change,"yes", "no")) %>%
  group_by(runID,similar_pattern) %>%
  summarize(n=length(similar_pattern))
  
summ_obs.vs.rand_removal  <- obs.vs.rand_removal %>%
  filter(similar_pattern=="yes", n==3) 
total_runs_same_removal <- length(summ_obs.vs.rand_removal$runID)/length(unique(before_after$runID))*100

```
2.9% of the runs showed the same pattern changes for all three trials as the observed pattern changes

#### Fig SI removal
Calculate distribution of pattern changes and confidence intervals per run. So we get 1000 proportion values. 

If observed pattern change falls outside reference model values, a change from downward heuristic to bullying is different from random. 

trial 1: bullying - downward heuristic  -> 0.25
trial 2: bullying - bullying            -> 0.25
trial 3: downward heuristic - downward heuristic -> 0.25
of 4 potential pattern changes

```{r}

glimpse(rand_removalXrun_all)
glimpse(summ_rand_removal)

rand_removalXrun_all <- rand_removalXrun_all %>%
  mutate(pattern_change = factor(change, levels=c("DH-DH", "DH-B", "B-DH", "B-B"),
                                 labels = c("downward heuristic - downward heuristic",
                                            "downward heuristic - bullying",
                                            "bullying - downward heuristic",
                                            "bullying - bullying")))
#summ_rand_removalXrun_all <- rand_removalXrun_all %>%
#  group_by(change, random_prop) %>%
#  summarize(n=length(runID),
#            prop=n/1000)


 plot_removal_dist <-  ggplot(rand_removalXrun_all, aes(x = random_prop, y = change, fill = change)) +
  geom_density_ridges( stat="binline",bins=10, scale=0.8, draw_baseline = F, center = 0) + #alpha=0.6, binwidth=1
  theme_ridges(#font_size = 12,
    #font_family = "",
   line_size = 0.01,
   # grid = FALSE,
    center_axis_labels = FALSE) + #grid=FALSE
  theme(
      legend.position="bottom",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8),
      axis.title.x = element_text(hjust = 0.5)
      #axis.title.y = element_text(hjust = 0.5)
    ) +
    xlab("proportion of runs") +
    ylab("") +
    scale_fill_manual(values = c("#0000FF", "#b3b0e3", "#deebf7", "#7F7F7F")) + #"#C00000" ,
   scale_x_continuous( expand = c(0, 0),limits = c(-0.1,1),
                       breaks = c(0.00, 0.25, 0.50, 0.75, 1.00)) +
   scale_y_discrete(expand = expansion(mult = c(0.0, .3))) +
   
  # include observed proportion
  geom_segment(y=2, yend=2.8, x = 0.25, xend=0.25, size=1,  color="red") + # trial 1
  geom_segment(y=1, yend=1.8, x = 0.25, xend=0.25, size=1,  color="red") + # trial 2 #linetype = "dashed",
  geom_segment(y=4, yend=5, x = 0.25, xend=0.25, size=1,  color="red") +  # trial 3
  
  geom_segment(y=1, yend=5, x = 1, xend=1, size=1,  color="white") +
   coord_cartesian(clip = "off") 
plot_removal_dist 


ggsave("figures/fig.2b_dist_removal_random.pdf", width = 2.5, height = 3)


total_rand_removal <- summ_rand_removal %>%
  group_by(change) %>%
  summarize(sum=sum(total))

plot_removal_bar <- ggplot(summ_rand_removal, aes(x=change, y=p.value, fill=as.factor(random_prop))) +
  geom_bar(stat = "identity" , position="dodge") +
  coord_flip() +
  ylab("proportion of runs") +
  xlab("") +
  scale_fill_viridis(discrete=TRUE, name="") +
  theme_classic()
plot_removal_bar

```





### reintroduction by run
```{r reintroduction by run}

# per run
rand_reintroXrun <- before_after %>%
  filter(bin %in% c(3,7,11)) %>%
  group_by(runID, random_pattern_change) %>%
  summarise(n_trials=length(random_pattern_change)) %>%  # 3 trials
  rename(change=random_pattern_change) #%>%
  #dplyr::select(-random_n) %>%
  #mutate(prop=round(random_prop, 2)) %>%
  #dplyr::select(-random_prop)

pattern_changes <- sort(unique(before_after$obs_pattern_change))
pattern_changes <- as.data.frame(pattern_changes)
pattern_changes <- pattern_changes %>%
  rename(change = "pattern_changes") 

# include all possible patterns

# make empty data frame to put data in
rand_reintroXrun_all <- data.frame(runID=character(),
                      change=character(), 
                      random_n=numeric(),
                      prop=numeric())

loopby <- unique(rand_reintroXrun$runID)

for(i in seq_along(loopby)){
  run.code <- loopby[i]
  #print(run.code)
  run.data <- subset(rand_reintroXrun, runID==run.code)
  
  data_allpatterns <- merge(pattern_changes, run.data, all.x=TRUE,
                       by=c("change")) 

  data_allpatterns$runID<-run.code
  
 #fill newly-merged data with 0's where no patterns
 data_allpatterns[is.na(data_allpatterns)] <- 0
 
 # check
 sum(data_allpatterns$random_n) # should total 3 trials
  
   # combine in dataframe
  rand_reintroXrun_all<-rbind(rand_reintroXrun_all, data_allpatterns)
}

glimpse(rand_reintroXrun_all)

# calculate proportion 
rand_reintroXrun_all<- rand_reintroXrun_all %>%
  mutate(random_prop = n_trials/length(pattern_changes$change))


# summarize
summ_rand_reintro <- rand_reintroXrun_all %>%
  group_by(change, random_prop) %>%
  summarise(total=length(runID), 
            p.value=total/1000)


# How many runs do we see same pattern as observed? 
obs.vs.rand_reintro <- before_after %>%
  filter(bin %in% c(3,7,11)) %>%
  group_by(runID) %>%
  mutate(similar_pattern= if_else(obs_pattern_change==random_pattern_change,"yes", "no")) %>%
  group_by(runID,similar_pattern) %>%
  summarize(n=length(similar_pattern))
  
summ_obs.vs.rand_reintro <- obs.vs.rand_reintro %>%
  filter(similar_pattern=="yes", n==3) 
total_runs_same_reintro <- length(summ_obs.vs.rand_reintro$runID)/length(unique(before_after$runID))*100

total_runs_same_reintro 
```
2.6% of the runs showed the same pattern changes for all three trials as the observed pattern changes


#### Fig SI reintro
Calculate distribution of pattern changes and confidence intervals per run. So we get 1000 proportion values. 

If observed pattern change falls outside reference model values, a change from downward heuristic to bullying is different from random. 

observed pattern changes:
3x downward heuristic - bullying -> 0.75
of 4 potential pattern changes

dh -b 0.75

```{r}
glimpse(rand_reintroXrun_all)



rand_reintroXrun_all <- rand_reintroXrun_all %>%
  mutate(pattern_change = factor(change, levels=c("DH-DH", "DH-B", "B-DH", "B-B"),
                                 labels = c("downward heuristic - downward heuristic",
                                            "downward heuristic - bullying",
                                            "bullying - downward heuristic",
                                            "bullying - bullying")))

plot_reintro_dist <- ggplot(rand_reintroXrun_all, aes(x = random_prop, y = change, fill = change)) +
  #stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.025, 0.975), alpha = 0.7) 
  #geom_density_ridges2() 
  # geom_density_ridges(
  #  jittered_points = TRUE, quantile_lines = TRUE, scale = 0.9, alpha = 0.7,
  #  vline_size = 1, vline_color = "red",
  #  point_size = 0.4, point_alpha = 1,
  #  position = position_raincloud(adjust_vlines = TRUE)
  #)
  #stat_density_ridges(quantile_lines = TRUE, quantiles = c(0.025, 0.975), alpha = 0.7) +
  geom_density_ridges( stat="binline", bins=10, scale=0.8, draw_baseline = F) + #alpha=0.6,
   theme_ridges(#font_size = 12,
    #font_family = "",
   line_size = 0.01,
   # grid = FALSE,
    center_axis_labels = FALSE) + #grid=FALSE
  theme(
      legend.position="bottom",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8),
      axis.title.x = element_text(hjust = 0.5)
      #axis.title.y = element_text(hjust = 0.5)
    ) +
    xlab("proportion of runs") +
    ylab("") +
    scale_fill_manual(values = c("#0000FF", "#b3b0e3", "#deebf7", "#7F7F7F")) + #"#C00000" ,
   scale_x_continuous( expand = c(0, 0),limits = c(-0.1,1),
                       breaks = c(0.00, 0.25, 0.50, 0.75, 1.00)) +
   scale_y_discrete(expand = expansion(mult = c(0.0, .3))) +
    xlab("proportion of runs") +
    ylab("") +
   
  
   # include observed proportion
  geom_segment(y=3, yend=3.8, x = 0.75, xend=0.75, size=1,  color="red")  # trial 1, 2, 3

plot_reintro_dist
ggsave("figures/fig.2d_dist_reintro_random.pdf", width = 2.5, height = 3)

```


## combine plots

```{r combine plots }

# combine plots
  ggarrange(plot_aggression_control, plot_strategies_summ, 
            nrow=2, ncol=1, align = "hv",
            labels = c("(a)", "(b)")
            ) # legend = "bottom", label.x = 0.15, label.y=0.85

  ggsave("./figures/plot_Fig1.pdf", 
         width= 7, height=7, units="in") # full page  width= 7, height=11, units="in") # half page width= 125, height=250, units="mm"
```




